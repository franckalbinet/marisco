<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>HELCOM – marisco</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-cd333c7267348b54b15a9ec2a617d176.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="HELCOM – marisco">
<meta property="og:description" content="MARIS companion package and tutorials">
<meta property="og:site_name" content="marisco">
<meta name="twitter:title" content="HELCOM – marisco">
<meta name="twitter:description" content="MARIS companion package and tutorials">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">marisco</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/franckalbinet/marisco"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../handlers/helcom.html">Handlers</a></li><li class="breadcrumb-item"><a href="../handlers/helcom.html">HELCOM</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MARISCO</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Handlers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/helcom.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">HELCOM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/ospar.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">OSPAR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/geotraces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geotraces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/maris_legacy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MARIS Legacy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/tepco.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TEPCO</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">API</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/configs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/metadata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metadata</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/encoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Encoders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/decoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decoders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/netcdf2csv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NetCDF2CSV</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Metadata</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../metadata/data-curation-rules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data curation rules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../metadata/field-definition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Field definitions</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#configuration-file-paths" id="toc-configuration-file-paths" class="nav-link active" data-scroll-target="#configuration-file-paths">Configuration &amp; file paths</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a>
  <ul>
  <li><a href="#read_csv" id="toc-read_csv" class="nav-link" data-scroll-target="#read_csv">read_csv</a></li>
  <li><a href="#load_data" id="toc-load_data" class="nav-link" data-scroll-target="#load_data">load_data</a></li>
  </ul></li>
  <li><a href="#normalize-nuclide-names" id="toc-normalize-nuclide-names" class="nav-link" data-scroll-target="#normalize-nuclide-names">Normalize nuclide names</a>
  <ul>
  <li><a href="#lower-strip-nuclide-names" id="toc-lower-strip-nuclide-names" class="nav-link" data-scroll-target="#lower-strip-nuclide-names">Lower &amp; strip nuclide names</a></li>
  <li><a href="#remap-nuclide-names-to-maris-data-formats" id="toc-remap-nuclide-names-to-maris-data-formats" class="nav-link" data-scroll-target="#remap-nuclide-names-to-maris-data-formats">Remap nuclide names to MARIS data formats</a></li>
  <li><a href="#remapnuclidenamecb" id="toc-remapnuclidenamecb" class="nav-link" data-scroll-target="#remapnuclidenamecb">RemapNuclideNameCB</a></li>
  </ul></li>
  <li><a href="#standardize-time" id="toc-standardize-time" class="nav-link" data-scroll-target="#standardize-time">Standardize Time</a>
  <ul>
  <li><a href="#parsetimecb" id="toc-parsetimecb" class="nav-link" data-scroll-target="#parsetimecb">ParseTimeCB</a></li>
  </ul></li>
  <li><a href="#split-sediment-values" id="toc-split-sediment-values" class="nav-link" data-scroll-target="#split-sediment-values">Split Sediment Values</a>
  <ul>
  <li><a href="#splitsedimentvaluescb" id="toc-splitsedimentvaluescb" class="nav-link" data-scroll-target="#splitsedimentvaluescb">SplitSedimentValuesCB</a></li>
  </ul></li>
  <li><a href="#sanitize-value" id="toc-sanitize-value" class="nav-link" data-scroll-target="#sanitize-value">Sanitize value</a>
  <ul>
  <li><a href="#sanitizevaluecb" id="toc-sanitizevaluecb" class="nav-link" data-scroll-target="#sanitizevaluecb">SanitizeValueCB</a></li>
  </ul></li>
  <li><a href="#normalize-uncertainty" id="toc-normalize-uncertainty" class="nav-link" data-scroll-target="#normalize-uncertainty">Normalize uncertainty</a>
  <ul>
  <li><a href="#unc_rel2stan" id="toc-unc_rel2stan" class="nav-link" data-scroll-target="#unc_rel2stan">unc_rel2stan</a></li>
  <li><a href="#normalizeunccb" id="toc-normalizeunccb" class="nav-link" data-scroll-target="#normalizeunccb">NormalizeUncCB</a></li>
  </ul></li>
  <li><a href="#remap-units" id="toc-remap-units" class="nav-link" data-scroll-target="#remap-units">Remap units</a>
  <ul>
  <li><a href="#remapunitcb" id="toc-remapunitcb" class="nav-link" data-scroll-target="#remapunitcb">RemapUnitCB</a></li>
  </ul></li>
  <li><a href="#remap-detection-limit" id="toc-remap-detection-limit" class="nav-link" data-scroll-target="#remap-detection-limit">Remap detection limit</a>
  <ul>
  <li><a href="#remapdetectionlimitcb" id="toc-remapdetectionlimitcb" class="nav-link" data-scroll-target="#remapdetectionlimitcb">RemapDetectionLimitCB</a></li>
  </ul></li>
  <li><a href="#remap-biota-species" id="toc-remap-biota-species" class="nav-link" data-scroll-target="#remap-biota-species">Remap Biota species</a></li>
  <li><a href="#remap-body-part" id="toc-remap-body-part" class="nav-link" data-scroll-target="#remap-body-part">Remap Body Part</a></li>
  <li><a href="#remap-biological-group" id="toc-remap-biological-group" class="nav-link" data-scroll-target="#remap-biological-group">Remap Biological Group</a></li>
  <li><a href="#remap-sediment-types" id="toc-remap-sediment-types" class="nav-link" data-scroll-target="#remap-sediment-types">Remap Sediment Types</a>
  <ul>
  <li><a href="#remapsedimentcb" id="toc-remapsedimentcb" class="nav-link" data-scroll-target="#remapsedimentcb">RemapSedimentCB</a></li>
  </ul></li>
  <li><a href="#remap-filtering-status" id="toc-remap-filtering-status" class="nav-link" data-scroll-target="#remap-filtering-status">Remap Filtering Status</a>
  <ul>
  <li><a href="#remapfiltcb" id="toc-remapfiltcb" class="nav-link" data-scroll-target="#remapfiltcb">RemapFiltCB</a></li>
  </ul></li>
  <li><a href="#add-sample-id" id="toc-add-sample-id" class="nav-link" data-scroll-target="#add-sample-id">Add Sample ID</a>
  <ul>
  <li><a href="#addsampleidcb" id="toc-addsampleidcb" class="nav-link" data-scroll-target="#addsampleidcb">AddSampleIDCB</a></li>
  </ul></li>
  <li><a href="#add-depths" id="toc-add-depths" class="nav-link" data-scroll-target="#add-depths">Add depths</a>
  <ul>
  <li><a href="#adddepthcb" id="toc-adddepthcb" class="nav-link" data-scroll-target="#adddepthcb">AddDepthCB</a></li>
  </ul></li>
  <li><a href="#add-salinity" id="toc-add-salinity" class="nav-link" data-scroll-target="#add-salinity">Add Salinity</a>
  <ul>
  <li><a href="#addsalinitycb" id="toc-addsalinitycb" class="nav-link" data-scroll-target="#addsalinitycb">AddSalinityCB</a></li>
  </ul></li>
  <li><a href="#add-station" id="toc-add-station" class="nav-link" data-scroll-target="#add-station">Add Station</a>
  <ul>
  <li><a href="#addstationcb" id="toc-addstationcb" class="nav-link" data-scroll-target="#addstationcb">AddStationCB</a></li>
  </ul></li>
  <li><a href="#add-temperature" id="toc-add-temperature" class="nav-link" data-scroll-target="#add-temperature">Add Temperature</a>
  <ul>
  <li><a href="#addtemperaturecb" id="toc-addtemperaturecb" class="nav-link" data-scroll-target="#addtemperaturecb">AddTemperatureCB</a></li>
  </ul></li>
  <li><a href="#add-slice-position-top-and-bottom" id="toc-add-slice-position-top-and-bottom" class="nav-link" data-scroll-target="#add-slice-position-top-and-bottom">Add slice position (TOP and BOTTOM)</a>
  <ul>
  <li><a href="#remapsedslicetopbottomcb" id="toc-remapsedslicetopbottomcb" class="nav-link" data-scroll-target="#remapsedslicetopbottomcb">RemapSedSliceTopBottomCB</a></li>
  </ul></li>
  <li><a href="#add-dry-weight-wet-weight-and-percentage-weight" id="toc-add-dry-weight-wet-weight-and-percentage-weight" class="nav-link" data-scroll-target="#add-dry-weight-wet-weight-and-percentage-weight">Add dry weight, wet weight and percentage weight</a>
  <ul>
  <li><a href="#lookupdrywetpercentweightcb" id="toc-lookupdrywetpercentweightcb" class="nav-link" data-scroll-target="#lookupdrywetpercentweightcb">LookupDryWetPercentWeightCB</a></li>
  </ul></li>
  <li><a href="#standardize-coordinates" id="toc-standardize-coordinates" class="nav-link" data-scroll-target="#standardize-coordinates">Standardize Coordinates</a>
  <ul>
  <li><a href="#parsecoordinates" id="toc-parsecoordinates" class="nav-link" data-scroll-target="#parsecoordinates">ParseCoordinates</a></li>
  </ul></li>
  <li><a href="#review-all-callbacks" id="toc-review-all-callbacks" class="nav-link" data-scroll-target="#review-all-callbacks">Review all callbacks</a>
  <ul>
  <li><a href="#example-change-logs" id="toc-example-change-logs" class="nav-link" data-scroll-target="#example-change-logs">Example change logs</a></li>
  </ul></li>
  <li><a href="#feed-global-attributes" id="toc-feed-global-attributes" class="nav-link" data-scroll-target="#feed-global-attributes">Feed global attributes</a>
  <ul>
  <li><a href="#get_attrs" id="toc-get_attrs" class="nav-link" data-scroll-target="#get_attrs">get_attrs</a></li>
  </ul></li>
  <li><a href="#encoding-netcdf" id="toc-encoding-netcdf" class="nav-link" data-scroll-target="#encoding-netcdf"></a><a name="encoding-netcdf" class="nav-link" data-scroll-target="undefined"></a>Encoding NetCDF
  <ul>
  <li><a href="#encode" id="toc-encode" class="nav-link" data-scroll-target="#encode">encode</a></li>
  </ul></li>
  <li><a href="#netcdf-review" id="toc-netcdf-review" class="nav-link" data-scroll-target="#netcdf-review">NetCDF Review</a></li>
  <li><a href="#data-format-conversion" id="toc-data-format-conversion" class="nav-link" data-scroll-target="#data-format-conversion">Data Format Conversion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/franckalbinet/marisco/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../handlers/helcom.html">Handlers</a></li><li class="breadcrumb-item"><a href="../handlers/helcom.html">HELCOM</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">HELCOM</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<blockquote class="blockquote">
<p>This data pipeline, known as a “handler” in Marisco terminology, is designed to clean, standardize, and encode <a href="https://helcom.fi/about-us">HELCOM data</a> into <code>NetCDF</code> format. The handler processes raw HELCOM data, applying various transformations and lookups to align it with <code>MARIS</code> data standards.</p>
</blockquote>
<p>Key functions of this handler:</p>
<ul>
<li><strong>Cleans</strong> and <strong>normalizes</strong> raw HELCOM data</li>
<li><strong>Applies standardized nomenclature</strong> and units</li>
<li><strong>Encodes the processed data</strong> into <code>NetCDF</code> format compatible with MARIS requirements</li>
</ul>
<p>This handler is a crucial component in the Marisco data processing workflow, ensuring HELCOM data is properly integrated into the MARIS database.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Getting Started
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>For new MARIS users, please refer to <a href="https://github.com/franckalbinet/marisco/blob/main/nbs/metadata/field-definition.ipynb">Understanding MARIS Data Formats (NetCDF and Open Refine)</a> for detailed information.</li>
<li>For new HELCOM users, please refer to the <a href="https://metadata.helcom.fi/geonetwork/srv/fin/catalog.search#/metadata/2fdd2d46-0329-40e3-bf96-cb08c7206a24">HELCOM Metadata Portal</a> for detailed information regarding the <code>GUIDELINES FOR MONITORING OF RADIOACTIVE SUBSTANCES</code>.</li>
</ul>
</div>
</div>
<p>The present notebook pretends to be an instance of <a href="https://www.wikiwand.com/en/articles/Literate_programming">Literate Programming</a> in the sense that it is a narrative that includes code snippets that are interspersed with explanations. When a function or a class needs to be exported in a dedicated python module (in our case <code>marisco/handlers/helcom.py</code>) the code snippet is added to the module using <code>#| exports</code> as provided by the wonderful <a href="https://nbdev.readthedocs.io/en/latest/">nbdev</a> library.</p>
<section id="configuration-file-paths" class="level2">
<h2 class="anchored" data-anchor-id="configuration-file-paths">Configuration &amp; file paths</h2>
<ul>
<li><p><strong>src_dir</strong>: path to the <a href="https://github.com/franckalbinet/maris-crawlers">maris-crawlers</a> folder containing the HELCOM data in CSV format.</p></li>
<li><p><strong>fname_out</strong>: path and filename for the NetCDF output.The path can be defined as a relative path.</p></li>
<li><p><strong>Zotero key</strong>: used to retrieve attributes related to the dataset from <a href="https://www.zotero.org/">Zotero</a>. The MARIS datasets include a <a href="https://maris.iaea.org/datasets">library</a> available on <a href="https://www.zotero.org/groups/2432820/maris/library">Zotero</a>.</p></li>
</ul>
<div id="715e849d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>src_dir <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/franckalbinet/maris-crawlers/refs/heads/main/data/processed/HELCOM%20MORS'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>fname_out <span class="op">=</span> <span class="st">'../../_data/output/100-HELCOM-MORS-2024.nc'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>zotero_key <span class="op">=</span><span class="st">'26VMZZ2Q'</span> <span class="co"># HELCOM MORS zotero key</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<p><a href="https://helcom.fi/about-us">Helcom MORS (Monitoring of Radioactive Substances in the Baltic Sea) data</a> is provided as a zipped Microsoft Access database. We automatically fetch and convert this dataset with database tables exported as <code>.csv</code> files using a Github action here: <a href="https://github.com/franckalbinet/maris-crawlers/blob/main/.github/workflows/fetch-data-sources.yml">maris-crawlers</a>.</p>
<p>The dataset is then accessible in an amenable format for the <code>marisco</code> data pipeline.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L82" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="read_csv" class="level3">
<h3 class="anchored" data-anchor-id="read_csv">read_csv</h3>
<blockquote class="blockquote">
<pre><code> read_csv (file_name,
           dir='https://raw.githubusercontent.com/franckalbinet/maris-
           crawlers/refs/heads/main/data/processed/HELCOM%20MORS')</code></pre>
</blockquote>
<div id="e3f4c788" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>default_smp_types <span class="op">=</span> {  </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BIO'</span>: <span class="st">'BIOTA'</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SEA'</span>: <span class="st">'SEAWATER'</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SED'</span>: <span class="st">'SEDIMENT'</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="b840f3f3" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_csv(file_name, <span class="bu">dir</span><span class="op">=</span>src_dir):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(file_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L87" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="load_data" class="level3">
<h3 class="anchored" data-anchor-id="load_data">load_data</h3>
<blockquote class="blockquote">
<pre><code> load_data (src_url:str, smp_types:dict={'BIO': 'BIOTA', 'SEA':
            'SEAWATER', 'SED': 'SEDIMENT'}, use_cache:bool=False,
            save_to_cache:bool=False, verbose:bool=False)</code></pre>
</blockquote>
<p><em>Load HELCOM data and return the data in a dictionary of dataframes with the dictionary key as the sample type.</em></p>
<div id="93f0655f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(src_url: <span class="bu">str</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>              smp_types: <span class="bu">dict</span> <span class="op">=</span> default_smp_types, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>              use_cache: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>              save_to_cache: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, pd.DataFrame]:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Load HELCOM data and return the data in a dictionary of dataframes with the dictionary key as the sample type."</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_and_merge(file_prefix: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_cache:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dir</span><span class="op">=</span>cache_path()</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dir</span> <span class="op">=</span> src_url</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        file_smp_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">01.csv'</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        file_meas_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">02.csv'</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_cache:</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> Path(file_smp_path).exists():</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>file_smp_path<span class="sc">}</span><span class="ss"> not found.'</span>)            </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> Path(file_meas_path).exists():</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>file_meas_path<span class="sc">}</span><span class="ss"> not found.'</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            start_time <span class="op">=</span> time.time()</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        df_meas <span class="op">=</span> read_csv(<span class="ss">f'</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">02.csv'</span>, <span class="bu">dir</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        df_smp <span class="op">=</span> read_csv(<span class="ss">f'</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">01.csv'</span>, <span class="bu">dir</span>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        df_meas.columns <span class="op">=</span> df_meas.columns.<span class="bu">str</span>.lower()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        df_smp.columns <span class="op">=</span> df_smp.columns.<span class="bu">str</span>.lower()</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        merged_df <span class="op">=</span> pd.merge(df_meas, df_smp, on<span class="op">=</span><span class="st">'key'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Downloaded data for </span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">01.csv and </span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">02.csv in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start_time<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> save_to_cache:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">dir</span> <span class="op">=</span> cache_path()</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            df_smp.to_csv(<span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">01.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            df_meas.to_csv(<span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">02.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose:</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Saved downloaded data to cache at </span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">01.csv and </span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss">02.csv"</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> merged_df</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {smp_type: load_and_merge(file_prefix) <span class="cf">for</span> file_prefix, smp_type <span class="kw">in</span> smp_types.items()}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><code>dfs</code> is a dictionary of dataframes created from the Helcom dataset located at the path <code>src_dir</code>. The data to be included in each dataframe is sorted by sample type. Each dictionary is defined with a key equal to the sample type.</p>
<div id="bb4bf289" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, verbose<span class="op">=</span><span class="va">True</span>, save_to_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'keys/sample types: '</span>, dfs.keys())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded data for BIO01.csv and BIO02.csv in 0.30 seconds.
Saved downloaded data to cache at /Users/franckalbinet/.marisco/cache/BIO01.csv and /Users/franckalbinet/.marisco/cache/BIO02.csv
Downloaded data for SEA01.csv and SEA02.csv in 0.32 seconds.
Saved downloaded data to cache at /Users/franckalbinet/.marisco/cache/SEA01.csv and /Users/franckalbinet/.marisco/cache/SEA02.csv
Downloaded data for SED01.csv and SED02.csv in 0.55 seconds.
Saved downloaded data to cache at /Users/franckalbinet/.marisco/cache/SED01.csv and /Users/franckalbinet/.marisco/cache/SED02.csv
keys/sample types:  dict_keys(['BIOTA', 'SEAWATER', 'SEDIMENT'])</code></pre>
</div>
</div>
<p>Lets take a look at each DataFrame:</p>
<div id="2efb957b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> dfs.keys():</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    display(Markdown(<span class="ss">f"&lt;b&gt; </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> DataFrame:&lt;/b&gt;"</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        display(dfs[key].head(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> BIOTA DataFrame:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/kg</th>
<th data-quarto-table-cell-role="th">value_bq/kg</th>
<th data-quarto-table-cell-role="th">basis</th>
<th data-quarto-table-cell-role="th">error%</th>
<th data-quarto-table-cell-role="th">number</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude ddmmmm</th>
<th data-quarto-table-cell-role="th">latitude dddddd</th>
<th data-quarto-table-cell-role="th">longitude ddmmmm</th>
<th data-quarto-table-cell-role="th">longitude dddddd</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">rubin</th>
<th data-quarto-table-cell-role="th">biotatype</th>
<th data-quarto-table-cell-role="th">tissue</th>
<th data-quarto-table-cell-role="th">no</th>
<th data-quarto-table-cell-role="th">length</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">dw%</th>
<th data-quarto-table-cell-role="th">loi%</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>BVTIG2012041</td>
<td>CS134</td>
<td>VTIG01</td>
<td>&lt;</td>
<td>0.01014</td>
<td>W</td>
<td>NaN</td>
<td>NaN</td>
<td>02/27/14 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012041</td>
<td>09/23/12 00:00:00</td>
<td>2012</td>
<td>9.0</td>
<td>23.0</td>
<td>SD24</td>
<td>54.17</td>
<td>54.283333</td>
<td>12.19</td>
<td>12.316667</td>
<td>NaN</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>16.0</td>
<td>45.7</td>
<td>948.0</td>
<td>18.453</td>
<td>92.9</td>
<td>2.0</td>
<td>16</td>
<td>02/27/14 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>BVTIG2012041</td>
<td>K40</td>
<td>VTIG01</td>
<td></td>
<td>135.30000</td>
<td>W</td>
<td>3.57</td>
<td>NaN</td>
<td>02/27/14 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012041</td>
<td>09/23/12 00:00:00</td>
<td>2012</td>
<td>9.0</td>
<td>23.0</td>
<td>SD24</td>
<td>54.17</td>
<td>54.283333</td>
<td>12.19</td>
<td>12.316667</td>
<td>NaN</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>16.0</td>
<td>45.7</td>
<td>948.0</td>
<td>18.453</td>
<td>92.9</td>
<td>2.0</td>
<td>16</td>
<td>02/27/14 00:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> SEAWATER DataFrame:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">latitude (dddddd)</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WKRIL2012003</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>5.3</td>
<td>32.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012003.0</td>
<td>05/23/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>23.0</td>
<td>RU10</td>
<td>60.05</td>
<td>60.0833</td>
<td>29.2</td>
<td>29.3333</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WKRIL2012004</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>19.9</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012004.0</td>
<td>05/23/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>23.0</td>
<td>RU10</td>
<td>60.05</td>
<td>60.0833</td>
<td>29.2</td>
<td>29.3333</td>
<td>NaN</td>
<td>29.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> SEDIMENT DataFrame:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/kg</th>
<th data-quarto-table-cell-role="th">value_bq/kg</th>
<th data-quarto-table-cell-role="th">error%_kg</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m²</th>
<th data-quarto-table-cell-role="th">value_bq/m²</th>
<th data-quarto-table-cell-role="th">error%_m²</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">latitude (dddddd)</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">device</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">uppsli</th>
<th data-quarto-table-cell-role="th">lowsli</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">sedi</th>
<th data-quarto-table-cell-role="th">oxic</th>
<th data-quarto-table-cell-role="th">dw%</th>
<th data-quarto-table-cell-role="th">loi%</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">sum_link</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SKRIL2012116</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>1200.0</td>
<td>20.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012116.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>15.0</td>
<td>20.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>SKRIL2012117</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>250.0</td>
<td>20.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012117.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>20.0</td>
<td>25.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="normalize-nuclide-names" class="level2">
<h2 class="anchored" data-anchor-id="normalize-nuclide-names">Normalize nuclide names</h2>
<section id="lower-strip-nuclide-names" class="level3">
<h3 class="anchored" data-anchor-id="lower-strip-nuclide-names">Lower &amp; strip nuclide names</h3>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some nuclide names contain one or multiple trailing spaces.</p>
</div>
</div>
<p>This is demonstrated below for the <code>NUCLIDE</code> column:</p>
<div id="9a2306ba" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> get_unique_across_dfs(load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>), <span class="st">'nuclide'</span>, as_df<span class="op">=</span><span class="va">True</span>, include_nchars<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'stripped_chars'</span>] <span class="op">=</span> df[<span class="st">'value'</span>].<span class="bu">str</span>.strip().<span class="bu">str</span>.replace(<span class="st">' '</span>, <span class="st">''</span>).<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df[df[<span class="st">'n_chars'</span>] <span class="op">!=</span> df[<span class="st">'stripped_chars'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    index      value  n_chars  stripped_chars
5       5    SR90           7               4
6       6     SR90          6               4
14     14   CS134           8               5
16     16   SR90            8               4
22     22     CS137         6               5
36     36      SR90         5               4
38     38   PU238           8               5
49     49   K40             8               3
61     61  CS137            9               5
78     78   CS137           8               5
80     80    TC99           7               4
85     85   AM241           8               5
86     86   CO60            8               4</code></pre>
</div>
</div>
<p>To fix this issue, we use the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#lowerstripnamecb"><code>LowerStripNameCB</code></a> callback. For each dataframe in the dictionary of dataframes, it corrects the nuclide name by converting it lowercase, striping any leading or trailing whitespace(s).</p>
<div id="8a3fa068" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>)])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> Nuclides: '</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'NUCLIDE'</span>].unique())</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.logs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIOTA Nuclides: 
['cs134' 'k40' 'co60' 'cs137' 'sr90' 'ag108m' 'mn54' 'co58' 'ag110m'
 'zn65' 'sb125' 'pu239240' 'ru106' 'be7' 'ce144' 'pb210' 'po210' 'sb124'
 'sr89' 'zr95' 'te129m' 'ru103' 'nb95' 'ce141' 'la140' 'i131' 'ba140'
 'pu238' 'u235' 'bi214' 'pb214' 'pb212' 'tl208' 'ac228' 'ra223' 'eu155'
 'ra226' 'gd153' 'sn113' 'fe59' 'tc99' 'co57' 'sn117m' 'eu152' 'sc46'
 'rb86' 'ra224' 'th232' 'cs134137' 'am241' 'ra228' 'th228' 'k-40' 'cs138'
 'cs139' 'cs140' 'cs141' 'cs142' 'cs143' 'cs144' 'cs145' 'cs146']
SEAWATER Nuclides: 
['cs137' 'sr90' 'h3' 'cs134' 'pu238' 'pu239240' 'am241' 'cm242' 'cm244'
 'tc99' 'k40' 'ru103' 'sr89' 'sb125' 'nb95' 'ru106' 'zr95' 'ag110m'
 'cm243244' 'ba140' 'ce144' 'u234' 'u238' 'co60' 'pu239' 'pb210' 'po210'
 'np237' 'pu240' 'mn54']
SEDIMENT Nuclides: 
['cs137' 'ra226' 'ra228' 'k40' 'sr90' 'cs134137' 'cs134' 'pu239240'
 'pu238' 'co60' 'ru103' 'ru106' 'sb125' 'ag110m' 'ce144' 'am241' 'be7'
 'th228' 'pb210' 'co58' 'mn54' 'zr95' 'ba140' 'po210' 'ra224' 'nb95'
 'pu238240' 'pu241' 'pu239' 'eu155' 'ir192' 'th232' 'cd109' 'sb124' 'zn65'
 'th234' 'tl208' 'pb212' 'pb214' 'bi214' 'ac228' 'ra223' 'u235' 'bi212']
["Convert 'nuclide' column values to lowercase, strip spaces, and store in 'NUCLIDE' column."]</code></pre>
</div>
</div>
</section>
<section id="remap-nuclide-names-to-maris-data-formats" class="level3">
<h3 class="anchored" data-anchor-id="remap-nuclide-names-to-maris-data-formats">Remap nuclide names to MARIS data formats</h3>
<p>Below, we map nuclide names used by HELCOM to the MARIS standard nuclide names.</p>
<p>Remapping data provider nomenclatures to MARIS standards is a recurrent operation and is done in a semi-automated manner according to the following pattern:</p>
<ol type="1">
<li><strong>Inspect</strong> data provider nomenclature:</li>
<li><strong>Match</strong> automatically against MARIS nomenclature (using a fuzzy matching algorithm);</li>
<li><strong>Fix</strong> potential mismatches;</li>
<li><strong>Apply</strong> the lookup table to the dataframe.</li>
</ol>
<p>We will refer to this process as <strong>IMFA</strong> (<strong>I</strong>nspect, <strong>M</strong>atch, <strong>F</strong>ix, <strong>A</strong>pply).</p>
<p>The <a href="https://franckalbinet.github.io/marisco/api/utils.html#get_unique_across_dfs"><code>get_unique_across_dfs</code></a> function is a utility in MARISCO that retrieves unique values from a specified column across all DataFrames. Note that there is one DataFrame for each sample type, such as biota, sediment, etc.</p>
<div id="e32ee8d0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>)])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>dfs_output <span class="op">=</span> tfm()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Transpose to display the dataframe horizontally</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>get_unique_across_dfs(dfs_output, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>, as_df<span class="op">=</span><span class="va">True</span>).T</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">67</th>
<th data-quarto-table-cell-role="th">68</th>
<th data-quarto-table-cell-role="th">69</th>
<th data-quarto-table-cell-role="th">70</th>
<th data-quarto-table-cell-role="th">71</th>
<th data-quarto-table-cell-role="th">72</th>
<th data-quarto-table-cell-role="th">73</th>
<th data-quarto-table-cell-role="th">74</th>
<th data-quarto-table-cell-role="th">75</th>
<th data-quarto-table-cell-role="th">76</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">index</th>
<td>0</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>...</td>
<td>67</td>
<td>68</td>
<td>69</td>
<td>70</td>
<td>71</td>
<td>72</td>
<td>73</td>
<td>74</td>
<td>75</td>
<td>76</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">value</th>
<td>ag108m</td>
<td>bi214</td>
<td>pb214</td>
<td>ra226</td>
<td>ce144</td>
<td>co57</td>
<td>cs137</td>
<td>u238</td>
<td>tl208</td>
<td>k-40</td>
<td>...</td>
<td>th234</td>
<td>cs146</td>
<td>po210</td>
<td>th228</td>
<td>eu152</td>
<td>sc46</td>
<td>pu238240</td>
<td>cs134137</td>
<td>th232</td>
<td>pu239240</td>
</tr>
</tbody>
</table>

<p>2 rows × 77 columns</p>
</div>
</div>
</div>
<p>Let’s now create an instance of a <a href="https://www.wikiwand.com/en/articles/Approximate_string_matching">fuzzy matching algorithm</a> <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>. This instance will match the nuclide names of the HELCOM dataset to the MARIS standard nuclide names.</p>
<div id="bcdbc619" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs_output, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>nuc_lut_path,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'nuclide_id'</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'nc_name'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'nuclides_helcom.pkl'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lets try to match HELCOM nuclide names to MARIS standard nuclide names as automatically as possible. The <code>match_score</code> column allows to assess the results:</p>
<div id="cb645c29" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 77/77 [00:01&lt;00:00, 54.80it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>63 entries matched the criteria, while 14 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">cm243244</th>
<td>cm242</td>
<td>cm243244</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">pu238240</th>
<td>pu240</td>
<td>pu238240</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs134137</th>
<td>cs137</td>
<td>cs134137</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">pu239240</th>
<td>pu239</td>
<td>pu239240</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs145</th>
<td>ce140</td>
<td>cs145</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cs142</th>
<td>ce140</td>
<td>cs142</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs143</th>
<td>ce140</td>
<td>cs143</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">k-40</th>
<td>k40</td>
<td>k-40</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs140</th>
<td>ce140</td>
<td>cs140</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cs139</th>
<td>ce139</td>
<td>cs139</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs138</th>
<td>cs134</td>
<td>cs138</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cs141</th>
<td>ce141</td>
<td>cs141</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs144</th>
<td>cs134</td>
<td>cs144</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cs146</th>
<td>cs136</td>
<td>cs146</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can now manually inspect the unmatched nuclide names and create a table to correct them to the MARIS standard:</p>
<div id="60cf885b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fixes_nuclide_names <span class="op">=</span> {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs134137'</span>: <span class="st">'cs134_137_tot'</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cm243244'</span>: <span class="st">'cm243_244_tot'</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pu239240'</span>: <span class="st">'pu239_240_tot'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'pu238240'</span>: <span class="st">'pu238_240_tot'</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs143'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs145'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs142'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs141'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs144'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'k-40'</span>: <span class="st">'k40'</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs140'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs146'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs139'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs138'</span>: <span class="st">'cs137'</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We now include the table <code>fixes_nuclide_names</code>, which applies manual corrections to the nuclide names before the remapping process. The <code>generate_lookup_table</code> function has an <code>overwrite</code> parameter (default is <code>True</code>), which, when set to <code>True</code>, creates a pickle file cache of the lookup table. We can now test the remapping process:</p>
<div id="73410b14" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>, fixes<span class="op">=</span>fixes_nuclide_names)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fc.test_eq(<span class="bu">len</span>(remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)), <span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 77/77 [00:01&lt;00:00, 55.80it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>77 entries matched the criteria, while 0 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>Test passes! We can now create a callback <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapnuclidenamecb"><code>RemapNuclideNameCB</code></a> to remap the nuclide names. Note that we pass <code>overwrite=False</code> to the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> constructor to now use the cached version.</p>
<div id="9a189ef9" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lookup table for nuclide names</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>lut_nuclides <span class="op">=</span> <span class="kw">lambda</span> df: Remapper(provider_lut_df<span class="op">=</span>df,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                                   maris_lut_fn<span class="op">=</span>nuc_lut_path,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>                                   maris_col_id<span class="op">=</span><span class="st">'nuclide_id'</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                   maris_col_name<span class="op">=</span><span class="st">'nc_name'</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                                   provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>                                   provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                                   fname_cache<span class="op">=</span><span class="st">'nuclides_helcom.pkl'</span>).generate_lookup_table(fixes<span class="op">=</span>fixes_nuclide_names, </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                                                                                            as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The callback <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapnuclidenamecb"><code>RemapNuclideNameCB</code></a> is now created to remap the nuclide names using the <code>lut_nuclides</code> lookup table.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L164" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="remapnuclidenamecb" class="level3">
<h3 class="anchored" data-anchor-id="remapnuclidenamecb">RemapNuclideNameCB</h3>
<blockquote class="blockquote">
<pre><code> RemapNuclideNameCB (fn_lut:Callable, col_name:str)</code></pre>
</blockquote>
<p><em>Remap data provider nuclide names to standardized MARIS nuclide names.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fn_lut</td>
<td>Callable</td>
<td>Function that returns the lookup table dictionary</td>
</tr>
<tr class="even">
<td>col_name</td>
<td>str</td>
<td>Column name to remap</td>
</tr>
</tbody>
</table>
<div id="03d47237" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapNuclideNameCB(Callback):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Remap data provider nuclide names to standardized MARIS nuclide names."</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                 fn_lut: Callable, <span class="co"># Function that returns the lookup table dictionary</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                 col_name: <span class="bu">str</span> <span class="co"># Column name to remap</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        df_uniques <span class="op">=</span> get_unique_across_dfs(tfm.dfs, col_name<span class="op">=</span><span class="va">self</span>.col_name, as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">#lut = {k: v.matched_maris_name for k, v in self.fn_lut(df_uniques).items()}    </span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        lut <span class="op">=</span> {k: v.matched_id <span class="cf">for</span> k, v <span class="kw">in</span> <span class="va">self</span>.fn_lut(df_uniques).items()}    </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> tfm.dfs.keys():</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>            tfm.dfs[k][<span class="st">'NUCLIDE'</span>] <span class="op">=</span> tfm.dfs[k][<span class="va">self</span>.col_name].replace(lut)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s see it in action, along with the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#lowerstripnamecb"><code>LowerStripNameCB</code></a> callback:</p>
<div id="4c9a9ff7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>dfs_out <span class="op">=</span> tfm()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># For instance</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> dfs_out.keys():</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> NUCLIDE unique: '</span>, dfs_out[key][<span class="st">'NUCLIDE'</span>].unique())</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIOTA NUCLIDE unique:  [31  4  9 33 12 21  6  8 22 10 24 77 17  2 37 41 47 23 11 13 25 16 14 36
 35 29 34 67 63 46 43 42 94 55 50 40 53 87 92 86 15  7 93 85 91 90 51 59
 76 72 54 57]
SEAWATER NUCLIDE unique:  [33 12  1 31 67 77 72 73 75 15  4 16 11 24 14 17 13 22 80 34 37 62 64  9
 68 41 47 65 69  6]
SEDIMENT NUCLIDE unique:  [ 33  53  54   4  12  76  31  77  67   9  16  17  24  22  37  72   2  57
  41   8   6  13  34  47  51  14  89  70  68  40  88  59  84  23  10  60
  94  42  43  46  55  50  63 130]
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21634     40744
Rows removed from original (tfm.dfs_removed)       0         0         0
Rows created in transformed (tfm.dfs_created)      0         0         0 
</code></pre>
</div>
</div>
</section>
</section>
<section id="standardize-time" class="level2">
<h2 class="anchored" data-anchor-id="standardize-time">Standardize Time</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Time/date is provide in the <code>DATE</code>, <code>YEAR</code> , <code>MONTH</code>, <code>DAY</code> columns. Note that the <code>DATE</code> contains missing values as indicated below. When missing, we fallback on the <code>YEAR</code>, <code>MONTH</code>, <code>DAY</code> columns. Note that sometimes <code>DAY</code> and <code>MONTH</code> contain 0. In this case we systematically set them to 1.</p>
</div>
</div>
<div id="612873e6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> dfs.keys():</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> DATE null values: '</span>, dfs[key][<span class="st">'date'</span>].isna().<span class="bu">sum</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIOTA DATE null values:  88
SEAWATER DATE null values:  554
SEDIMENT DATE null values:  830</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L246" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="parsetimecb" class="level3">
<h3 class="anchored" data-anchor-id="parsetimecb">ParseTimeCB</h3>
<blockquote class="blockquote">
<pre><code> ParseTimeCB ()</code></pre>
</blockquote>
<p><em>Standardize time format across all dataframes.</em></p>
<div id="ae547a0c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParseTimeCB(Callback):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Standardize time format across all dataframes."</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._process_dates(df)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _process_dates(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Process and correct date and time information in the DataFrame."</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'TIME'</span>] <span class="op">=</span> <span class="va">self</span>._parse_date(df)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._handle_missing_dates(df)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._fill_missing_time(df)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _parse_date(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Parse the DATE column if present."</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.to_datetime(df[<span class="st">'date'</span>], <span class="bu">format</span><span class="op">=</span><span class="st">'%m/</span><span class="sc">%d</span><span class="st">/%y %H:%M:%S'</span>, errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _handle_missing_dates(<span class="va">self</span>, df: pd.DataFrame):</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Handle cases where DAY or MONTH is 0 or missing."</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">"day"</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">"day"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">"month"</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">"month"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        missing_day_month <span class="op">=</span> (df[<span class="st">"day"</span>].isna()) <span class="op">&amp;</span> (df[<span class="st">"month"</span>].isna()) <span class="op">&amp;</span> (df[<span class="st">"year"</span>].notna())</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        df.loc[missing_day_month, [<span class="st">"day"</span>, <span class="st">"month"</span>]] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _fill_missing_time(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Fill missing time values using year, month, and day columns."</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        missing_time <span class="op">=</span> df[<span class="st">'TIME'</span>].isna()</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        df.loc[missing_time, <span class="st">'TIME'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>            df.loc[missing_time, [<span class="st">'year'</span>, <span class="st">'month'</span>, <span class="st">'day'</span>]], </span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>            <span class="bu">format</span><span class="op">=</span><span class="st">'%Y%m</span><span class="sc">%d</span><span class="st">'</span>, </span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>            errors<span class="op">=</span><span class="st">'coerce'</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Apply the transformer for callbacks <a href="https://franckalbinet.github.io/marisco/handlers/geotraces.html#parsetimecb"><code>ParseTimeCB</code></a>. Then, print the <code>TIME</code> data for <code>seawater</code>. Passing the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#comparedfsandtfmcb"><code>CompareDfsAndTfmCB</code></a> callback allows us to compare the original dataframes with the transformed dataframes using the <code>compare_stats</code> attribute.</p>
<div id="f2b90d07" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[ParseTimeCB(),</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'TIME'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21634     40744
Rows removed from original (tfm.dfs_removed)       0         0         0
Rows created in transformed (tfm.dfs_created)      0         0         0 

            TIME
0     2012-05-23
1     2012-05-23
2     2012-06-17
3     2012-05-24
4     2012-05-24
...          ...
21629 2023-06-11
21630 2023-06-11
21631 2023-06-13
21632 2023-06-13
21633 2023-06-13

[21634 rows x 1 columns]</code></pre>
</div>
</div>
<p>The NetCDF time format requires that time be encoded as the number of milliseconds since a specified origin. In our case, the origin is <code>1970-01-01</code>, as indicated in the <code>cdl.toml</code> file under the <code>[vars.defaults.time.attrs]</code> section.</p>
<p><a href="https://franckalbinet.github.io/marisco/api/callbacks.html#encodetimecb"><code>EncodeTimeCB</code></a> converts the HELCOM <code>time</code> format to the MARIS NetCDF <code>time</code> format.</p>
<div id="4b8edc56" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[ParseTimeCB(),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co">#print(tfm.logs)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: 8 missing time value(s) in SEAWATER
Warning: 1 missing time value(s) in SEDIMENT
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21626     40743
Rows removed from original (tfm.dfs_removed)       0         8         1
Rows created in transformed (tfm.dfs_created)      0         0         0 
</code></pre>
</div>
</div>
</section>
</section>
<section id="split-sediment-values" class="level2">
<h2 class="anchored" data-anchor-id="split-sediment-values">Split Sediment Values</h2>
<p>Helcom reports two values for the SEDIMENT sample type: <code>VALUE_Bq/kg</code> and <code>VALUE_Bq/m³</code>. We need to split this and use a single column <code>VALUE</code> for the MARIS standard. We will use the <code>UNIT</code> column to identify the reported values.</p>
<p>Lets take a look at the unit lookup table for MARIS:</p>
<div id="d14bbf2b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>pd.read_excel(unit_lut_path())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unit_id</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">unit_sanitized</th>
<th data-quarto-table-cell-role="th">ordlist</th>
<th data-quarto-table-cell-role="th">Unnamed: 4</th>
<th data-quarto-table-cell-role="th">Unnamed: 5</th>
<th data-quarto-table-cell-role="th">Unnamed: 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-1</td>
<td>Not applicable</td>
<td>Not applicable</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>NOT AVAILABLE</td>
<td>NOT AVAILABLE</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>Bq/m3</td>
<td>Bq per m3</td>
<td>1.0</td>
<td>Bq/m3</td>
<td>NaN</td>
<td>Bq/m&lt;sup&gt;3&lt;/sup&gt;</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2</td>
<td>Bq/m2</td>
<td>Bq per m2</td>
<td>2.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>3</td>
<td>Bq/kg</td>
<td>Bq per kg</td>
<td>3.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>4</td>
<td>Bq/kgd</td>
<td>Bq per kgd</td>
<td>4.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>5</td>
<td>Bq/kgw</td>
<td>Bq per kgw</td>
<td>5.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>6</td>
<td>kg/kg</td>
<td>kg per kg</td>
<td>6.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>7</td>
<td>TU</td>
<td>TU</td>
<td>7.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>8</td>
<td>DELTA/mill</td>
<td>DELTA per mill</td>
<td>8.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>9</td>
<td>atom/kg</td>
<td>atom per kg</td>
<td>9.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>10</td>
<td>atom/kgd</td>
<td>atom per kgd</td>
<td>10.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>11</td>
<td>atom/kgw</td>
<td>atom per kgw</td>
<td>11.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>12</td>
<td>atom/l</td>
<td>atom per l</td>
<td>12.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>13</td>
<td>Bq/kgC</td>
<td>Bq per kgC</td>
<td>13.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We will define the columns of interest for the SEDIMENT measurement types:</p>
<div id="5df02329" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>coi_sediment <span class="op">=</span> {</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'kg_type'</span>: {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VALUE'</span>: <span class="st">'value_bq/kg'</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'UNC'</span>: <span class="st">'error%_kg'</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DL'</span>: <span class="st">'&lt; value_bq/kg'</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'UNIT'</span>: <span class="dv">3</span>,  <span class="co"># Unit ID for Bq/kg</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'m2_type'</span>: {</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'VALUE'</span>: <span class="st">'value_bq/m²'</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'UNC'</span>: <span class="st">'error%_m²'</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'DL'</span>: <span class="st">'&lt; value_bq/m²'</span>,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'UNIT'</span>: <span class="dv">2</span>,  <span class="co"># Unit ID for Bq/m²</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We define the <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#splitsedimentvaluescb"><code>SplitSedimentValuesCB</code></a> callback to split the sediment entries into separate rows for <code>Bq/kg</code> and <code>Bq/m²</code>. We use underscore to denote the columns are temporary columns created during the splitting process.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L230" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="splitsedimentvaluescb" class="level3">
<h3 class="anchored" data-anchor-id="splitsedimentvaluescb">SplitSedimentValuesCB</h3>
<blockquote class="blockquote">
<pre><code> SplitSedimentValuesCB (coi:Dict[str,Dict[str,Any]])</code></pre>
</blockquote>
<p><em>Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>coi</td>
<td>Dict</td>
<td>Columns of interest with value, uncertainty, DL columns and units</td>
</tr>
</tbody>
</table>
<div id="13fb2292" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SplitSedimentValuesCB(Callback):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements."</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                 coi: Dict[<span class="bu">str</span>, Dict[<span class="bu">str</span>, Any]] <span class="co"># Columns of interest with value, uncertainty, DL columns and units</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'SEDIMENT'</span> <span class="kw">not</span> <span class="kw">in</span> tfm.dfs:</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> tfm.dfs[<span class="st">'SEDIMENT'</span>]</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        dfs_to_concat <span class="op">=</span> []</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each measurement type (kg and m2)</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> measure_type, cols <span class="kw">in</span> <span class="va">self</span>.coi.items():</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If any of value/uncertainty/DL exists, keep the row</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>            has_data <span class="op">=</span> (</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>                df[cols[<span class="st">'VALUE'</span>]].notna() <span class="op">|</span> </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>                df[cols[<span class="st">'UNC'</span>]].notna() <span class="op">|</span> </span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>                df[cols[<span class="st">'DL'</span>]].notna()</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> has_data.<span class="bu">any</span>():</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>                df_measure <span class="op">=</span> df[has_data].copy()</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Copy columns to standardized names</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>                df_measure[<span class="st">'_VALUE'</span>] <span class="op">=</span> df_measure[cols[<span class="st">'VALUE'</span>]]</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>                df_measure[<span class="st">'_UNC'</span>] <span class="op">=</span> df_measure[cols[<span class="st">'UNC'</span>]]</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>                df_measure[<span class="st">'_DL'</span>] <span class="op">=</span> df_measure[cols[<span class="st">'DL'</span>]]</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>                df_measure[<span class="st">'_UNIT'</span>] <span class="op">=</span> cols[<span class="st">'UNIT'</span>]</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>                dfs_to_concat.append(df_measure)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine all measurement type dataframes</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dfs_to_concat:</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>            tfm.dfs[<span class="st">'SEDIMENT'</span>] <span class="op">=</span> pd.concat(dfs_to_concat, ignore_index<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c53ee701" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEDIMENT'</span>].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21634     70697
Rows removed from original (tfm.dfs_removed)       0         0         0
Rows created in transformed (tfm.dfs_created)      0         0     29953 
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/kg</th>
<th data-quarto-table-cell-role="th">value_bq/kg</th>
<th data-quarto-table-cell-role="th">error%_kg</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m²</th>
<th data-quarto-table-cell-role="th">value_bq/m²</th>
<th data-quarto-table-cell-role="th">error%_m²</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">latitude (dddddd)</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">device</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">uppsli</th>
<th data-quarto-table-cell-role="th">lowsli</th>
<th data-quarto-table-cell-role="th">area</th>
<th data-quarto-table-cell-role="th">sedi</th>
<th data-quarto-table-cell-role="th">oxic</th>
<th data-quarto-table-cell-role="th">dw%</th>
<th data-quarto-table-cell-role="th">loi%</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">sum_link</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
<th data-quarto-table-cell-role="th">_VALUE</th>
<th data-quarto-table-cell-role="th">_UNC</th>
<th data-quarto-table-cell-role="th">_DL</th>
<th data-quarto-table-cell-role="th">_UNIT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SKRIL2012116</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>1200.0</td>
<td>20.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012116.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>15.0</td>
<td>20.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>1200.0</td>
<td>20.0</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>SKRIL2012117</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>250.0</td>
<td>20.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012117.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>20.0</td>
<td>25.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>250.0</td>
<td>20.0</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>SKRIL2012118</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>140.0</td>
<td>21.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012118.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>25.0</td>
<td>30.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>140.0</td>
<td>21.0</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>SKRIL2012119</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>79.0</td>
<td>20.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012119.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>30.0</td>
<td>35.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>79.0</td>
<td>20.0</td>
<td>NaN</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>SKRIL2012120</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>29.0</td>
<td>24.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012120.0</td>
<td>05/25/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>25.0</td>
<td>RU99</td>
<td>60.28</td>
<td>60,4667</td>
<td>27.48</td>
<td>27.8</td>
<td>KRIL01</td>
<td>25.0</td>
<td>35.0</td>
<td>40.0</td>
<td>0.006</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>NaN</td>
<td>08/20/14 00:00:00</td>
<td>29.0</td>
<td>24.0</td>
<td>NaN</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="sanitize-value" class="level2">
<h2 class="anchored" data-anchor-id="sanitize-value">Sanitize value</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some of the HELCOM datasets contain missing values in the <code>VALUE</code> column, see output after applying the <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#sanitizevaluecb"><code>SanitizeValueCB</code></a> callback.</p>
</div>
</div>
<p>We allocate each column containing measurement values (named differently across sample types) into a single column <code>VALUE</code> and remove <code>NA</code> where needed.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L274" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="sanitizevaluecb" class="level3">
<h3 class="anchored" data-anchor-id="sanitizevaluecb">SanitizeValueCB</h3>
<blockquote class="blockquote">
<pre><code> SanitizeValueCB (coi:Dict[str,Dict[str,str]], verbose:bool=False)</code></pre>
</blockquote>
<p><em>Sanitize measurement values by removing blanks and standardizing to use the <code>VALUE</code> column.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>coi</td>
<td>Dict</td>
<td></td>
<td>Columns of interest. Format: {group_name: {‘val’: ‘column_name’}}</td>
</tr>
<tr class="even">
<td>verbose</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
</tbody>
</table>
<div id="8580f592" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>coi_val <span class="op">=</span> {<span class="st">'SEAWATER'</span> : {<span class="st">'VALUE'</span>: <span class="st">'value_bq/m³'</span>},</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>           <span class="st">'BIOTA'</span>:  {<span class="st">'VALUE'</span>: <span class="st">'value_bq/kg'</span>},</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>           <span class="st">'SEDIMENT'</span>: {<span class="st">'VALUE'</span>: <span class="st">'_VALUE'</span>}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="15d74eed" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SanitizeValueCB(Callback):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Sanitize measurement values by removing blanks and standardizing to use the `VALUE` column."</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                 coi: Dict[<span class="bu">str</span>, Dict[<span class="bu">str</span>, <span class="bu">str</span>]], <span class="co"># Columns of interest. Format: {group_name: {'val': 'column_name'}}</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                 verbose: <span class="bu">bool</span><span class="op">=</span><span class="va">False</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>                 ): </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        tfm.dfs_dropped <span class="op">=</span> {}</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>            value_col <span class="op">=</span> <span class="va">self</span>.coi[grp][<span class="st">'VALUE'</span>]</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count NaN values before dropping</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>            initial_nan_count <span class="op">=</span> df[value_col].isna().<span class="bu">sum</span>()</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># define a dataframe with the rows that were dropped    </span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>            tfm.dfs_dropped[grp] <span class="op">=</span> df[df[value_col].isna()]</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>            df.dropna(subset<span class="op">=</span>[value_col], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count NaN values after dropping</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>            final_nan_count <span class="op">=</span> df[value_col].isna().<span class="bu">sum</span>()</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>            dropped_nan_count <span class="op">=</span> initial_nan_count <span class="op">-</span> final_nan_count</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Print the number of dropped NaN values</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> dropped_nan_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="va">self</span>.verbose:</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Warning: </span><span class="sc">{</span>dropped_nan_count<span class="sc">}</span><span class="ss"> missing value(s) in </span><span class="sc">{</span>value_col<span class="sc">}</span><span class="ss"> for group </span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'VALUE'</span>] <span class="op">=</span> df[value_col]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bccb7a50" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val, verbose<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: 30 missing value(s) in value_bq/kg for group BIOTA.
Warning: 153 missing value(s) in value_bq/m³ for group SEAWATER.
Warning: 246 missing value(s) in _VALUE for group SEDIMENT.
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16094     21481     70451
Rows removed from original (tfm.dfs_removed)      30       153       144
Rows created in transformed (tfm.dfs_created)      0         0     29851 
</code></pre>
</div>
</div>
</section>
</section>
<section id="normalize-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="normalize-uncertainty">Normalize uncertainty</h2>
<p>Function <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#unc_rel2stan"><code>unc_rel2stan</code></a> converts uncertainty from relative uncertainty to standard uncertainty.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L306" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="unc_rel2stan" class="level3">
<h3 class="anchored" data-anchor-id="unc_rel2stan">unc_rel2stan</h3>
<blockquote class="blockquote">
<pre><code> unc_rel2stan (df:pandas.core.frame.DataFrame, meas_col:str, unc_col:str)</code></pre>
</blockquote>
<p><em>Convert relative uncertainty to absolute uncertainty.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>df</td>
<td>DataFrame</td>
<td>DataFrame containing measurement and uncertainty columns</td>
</tr>
<tr class="even">
<td>meas_col</td>
<td>str</td>
<td>Name of the column with measurement values</td>
</tr>
<tr class="odd">
<td>unc_col</td>
<td>str</td>
<td>Name of the column with relative uncertainty values (percentages)</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Series</strong></td>
<td><strong>Series with calculated absolute uncertainties</strong></td>
</tr>
</tbody>
</table>
<div id="76077d40" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unc_rel2stan(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    df: pd.DataFrame, <span class="co"># DataFrame containing measurement and uncertainty columns</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    meas_col: <span class="bu">str</span>, <span class="co"># Name of the column with measurement values</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    unc_col: <span class="bu">str</span> <span class="co"># Name of the column with relative uncertainty values (percentages)</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.Series: <span class="co"># Series with calculated absolute uncertainties</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert relative uncertainty to absolute uncertainty."</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df.<span class="bu">apply</span>(<span class="kw">lambda</span> row: row[unc_col] <span class="op">*</span> row[meas_col] <span class="op">/</span> <span class="dv">100</span>, axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For each sample type in the Helcom dataset, the <code>UNC</code> is provided as a relative uncertainty. The column names for both the <code>VALUE</code> and the <code>UNC</code> vary by sample type. The <code>coi_units_unc</code> dictionary defines the column names for the <code>VALUE</code> and <code>UNC</code> for each sample type.</p>
<div id="b231b09b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns of interest</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>coi_units_unc <span class="op">=</span> [(<span class="st">'SEAWATER'</span>, <span class="st">'value_bq/m³'</span>, <span class="st">'error%_m³'</span>),</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                 (<span class="st">'BIOTA'</span>, <span class="st">'value_bq/kg'</span>, <span class="st">'error%'</span>),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                 (<span class="st">'SEDIMENT'</span>, <span class="st">'_VALUE'</span>, <span class="st">'_UNC'</span>)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>NormalizeUncCB callback normalizes the <code>UNC</code> by converting from relative uncertainty to standard uncertainty.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L322" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="normalizeunccb" class="level3">
<h3 class="anchored" data-anchor-id="normalizeunccb">NormalizeUncCB</h3>
<blockquote class="blockquote">
<pre><code> NormalizeUncCB (fn_convert_unc:Callable=&lt;function unc_rel2stan&gt;,
                 coi:List[Tuple[str,str,str]]=[('SEAWATER', 'value_bq/m³',
                 'error%_m³'), ('BIOTA', 'value_bq/kg', 'error%'),
                 ('SEDIMENT', '_VALUE', '_UNC')])</code></pre>
</blockquote>
<p><em>Convert from relative error to standard uncertainty.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fn_convert_unc</td>
<td>Callable</td>
<td>unc_rel2stan</td>
<td>Function converting relative uncertainty to absolute uncertainty</td>
</tr>
<tr class="even">
<td>coi</td>
<td>List</td>
<td>[(‘SEAWATER’, ‘value_bq/m³’, ’error%_m³’), (‘BIOTA’, ‘value_bq/kg’, ‘error%’), (‘SEDIMENT’, ’_VALUE’, ’_UNC’)]</td>
<td>List of columns of interest</td>
</tr>
</tbody>
</table>
<div id="5cf262ed" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NormalizeUncCB(Callback):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert from relative error to standard uncertainty."</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                 fn_convert_unc: Callable<span class="op">=</span>unc_rel2stan, <span class="co"># Function converting relative uncertainty to absolute uncertainty</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                 coi: List[Tuple[<span class="bu">str</span>, <span class="bu">str</span>, <span class="bu">str</span>]]<span class="op">=</span>coi_units_unc <span class="co"># List of columns of interest</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, val, unc <span class="kw">in</span> <span class="va">self</span>.coi:</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grp <span class="kw">in</span> tfm.dfs:</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>                df <span class="op">=</span> tfm.dfs[grp]</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'UNC'</span>] <span class="op">=</span> <span class="va">self</span>.fn_convert_unc(df, val, unc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Apply the transformer for callback <code>[</code>NormalizeUncCB<code>](https://franckalbinet.github.io/marisco/handlers/helcom.html#normalizeunccb)</code>. Then, print the value (i.e.&nbsp;activity per unit ) and standard uncertainty for each sample type.</p>
<div id="fd9e14e2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'VALUE'</span>, <span class="st">'UNC'</span>]][:<span class="dv">2</span>])</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'BIOTA'</span>][[<span class="st">'VALUE'</span>, <span class="st">'UNC'</span>]][:<span class="dv">2</span>])</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'SEDIMENT'</span>][[<span class="st">'VALUE'</span>, <span class="st">'UNC'</span>]][:<span class="dv">2</span>])</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   VALUE    UNC
0    5.3  1.696
1   19.9  3.980
       VALUE      UNC
0    0.01014      NaN
1  135.30000  4.83021
    VALUE    UNC
0  1200.0  240.0
1   250.0   50.0
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16094     21481     70451
Rows removed from original (tfm.dfs_removed)      30       153       144
Rows created in transformed (tfm.dfs_created)      0         0     29851 
</code></pre>
</div>
</div>
</section>
</section>
<section id="remap-units" class="level2">
<h2 class="anchored" data-anchor-id="remap-units">Remap units</h2>
<p>HELCOM incorporates the unit directly into the column name. For the <code>SEDIMENT</code> sample type, the units are accounted for when Splitting the sediment values (i.e.&nbsp;<a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#splitsedimentvaluescb"><code>SplitSedimentValuesCB</code></a>). Let’s examine the units associated with the other sample types.</p>
<p>For the <code>BIOTA</code> sample type, the base unit is <code>Bq/kg</code>, as indicated in the <code>value_bq/kg</code> column. The distinction between wet (W) and dry weight (D) is specified in the basis column.</p>
<div id="bea27b2c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'BIOTA'</span>][[<span class="st">'value_bq/kg'</span>, <span class="st">'basis'</span>]].head(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">value_bq/kg</th>
<th data-quarto-table-cell-role="th">basis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.01014</td>
<td>W</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For the <code>SEAWATER</code> sample type, the unit is <code>Bq/m³</code> as indicated in the <code>value_bq/m³</code> column.</p>
<div id="cb0ed8cf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'value_bq/m³'</span>]].head(<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>5.3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can now review the units that are available in MARIS:</p>
<div id="3e594cf5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>pd.read_excel(unit_lut_path())[[<span class="st">'unit_id'</span>, <span class="st">'unit'</span>, <span class="st">'unit_sanitized'</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">unit_id</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">unit_sanitized</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-1</td>
<td>Not applicable</td>
<td>Not applicable</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>NOT AVAILABLE</td>
<td>NOT AVAILABLE</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>Bq/m3</td>
<td>Bq per m3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2</td>
<td>Bq/m2</td>
<td>Bq per m2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>3</td>
<td>Bq/kg</td>
<td>Bq per kg</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>4</td>
<td>Bq/kgd</td>
<td>Bq per kgd</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>5</td>
<td>Bq/kgw</td>
<td>Bq per kgw</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>6</td>
<td>kg/kg</td>
<td>kg per kg</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>7</td>
<td>TU</td>
<td>TU</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>8</td>
<td>DELTA/mill</td>
<td>DELTA per mill</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>9</td>
<td>atom/kg</td>
<td>atom per kg</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>10</td>
<td>atom/kgd</td>
<td>atom per kgd</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>11</td>
<td>atom/kgw</td>
<td>atom per kgw</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>12</td>
<td>atom/l</td>
<td>atom per l</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>13</td>
<td>Bq/kgC</td>
<td>Bq per kgC</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We define unit renaming rules for HELCOM in an <strong>ad hoc</strong> way:</p>
<div id="ac61a993" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>lut_units <span class="op">=</span> {</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SEAWATER'</span>: <span class="dv">1</span>,  <span class="co"># 'Bq/m3'</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SEDIMENT'</span>: <span class="st">'_UNIT'</span>, <span class="co"># account for in SplitSedimentValuesCB.</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BIOTA'</span>: {</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'D'</span>: <span class="dv">4</span>,  <span class="co"># 'Bq/kgd'</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'W'</span>: <span class="dv">5</span>,  <span class="co"># 'Bq/kgw'</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'F'</span>: <span class="dv">5</span>   <span class="co"># 'Bq/kgw' (assumed to be 'Fresh', so set to wet)</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We define the <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapunitcb"><code>RemapUnitCB</code></a> callback to set the <code>UNIT</code> column in the DataFrames based on the lookup table <code>lut_units</code>.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L348" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapunitcb" class="level3">
<h3 class="anchored" data-anchor-id="remapunitcb">RemapUnitCB</h3>
<blockquote class="blockquote">
<pre><code> RemapUnitCB (lut_units:dict={'SEAWATER': 1, 'SEDIMENT': '_UNIT', 'BIOTA':
              {'D': 4, 'W': 5, 'F': 5}})</code></pre>
</blockquote>
<p><em>Set the <code>unit</code> id column in the DataFrames based on a lookup table.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lut_units</td>
<td>dict</td>
<td>{‘SEAWATER’: 1, ‘SEDIMENT’: ’_UNIT’, ‘BIOTA’: {‘D’: 4, ‘W’: 5, ‘F’: 5}}</td>
<td>Dictionary containing renaming rules for different unit categories</td>
</tr>
</tbody>
</table>
<div id="5ec5a0ef" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapUnitCB(Callback):</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Set the `unit` id column in the DataFrames based on a lookup table."</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                 lut_units: <span class="bu">dict</span><span class="op">=</span>lut_units <span class="co"># Dictionary containing renaming rules for different unit categories</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'SEAWATER'</span>:</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                tfm.dfs[grp][<span class="st">'UNIT'</span>] <span class="op">=</span> <span class="va">self</span>.lut_units[grp]</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> grp <span class="op">==</span> <span class="st">'BIOTA'</span>:</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>                tfm.dfs[grp][<span class="st">'UNIT'</span>] <span class="op">=</span> tfm.dfs[grp][<span class="st">'basis'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: lut_units[grp].get(x, <span class="dv">0</span>))</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> grp <span class="op">==</span> <span class="st">'SEDIMENT'</span>:</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>                tfm.dfs[grp][<span class="st">'UNIT'</span>] <span class="op">=</span> tfm.dfs[grp][<span class="st">'_UNIT'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Apply the transformer for callback <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapunitcb"><code>RemapUnitCB()</code></a>. Then, print the unique <code>UNIT</code> for the <code>SEAWATER</code> dataframe.</p>
<div id="5d546d62" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                            SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'BIOTA'</span>, <span class="st">'SEDIMENT'</span>, <span class="st">'SEAWATER'</span>]:</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tfm()[grp][<span class="st">'UNIT'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16094     21481     70451
Rows removed from original (tfm.dfs_removed)      30       153       144
Rows created in transformed (tfm.dfs_created)      0         0     29851 

BIOTA: [5 0 4]
SEDIMENT: [3 2]
SEAWATER: [1]</code></pre>
</div>
</div>
</section>
</section>
<section id="remap-detection-limit" class="level2">
<h2 class="anchored" data-anchor-id="remap-detection-limit">Remap detection limit</h2>
<p>Detection limits are encoded as follows in MARIS:</p>
<div id="dfcce61f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>pd.read_excel(detection_limit_lut_path())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">name_sanitized</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-1</td>
<td>Not applicable</td>
<td>Not applicable</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>Not Available</td>
<td>Not available</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>=</td>
<td>Detected value</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2</td>
<td>&lt;</td>
<td>Detection limit</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>3</td>
<td>ND</td>
<td>Not detected</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>4</td>
<td>DE</td>
<td>Derived</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We simply set <code>'DL'</code> to <code>2</code> if <code>'DL'</code> is <code>'&lt;'</code> else <code>1</code> in original dataset (based on column containing the DL info for each sample type):</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L370" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapdetectionlimitcb" class="level3">
<h3 class="anchored" data-anchor-id="remapdetectionlimitcb">RemapDetectionLimitCB</h3>
<blockquote class="blockquote">
<pre><code> RemapDetectionLimitCB (coi:dict)</code></pre>
</blockquote>
<p><em>Base class for callbacks.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>coi</td>
<td>dict</td>
<td>Dict of column hosting the detection limit info for each sample type</td>
</tr>
</tbody>
</table>
<div id="23cdb129" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>coi_dl <span class="op">=</span> {<span class="st">'SEAWATER'</span> : {<span class="st">'DL'</span> : <span class="st">'&lt; value_bq/m³'</span>},</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">'BIOTA'</span>:  {<span class="st">'DL'</span> : <span class="st">'&lt; value_bq/kg'</span>},</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">'SEDIMENT'</span>: {<span class="st">'DL'</span> : <span class="st">'_DL'</span>}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="5ae05527" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapDetectionLimitCB(Callback):</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                 coi: <span class="bu">dict</span>,  <span class="co"># Dict of column hosting the detection limit info for each sample type</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs:</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> tfm.dfs[grp]</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>            dl <span class="op">=</span> <span class="va">self</span>.coi[grp][<span class="st">'DL'</span>]</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DL'</span>] <span class="op">=</span> df[dl].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">2</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">'&lt;'</span> <span class="cf">else</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="de3f88de" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>                            SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),                  </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(),</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'BIOTA'</span>, <span class="st">'SEDIMENT'</span>, <span class="st">'SEAWATER'</span>]:</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Unique DL values for </span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[grp][<span class="st">"DL"</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16094     21481     70451
Rows removed from original (tfm.dfs_removed)      30       153       144
Rows created in transformed (tfm.dfs_created)      0         0     29851 

Unique DL values for BIOTA: [2 1]
Unique DL values for SEDIMENT: [1 2]
Unique DL values for SEAWATER: [1 2]</code></pre>
</div>
</div>
</section>
</section>
<section id="remap-biota-species" class="level2">
<h2 class="anchored" data-anchor-id="remap-biota-species">Remap Biota species</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Discrepancies have been identified between some <code>rubin</code> codes in the HELCOM Biota dataset and the entries in the <code>RUBIN_NAME</code> lookup table. These discrepancies include typographical errors and trailing spaces, as illustrated below.</p>
</div>
</div>
<div id="e2c66608" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span>(dfs[<span class="st">'BIOTA'</span>][<span class="st">'rubin'</span>]) <span class="op">-</span> <span class="bu">set</span>(read_csv(<span class="st">'RUBIN_NAME.csv'</span>)[<span class="st">'RUBIN'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'CHAR BALT', 'FUCU SPP', 'FUCU VES ', 'FURC LUMB', 'GADU MOR  ', 'STUC PECT'}</code></pre>
</div>
</div>
<p>Lets review the data that includes inconsistent entries for the <code>rubin</code> column:</p>
<div id="d89a74c8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>rows_to_show <span class="op">=</span> <span class="dv">5</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> dfs[<span class="st">'BIOTA'</span>][dfs[<span class="st">'BIOTA'</span>][<span class="st">'rubin'</span>].isin(<span class="bu">set</span>(dfs[<span class="st">'BIOTA'</span>][<span class="st">'rubin'</span>]) <span class="op">-</span> <span class="bu">set</span>(read_csv(<span class="st">'RUBIN_NAME.csv'</span>)[<span class="st">'RUBIN'</span>]))]</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (<span class="ss">f"Number of inconsistent entries for the `rubin` column: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    display(df.head(rows_to_show))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of inconsistent entries for the `rubin` column: 34</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/kg</th>
<th data-quarto-table-cell-role="th">value_bq/kg</th>
<th data-quarto-table-cell-role="th">basis</th>
<th data-quarto-table-cell-role="th">error%</th>
<th data-quarto-table-cell-role="th">number</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude ddmmmm</th>
<th data-quarto-table-cell-role="th">latitude dddddd</th>
<th data-quarto-table-cell-role="th">longitude ddmmmm</th>
<th data-quarto-table-cell-role="th">longitude dddddd</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">rubin</th>
<th data-quarto-table-cell-role="th">biotatype</th>
<th data-quarto-table-cell-role="th">tissue</th>
<th data-quarto-table-cell-role="th">no</th>
<th data-quarto-table-cell-role="th">length</th>
<th data-quarto-table-cell-role="th">weight</th>
<th data-quarto-table-cell-role="th">dw%</th>
<th data-quarto-table-cell-role="th">loi%</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">13585</th>
<td>BVTIG2012042</td>
<td>K40</td>
<td>VTIG01</td>
<td>NaN</td>
<td>144.00000</td>
<td>W</td>
<td>6.63</td>
<td>NaN</td>
<td>04/07/16 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012042</td>
<td>12/15/12 00:00:00</td>
<td>2012</td>
<td>12.0</td>
<td>15.0</td>
<td>BARC11</td>
<td>54.4717</td>
<td>54.7862</td>
<td>13.5096</td>
<td>13.8493</td>
<td>37.0</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>14.0</td>
<td>48.79</td>
<td>1414.29</td>
<td>19.2</td>
<td>92.9</td>
<td>2.0</td>
<td>2</td>
<td>04/07/16 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13586</th>
<td>BVTIG2012042</td>
<td>CS137</td>
<td>VTIG01</td>
<td>NaN</td>
<td>6.17000</td>
<td>W</td>
<td>6.03</td>
<td>NaN</td>
<td>04/07/16 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012042</td>
<td>12/15/12 00:00:00</td>
<td>2012</td>
<td>12.0</td>
<td>15.0</td>
<td>BARC11</td>
<td>54.4717</td>
<td>54.7862</td>
<td>13.5096</td>
<td>13.8493</td>
<td>37.0</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>14.0</td>
<td>48.79</td>
<td>1414.29</td>
<td>19.2</td>
<td>92.9</td>
<td>2.0</td>
<td>2</td>
<td>04/07/16 00:00:00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13587</th>
<td>BVTIG2012042</td>
<td>CS134</td>
<td>VTIG01</td>
<td>&lt;</td>
<td>0.02366</td>
<td>W</td>
<td>NaN</td>
<td>NaN</td>
<td>04/07/16 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012042</td>
<td>12/15/12 00:00:00</td>
<td>2012</td>
<td>12.0</td>
<td>15.0</td>
<td>BARC11</td>
<td>54.4717</td>
<td>54.7862</td>
<td>13.5096</td>
<td>13.8493</td>
<td>37.0</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>14.0</td>
<td>48.79</td>
<td>1414.29</td>
<td>19.2</td>
<td>92.9</td>
<td>2.0</td>
<td>2</td>
<td>04/07/16 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13594</th>
<td>BVTIG2012045</td>
<td>K40</td>
<td>VTIG01</td>
<td>NaN</td>
<td>131.00000</td>
<td>W</td>
<td>6.62</td>
<td>NaN</td>
<td>04/07/16 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012045</td>
<td>12/16/12 00:00:00</td>
<td>2012</td>
<td>12.0</td>
<td>16.0</td>
<td>B12</td>
<td>54.1385</td>
<td>54.2308</td>
<td>11.4691</td>
<td>11.7818</td>
<td>21.0</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>15.0</td>
<td>38.87</td>
<td>1128.67</td>
<td>18.7</td>
<td>92.7</td>
<td>5.0</td>
<td>16</td>
<td>04/07/16 00:00:00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13595</th>
<td>BVTIG2012045</td>
<td>CS137</td>
<td>VTIG01</td>
<td>NaN</td>
<td>5.77000</td>
<td>W</td>
<td>6.03</td>
<td>NaN</td>
<td>04/07/16 00:00:00</td>
<td>6.0</td>
<td>VTIG</td>
<td>2012045</td>
<td>12/16/12 00:00:00</td>
<td>2012</td>
<td>12.0</td>
<td>16.0</td>
<td>B12</td>
<td>54.1385</td>
<td>54.2308</td>
<td>11.4691</td>
<td>11.7818</td>
<td>21.0</td>
<td>GADU MOR</td>
<td>F</td>
<td>5</td>
<td>15.0</td>
<td>38.87</td>
<td>1128.67</td>
<td>18.7</td>
<td>92.7</td>
<td>5.0</td>
<td>16</td>
<td>04/07/16 00:00:00</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We will remap the HELCOM <code>RUBIN</code> column to the MARIS <code>SPECIES</code> column using the <strong>IMFA</strong> (<strong>I</strong>nspect, <strong>M</strong>atch, <strong>F</strong>ix, <strong>A</strong>pply) pattern. First lets <strong>inspect</strong> the <code>RUBIN_NAME.csv</code> file provided by HELCOM, which describes the nomenclature of <code>BIOTA</code> species.</p>
<div id="023d3b5a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>read_csv(<span class="st">'RUBIN_NAME.csv'</span>).head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RUBIN_ID</th>
<th data-quarto-table-cell-role="th">RUBIN</th>
<th data-quarto-table-cell-role="th">SCIENTIFIC NAME</th>
<th data-quarto-table-cell-role="th">ENGLISH NAME</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>11</td>
<td>ABRA BRA</td>
<td>ABRAMIS BRAMA</td>
<td>BREAM</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>12</td>
<td>ANGU ANG</td>
<td>ANGUILLA ANGUILLA</td>
<td>EEL</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>13</td>
<td>ARCT ISL</td>
<td>ARCTICA ISLANDICA</td>
<td>ISLAND CYPRINE</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>14</td>
<td>ASTE RUB</td>
<td>ASTERIAS RUBENS</td>
<td>COMMON STARFISH</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>15</td>
<td>CARD EDU</td>
<td>CARDIUM EDULE</td>
<td>COCKLE</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now we try to <strong>match</strong> the <code>SCIENTIFIC NAME</code> column of <code>HELCOM</code> <code>BIOTA</code> dataset to the <code>species</code> column of the MARIS species lookup table, again using a <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> object:</p>
<div id="1a45da37" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'RUBIN_NAME.csv'</span>),</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'SCIENTIFIC NAME'</span>,</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'RUBIN'</span>,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'species_helcom.pkl'</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 46/46 [00:07&lt;00:00,  6.39it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>38 entries matched the criteria, while 8 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">STIZ LUC</th>
<td>Sander lucioperca</td>
<td>STIZOSTEDION LUCIOPERCA</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">LAMI SAC</th>
<td>Laminaria japonica</td>
<td>LAMINARIA SACCHARINA</td>
<td>7</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">CARD EDU</th>
<td>Cardiidae</td>
<td>CARDIUM EDULE</td>
<td>6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">CH HI;BA</th>
<td>Macoma balthica</td>
<td>CHARA BALTICA</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ENCH CIM</th>
<td>Echinodermata</td>
<td>ENCHINODERMATA CIM</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">PSET MAX</th>
<td>Pinctada maxima</td>
<td>PSETTA MAXIMA</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MACO BAL</th>
<td>Macoma balthica</td>
<td>MACOMA BALTICA</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">STUC PEC</th>
<td>Stuckenia pectinata</td>
<td>STUCKENIA PECTINATE</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Below, we will correct the entries that were not properly matched by the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> object:</p>
<div id="8290222e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>fixes_biota_species <span class="op">=</span> {</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'STIZOSTEDION LUCIOPERCA'</span>: <span class="st">'Sander luciopercas'</span>,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LAMINARIA SACCHARINA'</span>: <span class="st">'Saccharina latissima'</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CARDIUM EDULE'</span>: <span class="st">'Cerastoderma edule'</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CHARA BALTICA'</span>: NA,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PSETTA MAXIMA'</span>: <span class="st">'Scophthalmus maximus'</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>And give the <code>remapper</code> another try:</p>
<div id="cdb07a63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(fixes<span class="op">=</span>fixes_biota_species)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/46 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 46/46 [00:07&lt;00:00,  6.24it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>42 entries matched the criteria, while 4 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ENCH CIM</th>
<td>Echinodermata</td>
<td>ENCHINODERMATA CIM</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MACO BAL</th>
<td>Macoma balthica</td>
<td>MACOMA BALTICA</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">STIZ LUC</th>
<td>Sander lucioperca</td>
<td>STIZOSTEDION LUCIOPERCA</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">STUC PEC</th>
<td>Stuckenia pectinata</td>
<td>STUCKENIA PECTINATE</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Visual inspection of the remaining unperfectly matched entries seem acceptable to proceed.</p>
<p>We can now use the generic <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> callback to perform the remapping of the <code>RUBIN</code> column to the <code>species</code> column after having defined the lookup table <code>lut_biota</code>.</p>
<div id="e316ffc1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>lut_biota <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'RUBIN_NAME.csv'</span>),</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>                             maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>                             maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                             maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                             provider_col_to_match<span class="op">=</span><span class="st">'SCIENTIFIC NAME'</span>,</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>                             provider_col_key<span class="op">=</span><span class="st">'RUBIN'</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>                             fname_cache<span class="op">=</span><span class="st">'species_helcom.pkl'</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>                             ).generate_lookup_table(fixes<span class="op">=</span>fixes_biota_species, as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="7321b5d9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>].columns</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'SPECIES'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([  99,  243,   50,  139,  270,  192,  191,  284,   84,  269,  122,
         96,  287,  279,  278,  288,  286,  244,  129,  275,  271,  285,
        283,  247,  120,   59,  280,  274,  273,  290,  289,  272,  277,
        276,   21,  282,  110,  281,  245,  704, 1524,  703,    0,  621,
         60])</code></pre>
</div>
</div>
</section>
<section id="remap-body-part" class="level2">
<h2 class="anchored" data-anchor-id="remap-body-part">Remap Body Part</h2>
<p>Let’s inspect the <code>TISSUE.csv</code> file provided by HELCOM describing the tissue nomenclature. Biota tissue is known as <code>body part</code> in the MARIS data set.</p>
<div id="2613f239" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'TISSUE.csv'</span>),</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>bodyparts_lut_path,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'bodypar_id'</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'bodypar'</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'TISSUE_DESCRIPTION'</span>,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'TISSUE'</span>,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'tissues_helcom.pkl'</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 29/29 [00:00&lt;00:00, 112.60it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>21 entries matched the criteria, while 8 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>Flesh without bones</td>
<td>WHOLE FISH WITHOUT HEAD AND ENTRAILS</td>
<td>20</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>Flesh without bones</td>
<td>WHOLE FISH WITHOUT ENTRAILS</td>
<td>13</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Soft parts</td>
<td>SKIN/EPIDERMIS</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Flesh without bones</td>
<td>FLESH WITHOUT BONES (FILETS)</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>Whole animal</td>
<td>WHOLE FISH</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">12</th>
<td>Brain</td>
<td>ENTRAILS</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15</th>
<td>Stomach and intestine</td>
<td>STOMACH + INTESTINE</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">41</th>
<td>Whole animal</td>
<td>WHOLE ANIMALS</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We address several entries that were not correctly matched by the Remapper object, as detailed below:</p>
<div id="c6e2b06f-5eb1-4708-8087-75c836f08112" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>fixes_biota_tissues <span class="op">=</span> {</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WHOLE FISH WITHOUT HEAD AND ENTRAILS'</span>: <span class="st">'Whole animal eviscerated without head'</span>,</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WHOLE FISH WITHOUT ENTRAILS'</span>: <span class="st">'Whole animal eviscerated'</span>,</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SKIN/EPIDERMIS'</span>: <span class="st">'Skin'</span>,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ENTRAILS'</span>: <span class="st">'Viscera'</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c07fc4b8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>, fixes<span class="op">=</span>fixes_biota_tissues)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:  31%|███       | 9/29 [00:00&lt;00:00, 87.12it/s]Processing: 100%|██████████| 29/29 [00:00&lt;00:00, 122.32it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>25 entries matched the criteria, while 4 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>Flesh without bones</td>
<td>FLESH WITHOUT BONES (FILETS)</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Whole animal</td>
<td>WHOLE FISH</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15</th>
<td>Stomach and intestine</td>
<td>STOMACH + INTESTINE</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">41</th>
<td>Whole animal</td>
<td>WHOLE ANIMALS</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Visual inspection of the remaining unperfectly matched entries seem acceptable to proceed.</p>
<p>We can now use the generic <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> callback to perform the remapping of the <code>TISSUE</code> column to the <code>BODY_PART</code> column after having defined the lookup table <code>lut_tissues</code>.</p>
<div id="4c42eb30" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>lut_tissues <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'TISSUE.csv'</span>),</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>                               maris_lut_fn<span class="op">=</span>bodyparts_lut_path,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                               maris_col_id<span class="op">=</span><span class="st">'bodypar_id'</span>,</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                               maris_col_name<span class="op">=</span><span class="st">'bodypar'</span>,</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                               provider_col_to_match<span class="op">=</span><span class="st">'TISSUE_DESCRIPTION'</span>,</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                               provider_col_key<span class="op">=</span><span class="st">'TISSUE'</span>,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                               fname_cache<span class="op">=</span><span class="st">'tissues_helcom.pkl'</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                               ).generate_lookup_table(fixes<span class="op">=</span>fixes_biota_tissues, as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="7d1887c6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_tissues, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'tissue'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm()[<span class="st">'BIOTA'</span>][[<span class="st">'tissue'</span>, <span class="st">'BODY_PART'</span>]][:<span class="dv">5</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   tissue  BODY_PART
0       5         52
1       5         52
2       5         52
3       5         52
4       5         52</code></pre>
</div>
</div>
</section>
<section id="remap-biological-group" class="level2">
<h2 class="anchored" data-anchor-id="remap-biological-group">Remap Biological Group</h2>
<p><code>lut_biogroup_from_biota</code> reads the file at <a href="https://franckalbinet.github.io/marisco/api/configs.html#species_lut_path"><code>species_lut_path()</code></a> and from the contents of this file creates a dictionary linking <code>species_id</code> to <code>biogroup_id</code>.</p>
<div id="cf290302" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>lut_biogroup_from_biota <span class="op">=</span> <span class="kw">lambda</span>: get_lut(src_dir<span class="op">=</span>species_lut_path().parent, fname<span class="op">=</span>species_lut_path().name, </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>                               key<span class="op">=</span><span class="st">'species_id'</span>, value<span class="op">=</span><span class="st">'biogroup_id'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c2a37157" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_tissues, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'tissue'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biogroup_from_biota, col_remap<span class="op">=</span><span class="st">'BIO_GROUP'</span>, col_src<span class="op">=</span><span class="st">'SPECIES'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm()[<span class="st">'BIOTA'</span>][<span class="st">'BIO_GROUP'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[ 4  2 14 11  8  3  0]</code></pre>
</div>
</div>
</section>
<section id="remap-sediment-types" class="level2">
<h2 class="anchored" data-anchor-id="remap-sediment-types">Remap Sediment Types</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>SEDI</code> values <code>56</code> and <code>73</code> are not found in the <code>SEDIMENT_TYPE.csv</code> lookup table provided. Note there are many <code>nan</code> values. We reassign them to <code>-99</code> for now but should be clarified/fixed. This is demonstrated below.</p>
</div>
</div>
<div id="beb4547f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the sediment type lookup table</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>df_sed_lut <span class="op">=</span> read_csv(<span class="st">'SEDIMENT_TYPE.csv'</span>)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data with caching enabled</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract unique sediment types from the dataset and lookup table</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>sediment_sedi <span class="op">=</span> <span class="bu">set</span>(dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'sedi'</span>].unique())</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>lookup_sedi <span class="op">=</span> <span class="bu">set</span>(df_sed_lut[<span class="st">'SEDI'</span>])</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify missing sediment types</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>missing <span class="op">=</span> sediment_sedi <span class="op">-</span> lookup_sedi</span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Output results</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Missing sediment type values in HELCOM lookup table: </span><span class="sc">{</span>missing <span class="cf">if</span> missing <span class="cf">else</span> <span class="st">'None'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of `56.0` values: </span><span class="sc">{</span>(dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'sedi'</span>]<span class="op">==</span> <span class="fl">56.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of `73.0` values: </span><span class="sc">{</span>(dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'sedi'</span>]<span class="op">==</span> <span class="fl">73.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of `NA` values: </span><span class="sc">{</span>(dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'sedi'</span>].isna())<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing sediment type values in HELCOM lookup table: {np.float64(56.0), np.float64(73.0), np.float64(nan)}
Number of `56.0` values: 12
Number of `73.0` values: 3
Number of `NA` values: 1239</code></pre>
</div>
</div>
<p>Once again, we employ the <strong>IMFA</strong> (Inspect, Match, Fix, Apply) pattern to remap the HELCOM sediment types. Let’s inspect the <code>SEDIMENT_TYPE.csv</code> file provided by HELCOM describing the sediment type nomenclature:</p>
<div id="d5f6b82a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    display(read_csv(<span class="st">'SEDIMENT_TYPE.csv'</span>).T)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
<th data-quarto-table-cell-role="th">12</th>
<th data-quarto-table-cell-role="th">13</th>
<th data-quarto-table-cell-role="th">14</th>
<th data-quarto-table-cell-role="th">15</th>
<th data-quarto-table-cell-role="th">16</th>
<th data-quarto-table-cell-role="th">17</th>
<th data-quarto-table-cell-role="th">18</th>
<th data-quarto-table-cell-role="th">19</th>
<th data-quarto-table-cell-role="th">20</th>
<th data-quarto-table-cell-role="th">21</th>
<th data-quarto-table-cell-role="th">22</th>
<th data-quarto-table-cell-role="th">23</th>
<th data-quarto-table-cell-role="th">24</th>
<th data-quarto-table-cell-role="th">25</th>
<th data-quarto-table-cell-role="th">26</th>
<th data-quarto-table-cell-role="th">27</th>
<th data-quarto-table-cell-role="th">28</th>
<th data-quarto-table-cell-role="th">29</th>
<th data-quarto-table-cell-role="th">30</th>
<th data-quarto-table-cell-role="th">31</th>
<th data-quarto-table-cell-role="th">32</th>
<th data-quarto-table-cell-role="th">33</th>
<th data-quarto-table-cell-role="th">34</th>
<th data-quarto-table-cell-role="th">35</th>
<th data-quarto-table-cell-role="th">36</th>
<th data-quarto-table-cell-role="th">37</th>
<th data-quarto-table-cell-role="th">38</th>
<th data-quarto-table-cell-role="th">39</th>
<th data-quarto-table-cell-role="th">40</th>
<th data-quarto-table-cell-role="th">41</th>
<th data-quarto-table-cell-role="th">42</th>
<th data-quarto-table-cell-role="th">43</th>
<th data-quarto-table-cell-role="th">44</th>
<th data-quarto-table-cell-role="th">45</th>
<th data-quarto-table-cell-role="th">46</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">SEDI</th>
<td>-99</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>14</td>
<td>15</td>
<td>20</td>
<td>21</td>
<td>22</td>
<td>23</td>
<td>24</td>
<td>25</td>
<td>30</td>
<td>31</td>
<td>32</td>
<td>33</td>
<td>34</td>
<td>35</td>
<td>40</td>
<td>41</td>
<td>42</td>
<td>43</td>
<td>44</td>
<td>45</td>
<td>46</td>
<td>47</td>
<td>48</td>
<td>49</td>
<td>50</td>
<td>51</td>
<td>52</td>
<td>54</td>
<td>55</td>
<td>57</td>
<td>58</td>
<td>59</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">SEDIMENT TYPE</th>
<td>NO DATA</td>
<td>GRAVEL</td>
<td>SAND</td>
<td>FINE SAND</td>
<td>SILT</td>
<td>CLAY</td>
<td>MUD</td>
<td>GLACIAL</td>
<td>SOFT</td>
<td>SULPHIDIC</td>
<td>Fe-Mg CONCRETIONS</td>
<td>SAND AND GRAVEL</td>
<td>PURE SAND</td>
<td>SAND AND FINE SAND</td>
<td>SAND AND SILT</td>
<td>SAND AND CLAY</td>
<td>SAND AND MUD</td>
<td>FINE SAND AND GRAVEL</td>
<td>FINE SAND AND SAND</td>
<td>PURE FINE SAND</td>
<td>FINE SAND AND SILT</td>
<td>FINE SAND AND CLAY</td>
<td>FINE SAND AND MUD</td>
<td>SILT AND GRAVEL</td>
<td>SILT AND SAND</td>
<td>SILT AND FINE SAND</td>
<td>PURE SILT</td>
<td>SILT AND CLAY</td>
<td>SILT AND MUD</td>
<td>CLAY AND GRAVEL</td>
<td>CLAY AND SAND</td>
<td>CLAY AND FINE SAND</td>
<td>CLAY AND SILT</td>
<td>PURE CLAY</td>
<td>CLAY AND MUD</td>
<td>CLACIAL CLAY</td>
<td>SOFT CLAY</td>
<td>SULPHIDIC CLAY</td>
<td>CLAY AND Fe-Mg CONCRETIONS</td>
<td>MUD AND GARVEL</td>
<td>MUD AND SAND</td>
<td>MUD AND FINE SAND</td>
<td>MUD AND CLAY</td>
<td>PURE MUD</td>
<td>SOFT MUD</td>
<td>SULPHIDIC MUD</td>
<td>MUD AND Fe-Mg CONCRETIONS</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">RECOMMENDED TO BE USED</th>
<td>NaN</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>NO (ONLY TO USE AS ADJECTIVE)</td>
<td>NO (ONLY TO USE AS ADJECTIVE)</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>NO</td>
<td>NO</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
<td>YES</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s try to match as many as possible of the HELCOM sediment types to the MARIS standard sediment types:</p>
<div id="4ce8fced" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'SEDIMENT_TYPE.csv'</span>),</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>sediments_lut_path,</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'sedtype_id'</span>,</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'sedtype'</span>,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'SEDIMENT TYPE'</span>,</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'SEDI'</span>,</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'sediments_helcom.pkl'</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/47 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 47/47 [00:00&lt;00:00, 70.99it/s] </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>44 entries matched the criteria, while 3 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">-99</th>
<td>Soft</td>
<td>NO DATA</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">50</th>
<td>Mud and gravel</td>
<td>MUD AND GARVEL</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">46</th>
<td>Glacial clay</td>
<td>CLACIAL CLAY</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We address the remaining unmatched values by adding fixes_sediments:</p>
<div id="4ea46125" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>fixes_sediments <span class="op">=</span> {</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NO DATA'</span>: NA</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="05728a0a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>, fixes<span class="op">=</span>fixes_sediments)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/47 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 47/47 [00:00&lt;00:00, 71.18it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>44 entries matched the criteria, while 3 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">-99</th>
<td>(Not available)</td>
<td>NO DATA</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">50</th>
<td>Mud and gravel</td>
<td>MUD AND GARVEL</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">46</th>
<td>Glacial clay</td>
<td>CLACIAL CLAY</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Upon visual inspection, the remaining values are deemed acceptable for further processing. We will now implement a callback to remap the SEDI values to their corresponding MARIS standard sediment types, designated as SED_TYPE. The HELCOM SEDIMENT dataset contains SEDI values that are absent from the HELCOM lookup table. These values will be reassigned to <code>-99</code>, indicating ‘Not Available’ as per the HELCOM standards.</p>
<p>Reassign the <code>SEDI</code> values of <code>56</code>, <code>73</code>, and <code>nan</code> to <code>-99</code> (Not available):</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L436" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapsedimentcb" class="level3">
<h3 class="anchored" data-anchor-id="remapsedimentcb">RemapSedimentCB</h3>
<blockquote class="blockquote">
<pre><code> RemapSedimentCB (fn_lut:Callable, sed_grp_name:str='SEDIMENT',
                  sed_col_name:str='sedi', replace_lut:dict=None)</code></pre>
</blockquote>
<p><em>Lookup sediment id using lookup table.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fn_lut</td>
<td>Callable</td>
<td></td>
<td>Function that returns the lookup table dictionary</td>
</tr>
<tr class="even">
<td>sed_grp_name</td>
<td>str</td>
<td>SEDIMENT</td>
<td>The name of the sediment group</td>
</tr>
<tr class="odd">
<td>sed_col_name</td>
<td>str</td>
<td>sedi</td>
<td>The name of the sediment column</td>
</tr>
<tr class="even">
<td>replace_lut</td>
<td>dict</td>
<td>None</td>
<td>Dictionary for replacing SEDI values</td>
</tr>
</tbody>
</table>
<div id="052dda42" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>sed_replace_lut <span class="op">=</span> {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="dv">56</span>: <span class="op">-</span><span class="dv">99</span>,</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">73</span>: <span class="op">-</span><span class="dv">99</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    NA: <span class="op">-</span><span class="dv">99</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="82d99eb0" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapSedimentCB(Callback):</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Lookup sediment id using lookup table."</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>                 fn_lut: Callable,  <span class="co"># Function that returns the lookup table dictionary</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                 sed_grp_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">'SEDIMENT'</span>,  <span class="co"># The name of the sediment group</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>                 sed_col_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">'sedi'</span>,  <span class="co"># The name of the sediment column</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>                 replace_lut: <span class="bu">dict</span> <span class="op">=</span> <span class="va">None</span>  <span class="co"># Dictionary for replacing SEDI values</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Remap sediment types using lookup table."</span></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> tfm.dfs[<span class="va">self</span>.sed_grp_name]</span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._fix_inconsistent_values(df)</span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._map_sediment_types(df)</span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _fix_inconsistent_values(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Fix inconsistent values using the replace lookup table."</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.replace_lut:</span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>            df[<span class="va">self</span>.sed_col_name] <span class="op">=</span> df[<span class="va">self</span>.sed_col_name].replace(<span class="va">self</span>.replace_lut)</span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> NA <span class="kw">in</span> <span class="va">self</span>.replace_lut:</span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>                df[<span class="va">self</span>.sed_col_name] <span class="op">=</span> df[<span class="va">self</span>.sed_col_name].fillna(<span class="va">self</span>.replace_lut[NA])</span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _map_sediment_types(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Map sediment types using the lookup table."</span></span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>        lut <span class="op">=</span> <span class="va">self</span>.fn_lut()</span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SED_TYPE'</span>] <span class="op">=</span> df[<span class="va">self</span>.sed_col_name].<span class="bu">map</span>(</span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: lut.get(x, Match(<span class="dv">0</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>)).matched_id</span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="23fe1d50" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>lut_sediments <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>read_csv(<span class="st">'SEDIMENT_TYPE.csv'</span>),</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>                                 maris_lut_fn<span class="op">=</span>sediments_lut_path,</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>                                 maris_col_id<span class="op">=</span><span class="st">'sedtype_id'</span>,</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>                                 maris_col_name<span class="op">=</span><span class="st">'sedtype'</span>,</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>                                 provider_col_to_match<span class="op">=</span><span class="st">'SEDIMENT TYPE'</span>,</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>                                 provider_col_key<span class="op">=</span><span class="st">'SEDI'</span>,</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>                                 fname_cache<span class="op">=</span><span class="st">'sediments_helcom.pkl'</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>                                 ).generate_lookup_table(fixes<span class="op">=</span>fixes_sediments, as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Utilize the <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapsedimentcb"><code>RemapSedimentCB</code></a> callback to remap the <code>SEDI</code> values in the HELCOM dataset to the corresponding MARIS standard sediment type, referred to as <code>SED_TYPE</code>.</p>
<div id="25495b48" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    RemapSedimentCB(fn_lut<span class="op">=</span>lut_sediments, replace_lut<span class="op">=</span>sed_replace_lut)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'SED_TYPE'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 0,  2, 58, 30, 59, 55, 56, 36, 29, 47,  4, 54, 33,  6, 44, 42, 48,
       61, 57, 28, 49, 32, 45, 39, 46, 38, 31, 60, 62, 26, 53, 52,  1, 51,
       37, 34, 50,  7, 10, 41, 43, 35])</code></pre>
</div>
</div>
</section>
</section>
<section id="remap-filtering-status" class="level2">
<h2 class="anchored" data-anchor-id="remap-filtering-status">Remap Filtering Status</h2>
<p>HELCOM filtered status is encoded as follows in the <code>FILT</code> column:</p>
<div id="5eacd28c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'filt'</span>, as_df<span class="op">=</span><span class="va">True</span>).head(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>N</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>n</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>F</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>MARIS uses a different encoding for filtered status:</p>
<div id="34e737e8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>pd.read_excel(filtered_lut_path())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-1</td>
<td>Not applicable</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>Not available</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>Yes</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2</td>
<td>No</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>For only four categories to remap, the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> is an overkill. We can use a simple dictionary to map the values:</p>
<div id="3d2b4bbc" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>lut_filtered <span class="op">=</span> {</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'N'</span>: <span class="dv">2</span>, <span class="co"># No</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n'</span>: <span class="dv">2</span>, <span class="co"># No</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'F'</span>: <span class="dv">1</span> <span class="co"># Yes</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapfiltcb"><code>RemapFiltCB</code></a> converts the HELCOM <code>filt</code> data to the MARIS <code>FILT</code> format.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L484" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapfiltcb" class="level3">
<h3 class="anchored" data-anchor-id="remapfiltcb">RemapFiltCB</h3>
<blockquote class="blockquote">
<pre><code> RemapFiltCB (lut_filtered:dict={'N': 2, 'n': 2, 'F': 1})</code></pre>
</blockquote>
<p><em>Lookup filt value in dataframe using the lookup table.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>lut_filtered</td>
<td>dict</td>
<td>{‘N’: 2, ‘n’: 2, ‘F’: 1}</td>
<td>Dictionary mapping filt codes to their corresponding names</td>
</tr>
</tbody>
</table>
<div id="e8f58336" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapFiltCB(Callback):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Lookup filt value in dataframe using the lookup table."</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>                 lut_filtered: <span class="bu">dict</span><span class="op">=</span>lut_filtered, <span class="co"># Dictionary mapping filt codes to their corresponding names</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'filt'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'FILT'</span>] <span class="op">=</span> df[<span class="st">'filt'</span>].<span class="bu">map</span>(<span class="kw">lambda</span> x: <span class="va">self</span>.lut_filtered.get(x, <span class="dv">0</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>For instance:</p>
<div id="a2d13536" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[RemapFiltCB(lut_filtered)])</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm()[<span class="st">'SEAWATER'</span>][<span class="st">'FILT'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0 2 1]</code></pre>
</div>
</div>
</section>
</section>
<section id="add-sample-id" class="level2">
<h2 class="anchored" data-anchor-id="add-sample-id">Add Sample ID</h2>
<ul>
<li><code>SMP_ID</code> is a internal unique identifier for each sample</li>
<li><code>SMP_ID_PROVIDER</code> is data provided by the data provider</li>
</ul>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L497" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addsampleidcb" class="level3">
<h3 class="anchored" data-anchor-id="addsampleidcb">AddSampleIDCB</h3>
<blockquote class="blockquote">
<pre><code> AddSampleIDCB ()</code></pre>
</blockquote>
<p><em>Generate a SMP_ID from the KEY values in the HELCOM dataset.</em></p>
<div id="b030cb94" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddSampleIDCB(Callback):</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Generate a SMP_ID from the KEY values in the HELCOM dataset."</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'SMP_ID'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'SMP_ID_PROVIDER'</span>] <span class="op">=</span> df[<span class="st">'key'</span>].astype(<span class="bu">str</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="a13ddf94" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>                        AddSampleIDCB(),</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>                        CompareDfsAndTfmCB(dfs)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>                        ])</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of unique sample ids in SEAWATER: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[<span class="st">"SEAWATER"</span>][<span class="st">"SMP_ID"</span>]<span class="sc">.</span>unique()<span class="sc">.</span>size<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of unique sample ids in BIOTA: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[<span class="st">"BIOTA"</span>][<span class="st">"SMP_ID"</span>]<span class="sc">.</span>unique()<span class="sc">.</span>size<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of unique sample ids in SEDIMENT: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[<span class="st">"SEDIMENT"</span>][<span class="st">"SMP_ID"</span>]<span class="sc">.</span>unique()<span class="sc">.</span>size<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of unique sample ids in SEAWATER: 21634
Number of unique sample ids in BIOTA: 16124
Number of unique sample ids in SEDIMENT: 40744
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21634     40744
Rows removed from original (tfm.dfs_removed)       0         0         0
Rows created in transformed (tfm.dfs_created)      0         0         0 
</code></pre>
</div>
</div>
<div id="2adeeee2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEAWATER'</span>].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">latitude (dddddd)</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WKRIL2012003</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>5.3</td>
<td>32.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012003.0</td>
<td>05/23/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>23.0</td>
<td>RU10</td>
<td>60.05</td>
<td>60.0833</td>
<td>29.20</td>
<td>29.3333</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>1</td>
<td>WKRIL2012003</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WKRIL2012004</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>19.9</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012004.0</td>
<td>05/23/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>23.0</td>
<td>RU10</td>
<td>60.05</td>
<td>60.0833</td>
<td>29.20</td>
<td>29.3333</td>
<td>NaN</td>
<td>29.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>2</td>
<td>WKRIL2012004</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>WKRIL2012005</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>25.5</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012005.0</td>
<td>06/17/12 00:00:00</td>
<td>2012.0</td>
<td>6.0</td>
<td>17.0</td>
<td>RU11</td>
<td>59.26</td>
<td>59.4333</td>
<td>23.09</td>
<td>23.1500</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>3.0</td>
<td>08/20/14 00:00:00</td>
<td>3</td>
<td>WKRIL2012005</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>WKRIL2012006</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>17.0</td>
<td>29.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012006.0</td>
<td>05/24/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>24.0</td>
<td>RU19</td>
<td>60.15</td>
<td>60.2500</td>
<td>27.59</td>
<td>27.9833</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>4</td>
<td>WKRIL2012006</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>WKRIL2012007</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>22.2</td>
<td>18.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012007.0</td>
<td>05/24/12 00:00:00</td>
<td>2012.0</td>
<td>5.0</td>
<td>24.0</td>
<td>RU19</td>
<td>60.15</td>
<td>60.2500</td>
<td>27.59</td>
<td>27.9833</td>
<td>NaN</td>
<td>39.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>5</td>
<td>WKRIL2012007</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="add-depths" class="level2">
<h2 class="anchored" data-anchor-id="add-depths">Add depths</h2>
<p>The HELCOM dataset includes a column for the sampling depth (<code>SDEPTH</code>) for the <code>SEAWATER</code> and <code>BIOTA</code> datasets. Additionally, it contains a column for the total depth (<code>TDEPTH</code>) applicable to both the <code>SEDIMENT</code> and <code>SEAWATER</code> datasets. In this section, we will create a callback to incorporate both the sampling depth (<code>smp_depth</code>) and total depth (<code>tot_depth</code>) into the MARIS dataset.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L505" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="adddepthcb" class="level3">
<h3 class="anchored" data-anchor-id="adddepthcb">AddDepthCB</h3>
<blockquote class="blockquote">
<pre><code> AddDepthCB ()</code></pre>
</blockquote>
<p><em>Ensure depth values are floats and add ‘SMP_DEPTH’ and ‘TOT_DEPTH’ columns.</em></p>
<div id="28f14b73" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddDepthCB(Callback):</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Ensure depth values are floats and add 'SMP_DEPTH' and 'TOT_DEPTH' columns."</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'sdepth'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'SMP_DEPTH'</span>] <span class="op">=</span> df[<span class="st">'sdepth'</span>].astype(<span class="bu">float</span>)</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'tdepth'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'TOT_DEPTH'</span>] <span class="op">=</span> df[<span class="st">'tdepth'</span>].astype(<span class="bu">float</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="96264ee0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[AddDepthCB()])</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():  </span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'SMP_DEPTH'</span> <span class="kw">in</span> tfm.dfs[grp].columns <span class="kw">and</span> <span class="st">'TOT_DEPTH'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'SMP_DEPTH'</span>,<span class="st">'TOT_DEPTH'</span>]].drop_duplicates())</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'SMP_DEPTH'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'SMP_DEPTH'</span>]].drop_duplicates())</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'TOT_DEPTH'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'TOT_DEPTH'</span>]].drop_duplicates())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIOTA:        SMP_DEPTH
0            NaN
78         22.00
88         39.00
96         40.00
183        65.00
...          ...
15874      43.10
15921      30.43
15984       7.60
15985       5.50
15988      11.20

[301 rows x 1 columns]
SEAWATER:        SMP_DEPTH  TOT_DEPTH
0            0.0        NaN
1           29.0        NaN
4           39.0        NaN
6           62.0        NaN
10          71.0        NaN
...          ...        ...
21059       15.0       15.0
21217        7.0       16.0
21235       19.2       21.0
21312        1.0        5.5
21521        0.5        NaN

[1686 rows x 2 columns]
SEDIMENT:        TOT_DEPTH
0           25.0
6           61.0
19          31.0
33          39.0
42          36.0
...          ...
35882        3.9
36086      103.0
36449      108.9
36498        4.5
36899      125.0

[195 rows x 1 columns]</code></pre>
</div>
</div>
</section>
</section>
<section id="add-salinity" class="level2">
<h2 class="anchored" data-anchor-id="add-salinity">Add Salinity</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The HELCOM dataset includes a column for the salinity of the water (<code>SALIN</code>). According to the HELCOM documentation, the <code>SALIN</code> column represents “Salinity of water in PSU units”.</p>
<p>In the SEAWATER dataset, three entries have salinity values greater than 50 PSU. While salinity values greater than 50 PSU are possible, these entries may require further verification. Notably, these three entries have a salinity value of 99.99 PSU, which suggests potential data entry errors.</p>
</div>
</div>
<div id="581e7a84" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'SEAWATER'</span>][tfm.dfs[<span class="st">'SEAWATER'</span>][<span class="st">'salin'</span>] <span class="op">&gt;</span> <span class="dv">50</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">TOT_DEPTH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">12288</th>
<td>WDHIG1998072</td>
<td>CS137</td>
<td>3</td>
<td>NaN</td>
<td>40.1</td>
<td>1.6</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1998072.0</td>
<td>...</td>
<td>25.0</td>
<td>0.0</td>
<td>99.99</td>
<td>5.0</td>
<td>F</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>0.0</td>
<td>25.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">12289</th>
<td>WDHIG1998072</td>
<td>CS134</td>
<td>3</td>
<td>NaN</td>
<td>1.1</td>
<td>23.6</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1998072.0</td>
<td>...</td>
<td>25.0</td>
<td>0.0</td>
<td>99.99</td>
<td>5.0</td>
<td>F</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>0.0</td>
<td>25.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12290</th>
<td>WDHIG1998072</td>
<td>SR90</td>
<td>2</td>
<td>NaN</td>
<td>8.5</td>
<td>1.9</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1998072.0</td>
<td>...</td>
<td>25.0</td>
<td>0.0</td>
<td>99.99</td>
<td>5.0</td>
<td>F</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>0.0</td>
<td>25.0</td>
</tr>
</tbody>
</table>

<p>3 rows × 29 columns</p>
</div>
</div>
</div>
<p>Lets add the salinity values to the SEAWATER DataFrame.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L515" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addsalinitycb" class="level3">
<h3 class="anchored" data-anchor-id="addsalinitycb">AddSalinityCB</h3>
<blockquote class="blockquote">
<pre><code> AddSalinityCB (salinity_col:str='salin')</code></pre>
</blockquote>
<p><em>Base class for callbacks.</em></p>
<div id="1faa14fb" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddSalinityCB(Callback):</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, salinity_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">'salin'</span>):</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.salinity_col <span class="op">=</span> salinity_col</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add salinity to the SEAWATER DataFrame."</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.salinity_col <span class="kw">in</span> df.columns:</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'SALINITY'</span>] <span class="op">=</span> df[<span class="va">self</span>.salinity_col].astype(<span class="bu">float</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="fc93bcbf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[AddSalinityCB()])</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():  </span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'SALINITY'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'SALINITY'</span>]].drop_duplicates())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SEAWATER:        SALINITY
0           NaN
97        7.570
98        7.210
101       7.280
104       7.470
...         ...
21449    11.244
21450     7.426
21451     9.895
21452     2.805
21453     7.341

[2766 rows x 1 columns]</code></pre>
</div>
</div>
</section>
</section>
<section id="add-station" class="level2">
<h2 class="anchored" data-anchor-id="add-station">Add Station</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L525" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addstationcb" class="level3">
<h3 class="anchored" data-anchor-id="addstationcb">AddStationCB</h3>
<blockquote class="blockquote">
<pre><code> AddStationCB ()</code></pre>
</blockquote>
<p><em>Add station to all DataFrames.</em></p>
<div id="55ea4c29" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddStationCB(Callback):</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add station to all DataFrames."</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'STATION'</span>] <span class="op">=</span> df[<span class="st">'station'</span>].astype(<span class="bu">str</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d6e95a56" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[AddStationCB()])</span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>tfm()[<span class="st">'SEAWATER'</span>].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
<th data-quarto-table-cell-role="th">STATION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WKRIL2012003</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>5.3</td>
<td>32.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012003.0</td>
<td>...</td>
<td>29.3333</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>RU10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WKRIL2012004</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>19.9</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012004.0</td>
<td>...</td>
<td>29.3333</td>
<td>NaN</td>
<td>29.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>RU10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>WKRIL2012005</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>25.5</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012005.0</td>
<td>...</td>
<td>23.1500</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>3.0</td>
<td>08/20/14 00:00:00</td>
<td>RU11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>WKRIL2012006</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>17.0</td>
<td>29.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012006.0</td>
<td>...</td>
<td>27.9833</td>
<td>NaN</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>RU19</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>WKRIL2012007</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>22.2</td>
<td>18.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012007.0</td>
<td>...</td>
<td>27.9833</td>
<td>NaN</td>
<td>39.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>11.0</td>
<td>11.0</td>
<td>08/20/14 00:00:00</td>
<td>RU19</td>
</tr>
</tbody>
</table>

<p>5 rows × 28 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="add-temperature" class="level2">
<h2 class="anchored" data-anchor-id="add-temperature">Add Temperature</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The HELCOM dataset includes a column for the temperature of the water (<code>TTEMP</code>). According to the HELCOM documentation, the <code>TTEMP</code> column represents: &gt; ‘Water temperature in Celsius (ºC) degrees of sampled water’</p>
<p>In the SEAWATER dataset, several entries have temperature values greater than 50ºC. These entries may require further verification. Notably, these entries have a temperature value of 99.99ºC, which suggests potential data entry errors, see below.</p>
</div>
</div>
<div id="e0e1b182" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>t_df<span class="op">=</span> tfm.dfs[<span class="st">'SEAWATER'</span>][tfm.dfs[<span class="st">'SEAWATER'</span>][<span class="st">'ttemp'</span>] <span class="op">&gt;</span> <span class="dv">50</span>]</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Number of entries with temperature greater than 50ºC: '</span>, t_df.shape[<span class="dv">0</span>])</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>t_df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of entries with temperature greater than 50ºC:  92</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
<th data-quarto-table-cell-role="th">STATION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">5954</th>
<td>WDHIG1995559</td>
<td>CS134</td>
<td>4</td>
<td>NaN</td>
<td>1.7</td>
<td>15.0</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1995559.0</td>
<td>...</td>
<td>10.2033</td>
<td>13.0</td>
<td>11.0</td>
<td>14.81</td>
<td>99.9</td>
<td>N</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>KFOTN6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5955</th>
<td>WDHIG1995559</td>
<td>CS137</td>
<td>4</td>
<td>NaN</td>
<td>58.7</td>
<td>2.0</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1995559.0</td>
<td>...</td>
<td>10.2033</td>
<td>13.0</td>
<td>11.0</td>
<td>14.81</td>
<td>99.9</td>
<td>N</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>KFOTN6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5960</th>
<td>WDHIG1995569</td>
<td>CS134</td>
<td>4</td>
<td>NaN</td>
<td>1.4</td>
<td>12.0</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1995569.0</td>
<td>...</td>
<td>10.2777</td>
<td>14.0</td>
<td>12.0</td>
<td>14.80</td>
<td>99.9</td>
<td>N</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>LTKIEL</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5961</th>
<td>WDHIG1995569</td>
<td>CS137</td>
<td>4</td>
<td>NaN</td>
<td>62.8</td>
<td>1.0</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1995569.0</td>
<td>...</td>
<td>10.2777</td>
<td>14.0</td>
<td>12.0</td>
<td>14.80</td>
<td>99.9</td>
<td>N</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>LTKIEL</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5964</th>
<td>WDHIG1995571</td>
<td>CS134</td>
<td>4</td>
<td>NaN</td>
<td>1.5</td>
<td>17.0</td>
<td>NaN</td>
<td>6.0</td>
<td>DHIG</td>
<td>1995571.0</td>
<td>...</td>
<td>10.2000</td>
<td>19.0</td>
<td>17.0</td>
<td>14.59</td>
<td>99.9</td>
<td>N</td>
<td>5.0</td>
<td>15.0</td>
<td>NaN</td>
<td>STOLGR</td>
</tr>
</tbody>
</table>

<p>5 rows × 28 columns</p>
</div>
</div>
</div>
<p>Lets add the temperature values to the SEAWATER DataFrame.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L532" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addtemperaturecb" class="level3">
<h3 class="anchored" data-anchor-id="addtemperaturecb">AddTemperatureCB</h3>
<blockquote class="blockquote">
<pre><code> AddTemperatureCB (temperature_col:str='ttemp')</code></pre>
</blockquote>
<p><em>Base class for callbacks.</em></p>
<div id="047afa7e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddTemperatureCB(Callback):</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, temperature_col: <span class="bu">str</span> <span class="op">=</span> <span class="st">'ttemp'</span>):</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temperature_col <span class="op">=</span> temperature_col</span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add temperature to the SEAWATER DataFrame."</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer ):</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.temperature_col <span class="kw">in</span> df.columns:</span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>                df[<span class="st">'TEMPERATURE'</span>] <span class="op">=</span> df[<span class="va">self</span>.temperature_col].astype(<span class="bu">float</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="5d39f789" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[AddTemperatureCB()])</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():  </span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'TEMPERATURE'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'TEMPERATURE'</span>]].drop_duplicates())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SEAWATER:        TEMPERATURE
0              NaN
987           7.80
990           6.50
993           4.10
996           4.80
...            ...
21521         0.57
21523        18.27
21525        21.54
21529         4.94
21537         2.35

[1086 rows x 1 columns]</code></pre>
</div>
</div>
</section>
</section>
<section id="add-slice-position-top-and-bottom" class="level2">
<h2 class="anchored" data-anchor-id="add-slice-position-top-and-bottom">Add slice position (TOP and BOTTOM)</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L542" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapsedslicetopbottomcb" class="level3">
<h3 class="anchored" data-anchor-id="remapsedslicetopbottomcb">RemapSedSliceTopBottomCB</h3>
<blockquote class="blockquote">
<pre><code> RemapSedSliceTopBottomCB ()</code></pre>
</blockquote>
<p><em>Remap Sediment slice top and bottom to MARIS format.</em></p>
<div id="cf398df9" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapSedSliceTopBottomCB(Callback):</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Remap Sediment slice top and bottom to MARIS format."</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Iterate through all DataFrames in the transformer object and remap sediment slice top and bottom."</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>        tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'TOP'</span>] <span class="op">=</span> tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'uppsli'</span>]</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a>        tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'BOTTOM'</span>] <span class="op">=</span> tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'lowsli'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="6479e6f3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[RemapSedSliceTopBottomCB()])</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'SEDIMENT'</span>][[<span class="st">'TOP'</span>,<span class="st">'BOTTOM'</span>]].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    TOP  BOTTOM
0  15.0    20.0
1  20.0    25.0
2  25.0    30.0
3  30.0    35.0
4  35.0    40.0</code></pre>
</div>
</div>
</section>
</section>
<section id="add-dry-weight-wet-weight-and-percentage-weight" class="level2">
<h2 class="anchored" data-anchor-id="add-dry-weight-wet-weight-and-percentage-weight">Add dry weight, wet weight and percentage weight</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Entries for the <code>BASIS</code> value of the <code>BIOTA</code> dataset report a value of <code>F</code> which is not consistent with the HELCOM description provided in the metadata. The <code>GUIDELINES FOR MONITORING OF RADIOACTIVE SUBSTANCES</code> was obtained from <a href="https://metadata.helcom.fi/geonetwork/srv/fin/catalog.search#/metadata/2fdd2d46-0329-40e3-bf96-cb08c7206a24">here</a>.</p>
</div>
</div>
<p>Lets take a look at the BIOTA BASIS values:</p>
<div id="b1dcfc65" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'BIOTA'</span>][<span class="st">'basis'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array(['W', nan, 'D', 'F'], dtype=object)</code></pre>
</div>
</div>
<p>Number of entries for each <code>BASIS</code> value:</p>
<div id="09d37b0a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'BIOTA'</span>][<span class="st">'basis'</span>].value_counts()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>basis
W    12164
D     3868
F       25
Name: count, dtype: int64</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some entries for <code>DW%</code> (Dry weight as percentage (%) of fresh weight) are much higher than 100%. Additionally, <code>DW%</code> is repoted as 0% in some cases.</p>
</div>
</div>
<p>For BIOTA, the number of entries for <code>DW%</code> higher than 100%:</p>
<div id="afbc7826" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'BIOTA'</span>][<span class="st">'dw%'</span>][dfs[<span class="st">'BIOTA'</span>][<span class="st">'dw%'</span>] <span class="op">&gt;</span> <span class="dv">100</span>].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>np.int64(20)</code></pre>
</div>
</div>
<p>For BIOTA, the number of entries for <code>DW%</code> equal to 0%:</p>
<div id="0f386973" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'BIOTA'</span>][<span class="st">'dw%'</span>][dfs[<span class="st">'BIOTA'</span>][<span class="st">'dw%'</span>] <span class="op">==</span> <span class="dv">0</span>].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>np.int64(6)</code></pre>
</div>
</div>
<p>For SEDIMENT, the number of entries for <code>DW%</code> higher than 100%:</p>
<div id="37493d7f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>][dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>] <span class="op">&gt;</span> <span class="dv">100</span>].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>np.int64(625)</code></pre>
</div>
</div>
<p>For SEDIMENT, the number of entries for <code>DW%</code> equal to 0%:</p>
<div id="44234014" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>][dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>] <span class="op">==</span> <span class="dv">0</span>].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>np.int64(302)</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Several SEDIMENT entries have <code>DW%</code> (Dry weight as percentage of fresh weight) values less than 1%. While technically possible, this would indicate samples contained more than 99% water content.</p>
</div>
</div>
<p>For SEDIMENT, the number of entries for <code>DW%</code> less than 1% but greater than 0.001%:</p>
<div id="24c78c1a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>percent<span class="op">=</span><span class="dv">1</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>][(dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>] <span class="op">&lt;</span> percent) <span class="op">&amp;</span> (dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'dw%'</span>] <span class="op">&gt;</span> <span class="fl">0.001</span>)].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>np.int64(24)</code></pre>
</div>
</div>
<p>Lets take a look at the MARIS description of the <code>percentwt</code>, <code>drywt</code> and <code>wetwt</code> variables:</p>
<ul>
<li><code>percentwt</code>: Dry weight as ratio of fresh weight, expressed as a decimal .</li>
<li><code>drywt</code>: Dry weight in grams.</li>
<li><code>wetwt</code>: Fresh weight in grams.</li>
</ul>
<p>Lets take a look at the HELCOM dataset, the weight of the sample is not reported for <code>SEDIMENT</code>. However, the percentage dry weight is reported as <code>DW%</code>.</p>
<div id="fa92c9de" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEDIMENT'</span>].columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Index(['key', 'nuclide', 'method', '&lt; value_bq/kg', 'value_bq/kg', 'error%_kg',
       '&lt; value_bq/m²', 'value_bq/m²', 'error%_m²', 'date_of_entry_x',
       'country', 'laboratory', 'sequence', 'date', 'year', 'month', 'day',
       'station', 'latitude (ddmmmm)', 'latitude (dddddd)',
       'longitude (ddmmmm)', 'longitude (dddddd)', 'device', 'tdepth',
       'uppsli', 'lowsli', 'area', 'sedi', 'oxic', 'dw%', 'loi%',
       'mors_subbasin', 'helcom_subbasin', 'sum_link', 'date_of_entry_y'],
      dtype='object')</code></pre>
</div>
</div>
<p>The BIOTA dataset reports the weight of the sample as <code>WEIGHT</code> and the percentage dry weight as <code>DW%</code>. The <code>BASIS</code> column describes the basis of the value reported. Lets create a callback to include the <code>PERCENTWT</code>, <code>DRYWT</code> and <code>WETWT</code> columns in the MARIS dataset.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L550" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="lookupdrywetpercentweightcb" class="level3">
<h3 class="anchored" data-anchor-id="lookupdrywetpercentweightcb">LookupDryWetPercentWeightCB</h3>
<blockquote class="blockquote">
<pre><code> LookupDryWetPercentWeightCB ()</code></pre>
</blockquote>
<p><em>Lookup dry-wet ratio and format for MARIS.</em></p>
<div id="ef385c79" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LookupDryWetPercentWeightCB(Callback):</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Lookup dry-wet ratio and format for MARIS."</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Iterate through all DataFrames in the transformer object and apply the dry-wet ratio lookup."</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():</span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'dw%'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._apply_dry_wet_ratio(tfm.dfs[grp])</span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'weight'</span> <span class="kw">in</span> tfm.dfs[grp].columns <span class="kw">and</span> <span class="st">'basis'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._correct_basis(tfm.dfs[grp])</span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._apply_weight(tfm.dfs[grp])</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _apply_dry_wet_ratio(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Apply dry-wet ratio conversion and formatting to the given DataFrame."</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'PERCENTWT'</span>] <span class="op">=</span> df[<span class="st">'dw%'</span>] <span class="op">/</span> <span class="dv">100</span>  <span class="co"># Convert percentage to fraction</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">'PERCENTWT'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'PERCENTWT'</span>] <span class="op">=</span> np.nan  <span class="co"># Convert 0% to nan</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _correct_basis(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Correct BASIS values. Assuming F = Fresh weight, so F = W"</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">'basis'</span>] <span class="op">==</span> <span class="st">'F'</span>, <span class="st">'basis'</span>] <span class="op">=</span> <span class="st">'W'</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _apply_weight(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Apply weight conversion and formatting to the given DataFrame."</span></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>        dry_condition <span class="op">=</span> df[<span class="st">'basis'</span>] <span class="op">==</span> <span class="st">'D'</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a>        wet_condition <span class="op">=</span> df[<span class="st">'basis'</span>] <span class="op">==</span> <span class="st">'W'</span></span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a>        df.loc[dry_condition, <span class="st">'DRYWT'</span>] <span class="op">=</span> df[<span class="st">'weight'</span>]</span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>        df.loc[dry_condition <span class="op">&amp;</span> df[<span class="st">'PERCENTWT'</span>].notna(), <span class="st">'WETWT'</span>] <span class="op">=</span> df[<span class="st">'weight'</span>] <span class="op">/</span> df[<span class="st">'PERCENTWT'</span>]</span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>        df.loc[wet_condition, <span class="st">'WETWT'</span>] <span class="op">=</span> df[<span class="st">'weight'</span>]</span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a>        df.loc[wet_condition <span class="op">&amp;</span> df[<span class="st">'PERCENTWT'</span>].notna(), <span class="st">'DRYWT'</span>] <span class="op">=</span> df[<span class="st">'weight'</span>] <span class="op">*</span> df[<span class="st">'PERCENTWT'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="e9d714bc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>                            LookupDryWetPercentWeightCB(),</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'BIOTA:'</span>, tfm.dfs[<span class="st">'BIOTA'</span>][[<span class="st">'PERCENTWT'</span>,<span class="st">'DRYWT'</span>,<span class="st">'WETWT'</span>]].head(), <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'SEDIMENT:'</span>, tfm.dfs[<span class="st">'SEDIMENT'</span>][<span class="st">'PERCENTWT'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21634     40744
Rows removed from original (tfm.dfs_removed)       0         0         0
Rows created in transformed (tfm.dfs_created)      0         0         0 

BIOTA:    PERCENTWT      DRYWT  WETWT
0    0.18453  174.93444  948.0
1    0.18453  174.93444  948.0
2    0.18453  174.93444  948.0
3    0.18453  174.93444  948.0
4    0.18458  177.93512  964.0 

SEDIMENT: [       nan 0.1        0.13       ... 0.24418605 0.25764192 0.26396495]</code></pre>
</div>
</div>
<p>Note that the dry weight is greater than the wet weight for some entries in the BIOTA dataset due to the DW% being greater than 100%, see above. Lets take a look at the number of entries where this is the case:</p>
<div id="f38bc359" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>][[<span class="st">'DRYWT'</span>,<span class="st">'WETWT'</span>]][tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'DRYWT'</span>] <span class="op">&gt;</span> tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'WETWT'</span>]].count()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>DRYWT    20
WETWT    20
dtype: int64</code></pre>
</div>
</div>
</section>
</section>
<section id="standardize-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="standardize-coordinates">Standardize Coordinates</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Column names for geographical coordinates are inconsistent across sample types (biota, sediment, seawater). Sometimes using parentheses, sometimes not.</p>
</div>
</div>
<div id="03c04fe9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> dfs.keys():</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>[col <span class="cf">for</span> col <span class="kw">in</span> dfs[grp].columns <span class="cf">if</span> <span class="st">"lon"</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">"lat"</span> <span class="kw">in</span> col]<span class="sc">}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>BIOTA: ['latitude ddmmmm', 'latitude dddddd', 'longitude ddmmmm', 'longitude dddddd']
SEAWATER: ['latitude (ddmmmm)', 'latitude (dddddd)', 'longitude (ddmmmm)', 'longitude (dddddd)']
SEDIMENT: ['latitude (ddmmmm)', 'latitude (dddddd)', 'longitude (ddmmmm)', 'longitude (dddddd)']</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>HELCOM SEAWATER data includes values of 0 or nan for both latitude and longitude.</p>
</div>
</div>
<p>Lets create a callback to parse the coordinates of the HELCOM dataset.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L582" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="parsecoordinates" class="level3">
<h3 class="anchored" data-anchor-id="parsecoordinates">ParseCoordinates</h3>
<blockquote class="blockquote">
<pre><code> ParseCoordinates (fn_convert_cor:Callable)</code></pre>
</blockquote>
<p><em>Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fn_convert_cor</td>
<td>Callable</td>
<td>Function that converts coordinates from degree-minute to decimal degree format</td>
</tr>
</tbody>
</table>
<div id="61afcc23" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParseCoordinates(Callback):</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero."</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>                 fn_convert_cor: Callable <span class="co"># Function that converts coordinates from degree-minute to decimal degree format</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fn_convert_cor <span class="op">=</span> fn_convert_cor</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm:Transformer):</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> df <span class="kw">in</span> tfm.dfs.values():</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._format_coordinates(df)</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _format_coordinates(<span class="va">self</span>, df:pd.DataFrame) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>        coord_cols <span class="op">=</span> <span class="va">self</span>._get_coord_columns(df.columns)</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> coord <span class="kw">in</span> [<span class="st">'lat'</span>, <span class="st">'lon'</span>]:</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>            decimal_col, minute_col <span class="op">=</span> coord_cols[<span class="ss">f'</span><span class="sc">{</span>coord<span class="sc">}</span><span class="ss">_d'</span>], coord_cols[<span class="ss">f'</span><span class="sc">{</span>coord<span class="sc">}</span><span class="ss">_m'</span>]</span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Attempt to convert columns to numeric, coercing errors to NaN.</span></span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>            df[decimal_col] <span class="op">=</span> pd.to_numeric(df[decimal_col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>            df[minute_col] <span class="op">=</span> pd.to_numeric(df[minute_col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>            condition <span class="op">=</span> df[decimal_col].isna() <span class="op">|</span> (df[decimal_col] <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>            df[coord.upper()] <span class="op">=</span> np.where(condition,</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>                                 df[minute_col].<span class="bu">apply</span>(<span class="va">self</span>._safe_convert),</span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>                                 df[decimal_col])</span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>        df.dropna(subset<span class="op">=</span>[<span class="st">'LAT'</span>, <span class="st">'LON'</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_coord_columns(<span class="va">self</span>, columns) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lon_d'</span>: <span class="va">self</span>._find_coord_column(columns, <span class="st">'lon'</span>, <span class="st">'dddddd'</span>),</span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lat_d'</span>: <span class="va">self</span>._find_coord_column(columns, <span class="st">'lat'</span>, <span class="st">'dddddd'</span>),</span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lon_m'</span>: <span class="va">self</span>._find_coord_column(columns, <span class="st">'lon'</span>, <span class="st">'ddmmmm'</span>),</span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lat_m'</span>: <span class="va">self</span>._find_coord_column(columns, <span class="st">'lat'</span>, <span class="st">'ddmmmm'</span>)</span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _find_coord_column(<span class="va">self</span>, columns, coord_type, coord_format) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>        pattern <span class="op">=</span> re.<span class="bu">compile</span>(<span class="ss">f'</span><span class="sc">{</span>coord_type<span class="sc">}</span><span class="ss">.*</span><span class="sc">{</span>coord_format<span class="sc">}</span><span class="ss">'</span>, re.IGNORECASE)</span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a>        matching_columns <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> columns <span class="cf">if</span> pattern.search(col)]</span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> matching_columns[<span class="dv">0</span>] <span class="cf">if</span> matching_columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-41"><a href="#cb179-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _safe_convert(<span class="va">self</span>, value) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb179-42"><a href="#cb179-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.isna(value):</span>
<span id="cb179-43"><a href="#cb179-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> value</span>
<span id="cb179-44"><a href="#cb179-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb179-45"><a href="#cb179-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.fn_convert_cor(value)</span>
<span id="cb179-46"><a href="#cb179-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb179-47"><a href="#cb179-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error converting value </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb179-48"><a href="#cb179-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> value</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="1baf7136" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[                    </span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>                            ParseCoordinates(ddmm_to_dd),</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'BIOTA'</span>][[<span class="st">'LAT'</span>,<span class="st">'LON'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21626     40743
Rows removed from original (tfm.dfs_removed)       0         8         1
Rows created in transformed (tfm.dfs_created)      0         0         0 

             LAT        LON
0      54.283333  12.316667
1      54.283333  12.316667
2      54.283333  12.316667
3      54.283333  12.316667
4      54.283333  12.316667
...          ...        ...
16119  61.241500  21.395000
16120  61.241500  21.395000
16121  61.343333  21.385000
16122  61.343333  21.385000
16123  61.343333  21.385000

[16124 rows x 2 columns]</code></pre>
</div>
</div>
<p>Lets review the rows removed from SEAWATER dataset during the parsing of coordinates:</p>
<div id="42d0941e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>, <span class="st">'display.max_colwidth'</span>, <span class="va">None</span>):</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs_removed[<span class="st">'SEAWATER'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">station</th>
<th data-quarto-table-cell-role="th">latitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">latitude (dddddd)</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">20556</th>
<td>WSSSM2015009</td>
<td>H3</td>
<td>STYR201</td>
<td>&lt;</td>
<td>2450.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20557</th>
<td>WSSSM2015010</td>
<td>H3</td>
<td>STYR201</td>
<td>NaN</td>
<td>2510.0</td>
<td>29.17</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20558</th>
<td>WSSSM2015011</td>
<td>H3</td>
<td>STYR201</td>
<td>&lt;</td>
<td>2450.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20559</th>
<td>WSSSM2015012</td>
<td>H3</td>
<td>STYR201</td>
<td>NaN</td>
<td>1740.0</td>
<td>41.26</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20560</th>
<td>WSSSM2015013</td>
<td>H3</td>
<td>STYR201</td>
<td>NaN</td>
<td>1650.0</td>
<td>43.53</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20561</th>
<td>WSSSM2015014</td>
<td>H3</td>
<td>STYR201</td>
<td>&lt;</td>
<td>2277.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20562</th>
<td>WSSSM2015015</td>
<td>H3</td>
<td>STYR201</td>
<td>&lt;</td>
<td>2277.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20563</th>
<td>WSSSM2015016</td>
<td>H3</td>
<td>STYR201</td>
<td>&lt;</td>
<td>2277.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Sanitize coordinates by dropping rows where both longitude and latitude are zero or contain unrealistic values. Convert the , separator in longitude and latitude to a . separator</p>
<div id="99a85059" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir,  use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>                            ParseCoordinates(ddmm_to_dd),</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'BIOTA'</span>][[<span class="st">'LAT'</span>,<span class="st">'LON'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16124     21626     40743
Rows removed from original (tfm.dfs_removed)       0         8         1
Rows created in transformed (tfm.dfs_created)      0         0         0 

             LAT        LON
0      54.283333  12.316667
1      54.283333  12.316667
2      54.283333  12.316667
3      54.283333  12.316667
4      54.283333  12.316667
...          ...        ...
16119  61.241500  21.395000
16120  61.241500  21.395000
16121  61.343333  21.385000
16122  61.343333  21.385000
16123  61.343333  21.385000

[16124 rows x 2 columns]</code></pre>
</div>
</div>
</section>
</section>
<section id="review-all-callbacks" class="level2">
<h2 class="anchored" data-anchor-id="review-all-callbacks">Review all callbacks</h2>
<div id="b8a07959" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>                            SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),       </span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(),</span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),                           </span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_tissues, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'tissue'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biogroup_from_biota, col_remap<span class="op">=</span><span class="st">'BIO_GROUP'</span>, col_src<span class="op">=</span><span class="st">'SPECIES'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a>                            RemapSedimentCB(fn_lut<span class="op">=</span>lut_sediments, replace_lut<span class="op">=</span>sed_replace_lut),</span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a>                            RemapFiltCB(lut_filtered),</span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a>                            AddSampleIDCB(),</span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),</span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a>                            AddSalinityCB(),</span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a>                            AddTemperatureCB(),</span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a>                            RemapSedSliceTopBottomCB(),</span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a>                            LookupDryWetPercentWeightCB(),</span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a>                            ParseCoordinates(ddmm_to_dd),</span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a>                            AddStationCB(),</span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb185-27"><a href="#cb185-27" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb185-28"><a href="#cb185-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-29"><a href="#cb185-29" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb185-30"><a href="#cb185-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: 8 missing time value(s) in SEAWATER
Warning: 1 missing time value(s) in SEDIMENT
                                               BIOTA  SEAWATER  SEDIMENT
Original row count (dfs)                       16124     21634     40744
Transformed row count (tfm.dfs)                16094     21473     70449
Rows removed from original (tfm.dfs_removed)      30       161       144
Rows created in transformed (tfm.dfs_created)      0         0     29849 
</code></pre>
</div>
</div>
<div id="7dedb0b9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'SEAWATER'</span>].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FILT</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">TOT_DEPTH</th>
<th data-quarto-table-cell-role="th">SALINITY</th>
<th data-quarto-table-cell-role="th">TEMPERATURE</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">STATION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WKRIL2012003</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>5.3</td>
<td>32.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012003.0</td>
<td>...</td>
<td>0</td>
<td>1</td>
<td>WKRIL2012003</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>60.0833</td>
<td>29.3333</td>
<td>RU10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WKRIL2012004</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>19.9</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012004.0</td>
<td>...</td>
<td>0</td>
<td>2</td>
<td>WKRIL2012004</td>
<td>29.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>60.0833</td>
<td>29.3333</td>
<td>RU10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>WKRIL2012005</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>25.5</td>
<td>20.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012005.0</td>
<td>...</td>
<td>0</td>
<td>3</td>
<td>WKRIL2012005</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>59.4333</td>
<td>23.1500</td>
<td>RU11</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>WKRIL2012006</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>17.0</td>
<td>29.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012006.0</td>
<td>...</td>
<td>0</td>
<td>4</td>
<td>WKRIL2012006</td>
<td>0.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>60.2500</td>
<td>27.9833</td>
<td>RU19</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>WKRIL2012007</td>
<td>CS137</td>
<td>NaN</td>
<td>NaN</td>
<td>22.2</td>
<td>18.0</td>
<td>08/20/14 00:00:00</td>
<td>90.0</td>
<td>KRIL</td>
<td>2012007.0</td>
<td>...</td>
<td>0</td>
<td>5</td>
<td>WKRIL2012007</td>
<td>39.0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>60.2500</td>
<td>27.9833</td>
<td>RU19</td>
</tr>
</tbody>
</table>

<p>5 rows × 43 columns</p>
</div>
</div>
</div>
<p>Lets inspect the rows that are removed for the SEAWATER data:</p>
<div id="a64ad4fb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>grp<span class="op">=</span><span class="st">'SEAWATER'</span> <span class="co"># 'SEAWATER', 'BIOTA' or 'SEDIMENT'</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">, number of dropped rows: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs_removed[grp]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">.'</span>)</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Viewing dropped rows for </span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>)</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>tfm.dfs_removed[grp]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SEAWATER, number of dropped rows: 161.
Viewing dropped rows for SEAWATER:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">&lt; value_bq/m³</th>
<th data-quarto-table-cell-role="th">value_bq/m³</th>
<th data-quarto-table-cell-role="th">error%_m³</th>
<th data-quarto-table-cell-role="th">date_of_entry_x</th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">laboratory</th>
<th data-quarto-table-cell-role="th">sequence</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">longitude (ddmmmm)</th>
<th data-quarto-table-cell-role="th">longitude (dddddd)</th>
<th data-quarto-table-cell-role="th">tdepth</th>
<th data-quarto-table-cell-role="th">sdepth</th>
<th data-quarto-table-cell-role="th">salin</th>
<th data-quarto-table-cell-role="th">ttemp</th>
<th data-quarto-table-cell-role="th">filt</th>
<th data-quarto-table-cell-role="th">mors_subbasin</th>
<th data-quarto-table-cell-role="th">helcom_subbasin</th>
<th data-quarto-table-cell-role="th">date_of_entry_y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">13439</th>
<td>WRISO2001025</td>
<td>CS137</td>
<td>RISO02</td>
<td>NaN</td>
<td>NaN</td>
<td>10.0</td>
<td>NaN</td>
<td>26.0</td>
<td>RISO</td>
<td>2001025.0</td>
<td>...</td>
<td>10.500</td>
<td>10.833333</td>
<td>22.0</td>
<td>20.0</td>
<td>0.00</td>
<td>NaN</td>
<td>N</td>
<td>5.0</td>
<td>5.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">14017</th>
<td>WLEPA2002001</td>
<td>CS134</td>
<td>LEPA02</td>
<td>&lt;</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>93.0</td>
<td>LEPA</td>
<td>2002001.0</td>
<td>...</td>
<td>21.030</td>
<td>21.050000</td>
<td>16.0</td>
<td>0.0</td>
<td>3.77</td>
<td>14.40</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14020</th>
<td>WLEPA2002002</td>
<td>CS134</td>
<td>LEPA02</td>
<td>&lt;</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>93.0</td>
<td>LEPA</td>
<td>2002004.0</td>
<td>...</td>
<td>20.574</td>
<td>20.956667</td>
<td>14.0</td>
<td>0.0</td>
<td>6.57</td>
<td>11.95</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">14023</th>
<td>WLEPA2002003</td>
<td>CS134</td>
<td>LEPA02</td>
<td>&lt;</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>93.0</td>
<td>LEPA</td>
<td>2002007.0</td>
<td>...</td>
<td>19.236</td>
<td>19.393333</td>
<td>73.0</td>
<td>0.0</td>
<td>7.00</td>
<td>9.19</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14026</th>
<td>WLEPA2002004</td>
<td>CS134</td>
<td>LEPA02</td>
<td>&lt;</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>93.0</td>
<td>LEPA</td>
<td>2002010.0</td>
<td>...</td>
<td>20.205</td>
<td>20.341700</td>
<td>47.0</td>
<td>0.0</td>
<td>7.06</td>
<td>8.65</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21542</th>
<td>WLRPC2023011</td>
<td>SR90</td>
<td>LRPC02</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>05/03/24 00:00:00</td>
<td>93.0</td>
<td>LRPC</td>
<td>2023011.0</td>
<td>...</td>
<td>20.480</td>
<td>20.800000</td>
<td>45.0</td>
<td>1.0</td>
<td>7.22</td>
<td>19.80</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>05/03/24 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21543</th>
<td>WLRPC2023012</td>
<td>CS137</td>
<td>LRPC01</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>05/03/24 00:00:00</td>
<td>93.0</td>
<td>LRPC</td>
<td>2023012.0</td>
<td>...</td>
<td>20.480</td>
<td>20.800000</td>
<td>45.0</td>
<td>1.0</td>
<td>7.23</td>
<td>8.80</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>05/03/24 00:00:00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21544</th>
<td>WLRPC2023012</td>
<td>SR90</td>
<td>LRPC02</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>05/03/24 00:00:00</td>
<td>93.0</td>
<td>LRPC</td>
<td>2023012.0</td>
<td>...</td>
<td>20.480</td>
<td>20.800000</td>
<td>45.0</td>
<td>1.0</td>
<td>7.23</td>
<td>8.80</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>05/03/24 00:00:00</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21545</th>
<td>WLRPC2023013</td>
<td>CS137</td>
<td>LRPC01</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>05/03/24 00:00:00</td>
<td>93.0</td>
<td>LRPC</td>
<td>2023013.0</td>
<td>...</td>
<td>20.427</td>
<td>20.711700</td>
<td>41.0</td>
<td>1.0</td>
<td>7.23</td>
<td>19.30</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>05/03/24 00:00:00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21546</th>
<td>WLRPC2023013</td>
<td>SR90</td>
<td>LRPC02</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>05/03/24 00:00:00</td>
<td>93.0</td>
<td>LRPC</td>
<td>2023013.0</td>
<td>...</td>
<td>20.427</td>
<td>20.711700</td>
<td>41.0</td>
<td>1.0</td>
<td>7.23</td>
<td>19.30</td>
<td>N</td>
<td>4.0</td>
<td>9.0</td>
<td>05/03/24 00:00:00</td>
</tr>
</tbody>
</table>

<p>161 rows × 27 columns</p>
</div>
</div>
</div>
<section id="example-change-logs" class="level3">
<h3 class="anchored" data-anchor-id="example-change-logs">Example change logs</h3>
<div id="75d1968d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>                            SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),       </span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(),</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),                           </span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_tissues, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'tissue'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biogroup_from_biota, col_remap<span class="op">=</span><span class="st">'BIO_GROUP'</span>, col_src<span class="op">=</span><span class="st">'SPECIES'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>                            RemapSedimentCB(fn_lut<span class="op">=</span>lut_sediments, replace_lut<span class="op">=</span>sed_replace_lut),</span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>                            RemapFiltCB(lut_filtered),</span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>                            AddSampleIDCB(),</span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),</span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>                            AddSalinityCB(),</span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>                            AddTemperatureCB(),</span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>                            RemapSedSliceTopBottomCB(),</span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>                            LookupDryWetPercentWeightCB(),</span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>                            ParseCoordinates(ddmm_to_dd),</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>tfm.logs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: 8 missing time value(s) in SEAWATER
Warning: 1 missing time value(s) in SEDIMENT</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>["Convert 'nuclide' column values to lowercase, strip spaces, and store in 'NUCLIDE' column.",
 'Remap data provider nuclide names to standardized MARIS nuclide names.',
 'Standardize time format across all dataframes.',
 'Encode time as seconds since epoch.',
 'Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements.',
 'Sanitize measurement values by removing blanks and standardizing to use the `VALUE` column.',
 'Convert from relative error to standard uncertainty.',
 'Set the `unit` id column in the DataFrames based on a lookup table.',
 'Remap value type to MARIS format.',
 "Remap values from 'rubin' to 'SPECIES' for groups: BIOTA.",
 "Remap values from 'tissue' to 'BODY_PART' for groups: BIOTA.",
 "Remap values from 'SPECIES' to 'BIO_GROUP' for groups: BIOTA.",
 'Lookup sediment id using lookup table.',
 'Lookup filt value in dataframe using the lookup table.',
 'Generate a SMP_ID from the KEY values in the HELCOM dataset.',
 "Ensure depth values are floats and add 'SMP_DEPTH' and 'TOT_DEPTH' columns.",
 'Remap Sediment slice top and bottom to MARIS format.',
 'Lookup dry-wet ratio and format for MARIS.',
 'Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero.',
 'Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator.']</code></pre>
</div>
</div>
</section>
</section>
<section id="feed-global-attributes" class="level2">
<h2 class="anchored" data-anchor-id="feed-global-attributes">Feed global attributes</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L269" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_attrs" class="level3">
<h3 class="anchored" data-anchor-id="get_attrs">get_attrs</h3>
<blockquote class="blockquote">
<pre><code> get_attrs (tfm:marisco.callbacks.Transformer, zotero_key:str,
            kw:list=['oceanography', 'Earth Science &gt; Oceans &gt; Ocean
            Chemistry&gt; Radionuclides', 'Earth Science &gt; Human Dimensions &gt;
            Environmental Impacts &gt; Nuclear Radiation Exposure', 'Earth
            Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth
            Science &gt; Oceans &gt; Marine Sediments', 'Earth Science &gt; Oceans
            &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt;
            Isotopes', 'Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean
            Contaminants', 'Earth Science &gt; Biological Classification &gt;
            Animals/Vertebrates &gt; Fish', 'Earth Science &gt; Biosphere &gt;
            Ecosystems &gt; Marine Ecosystems', 'Earth Science &gt; Biological
            Classification &gt; Animals/Invertebrates &gt; Mollusks', 'Earth
            Science &gt; Biological Classification &gt; Animals/Invertebrates &gt;
            Arthropods &gt; Crustaceans', 'Earth Science &gt; Biological
            Classification &gt; Plants &gt; Macroalgae (Seaweeds)'])</code></pre>
</blockquote>
<p><em>Retrieve all global attributes.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>tfm</td>
<td>Transformer</td>
<td></td>
<td>Transformer object</td>
</tr>
<tr class="even">
<td>zotero_key</td>
<td>str</td>
<td></td>
<td>Zotero dataset record key</td>
</tr>
<tr class="odd">
<td>kw</td>
<td>list</td>
<td>[‘oceanography’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides’, ‘Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes’, ‘Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants’, ‘Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish’, ‘Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems’, ‘Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks’, ‘Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans’, ‘Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)’]</td>
<td>List of keywords</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
<td><strong>Global attributes</strong></td>
</tr>
</tbody>
</table>
<div id="f6aa393b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_attrs(</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    tfm: Transformer, <span class="co"># Transformer object</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    zotero_key: <span class="bu">str</span>, <span class="co"># Zotero dataset record key</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>    kw: <span class="bu">list</span> <span class="op">=</span> kw <span class="co"># List of keywords</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">dict</span>: <span class="co"># Global attributes</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Retrieve all global attributes."</span></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> GlobAttrsFeeder(tfm.dfs, cbs<span class="op">=</span>[</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        BboxCB(),</span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>        DepthRangeCB(),</span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>        TimeRangeCB(),</span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>        ZoteroCB(zotero_key, cfg<span class="op">=</span>cfg()),</span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>        KeyValuePairCB(<span class="st">'keywords'</span>, <span class="st">', '</span>.join(kw)),</span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>        KeyValuePairCB(<span class="st">'publisher_postprocess_logs'</span>, <span class="st">', '</span>.join(tfm.logs))</span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>        ])()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="c2e8aad3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>get_attrs(tfm, zotero_key<span class="op">=</span>zotero_key, kw<span class="op">=</span>kw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'geospatial_lat_min': '31.17',
 'geospatial_lat_max': '65.75',
 'geospatial_lon_min': '9.6333',
 'geospatial_lon_max': '53.5',
 'geospatial_bounds': 'POLYGON ((9.6333 53.5, 31.17 53.5, 31.17 65.75, 9.6333 65.75, 9.6333 53.5))',
 'geospatial_vertical_max': '437.0',
 'geospatial_vertical_min': '0.0',
 'time_coverage_start': '1984-01-10T00:00:00',
 'time_coverage_end': '2023-11-30T00:00:00',
 'id': '26VMZZ2Q',
 'title': 'Environmental database - Helsinki Commission Monitoring of Radioactive Substances',
 'summary': 'MORS Environment database has been used to collate data resulting from monitoring of environmental radioactivity in the Baltic Sea based on HELCOM Recommendation 26/3.\n\nThe database is structured according to HELCOM Guidelines on Monitoring of Radioactive Substances (https://www.helcom.fi/wp-content/uploads/2019/08/Guidelines-for-Monitoring-of-Radioactive-Substances.pdf), which specifies reporting format, database structure, data types and obligatory parameters used for reporting data under Recommendation 26/3.\n\nThe database is updated and quality assured annually by HELCOM MORS EG.',
 'creator_name': '[{"creatorType": "author", "name": "HELCOM MORS"}]',
 'keywords': 'oceanography, Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides, Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure, Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments, Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes, Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants, Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish, Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans, Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)',
 'publisher_postprocess_logs': "Convert 'nuclide' column values to lowercase, strip spaces, and store in 'NUCLIDE' column., Remap data provider nuclide names to standardized MARIS nuclide names., Standardize time format across all dataframes., Encode time as seconds since epoch., Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements., Sanitize measurement values by removing blanks and standardizing to use the `VALUE` column., Convert from relative error to standard uncertainty., Set the `unit` id column in the DataFrames based on a lookup table., Remap value type to MARIS format., Remap values from 'rubin' to 'SPECIES' for groups: BIOTA., Remap values from 'tissue' to 'BODY_PART' for groups: BIOTA., Remap values from 'SPECIES' to 'BIO_GROUP' for groups: BIOTA., Lookup sediment id using lookup table., Lookup filt value in dataframe using the lookup table., Generate a SMP_ID from the KEY values in the HELCOM dataset., Ensure depth values are floats and add 'SMP_DEPTH' and 'TOT_DEPTH' columns., Remap Sediment slice top and bottom to MARIS format., Lookup dry-wet ratio and format for MARIS., Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero., Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator."}</code></pre>
</div>
</div>
</section>
</section>
<section id="encoding-netcdf" class="level2">
<h2 class="anchored" data-anchor-id="encoding-netcdf"><a name="encoding-netcdf"></a>Encoding NetCDF</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L281" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="encode" class="level3">
<h3 class="anchored" data-anchor-id="encode">encode</h3>
<blockquote class="blockquote">
<pre><code> encode (fname_out:str, **kwargs)</code></pre>
</blockquote>
<p><em>Encode data to NetCDF.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fname_out</td>
<td>str</td>
<td>Output file name</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td><strong>Additional arguments</strong></td>
</tr>
</tbody>
</table>
<div id="1923236b-db58-4173-93ea-c416f5343eba" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode(</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>    fname_out: <span class="bu">str</span>, <span class="co"># Output file name</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs <span class="co"># Additional arguments</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Encode data to NetCDF."</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> load_data(src_dir)</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>    tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'NUCLIDE'</span>),</span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a>                            SplitSedimentValuesCB(coi_sediment),</span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(coi_val),       </span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(),</span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),                           </span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'rubin'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_tissues, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'tissue'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biogroup_from_biota, col_remap<span class="op">=</span><span class="st">'BIO_GROUP'</span>, col_src<span class="op">=</span><span class="st">'SPECIES'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a>                            RemapSedimentCB(fn_lut<span class="op">=</span>lut_sediments, replace_lut<span class="op">=</span>sed_replace_lut),</span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a>                            RemapFiltCB(lut_filtered),</span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a>                            AddSampleIDCB(),</span>
<span id="cb198-23"><a href="#cb198-23" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),</span>
<span id="cb198-24"><a href="#cb198-24" aria-hidden="true" tabindex="-1"></a>                            AddSalinityCB(),</span>
<span id="cb198-25"><a href="#cb198-25" aria-hidden="true" tabindex="-1"></a>                            AddTemperatureCB(),</span>
<span id="cb198-26"><a href="#cb198-26" aria-hidden="true" tabindex="-1"></a>                            RemapSedSliceTopBottomCB(),</span>
<span id="cb198-27"><a href="#cb198-27" aria-hidden="true" tabindex="-1"></a>                            LookupDryWetPercentWeightCB(),</span>
<span id="cb198-28"><a href="#cb198-28" aria-hidden="true" tabindex="-1"></a>                            ParseCoordinates(ddmm_to_dd),</span>
<span id="cb198-29"><a href="#cb198-29" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb198-30"><a href="#cb198-30" aria-hidden="true" tabindex="-1"></a>                            AddStationCB()</span>
<span id="cb198-31"><a href="#cb198-31" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb198-32"><a href="#cb198-32" aria-hidden="true" tabindex="-1"></a>    tfm()</span>
<span id="cb198-33"><a href="#cb198-33" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> NetCDFEncoder(tfm.dfs, </span>
<span id="cb198-34"><a href="#cb198-34" aria-hidden="true" tabindex="-1"></a>                            dest_fname<span class="op">=</span>fname_out, </span>
<span id="cb198-35"><a href="#cb198-35" aria-hidden="true" tabindex="-1"></a>                            global_attrs<span class="op">=</span>get_attrs(tfm, zotero_key<span class="op">=</span>zotero_key, kw<span class="op">=</span>kw),</span>
<span id="cb198-36"><a href="#cb198-36" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># custom_maps=tfm.custom_maps,</span></span>
<span id="cb198-37"><a href="#cb198-37" aria-hidden="true" tabindex="-1"></a>                            verbose<span class="op">=</span>kwargs.get(<span class="st">'verbose'</span>, <span class="va">False</span>),</span>
<span id="cb198-38"><a href="#cb198-38" aria-hidden="true" tabindex="-1"></a>                           )</span>
<span id="cb198-39"><a href="#cb198-39" aria-hidden="true" tabindex="-1"></a>    encoder.encode()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="6ec225f2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>encode(fname_out, verbose<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: 8 missing time value(s) in SEAWATER
Warning: 1 missing time value(s) in SEDIMENT</code></pre>
</div>
</div>
</section>
</section>
<section id="netcdf-review" class="level2">
<h2 class="anchored" data-anchor-id="netcdf-review">NetCDF Review</h2>
<p>First lets review the global attributes of the NetCDF file:</p>
<div id="bf26421e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>contents <span class="op">=</span> ExtractNetcdfContents(fname_out)</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents.global_attrs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': '26VMZZ2Q', 'title': 'Environmental database - Helsinki Commission Monitoring of Radioactive Substances', 'summary': 'MORS Environment database has been used to collate data resulting from monitoring of environmental radioactivity in the Baltic Sea based on HELCOM Recommendation 26/3.\n\nThe database is structured according to HELCOM Guidelines on Monitoring of Radioactive Substances (https://www.helcom.fi/wp-content/uploads/2019/08/Guidelines-for-Monitoring-of-Radioactive-Substances.pdf), which specifies reporting format, database structure, data types and obligatory parameters used for reporting data under Recommendation 26/3.\n\nThe database is updated and quality assured annually by HELCOM MORS EG.', 'keywords': 'oceanography, Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides, Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure, Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments, Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes, Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants, Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish, Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans, Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)', 'history': 'TBD', 'keywords_vocabulary': 'GCMD Science Keywords', 'keywords_vocabulary_url': 'https://gcmd.earthdata.nasa.gov/static/kms/', 'record': 'TBD', 'featureType': 'TBD', 'cdm_data_type': 'TBD', 'Conventions': 'CF-1.10 ACDD-1.3', 'publisher_name': 'Paul MCGINNITY, Iolanda OSVATH, Florence DESCROIX-COMANDUCCI', 'publisher_email': 'p.mc-ginnity@iaea.org, i.osvath@iaea.org, F.Descroix-Comanducci@iaea.org', 'publisher_url': 'https://maris.iaea.org', 'publisher_institution': 'International Atomic Energy Agency - IAEA', 'creator_name': '[{"creatorType": "author", "name": "HELCOM MORS"}]', 'institution': 'TBD', 'metadata_link': 'TBD', 'creator_email': 'TBD', 'creator_url': 'TBD', 'references': 'TBD', 'license': 'Without prejudice to the applicable Terms and Conditions (https://nucleus.iaea.org/Pages/Others/Disclaimer.aspx), I hereby agree that any use of the data will contain appropriate acknowledgement of the data source(s) and the IAEA Marine Radioactivity Information System (MARIS).', 'comment': 'TBD', 'geospatial_lat_min': '31.17', 'geospatial_lon_min': '9.6333', 'geospatial_lat_max': '65.75', 'geospatial_lon_max': '53.5', 'geospatial_vertical_min': '0.0', 'geospatial_vertical_max': '437.0', 'geospatial_bounds': 'POLYGON ((9.6333 53.5, 31.17 53.5, 31.17 65.75, 9.6333 65.75, 9.6333 53.5))', 'geospatial_bounds_crs': 'EPSG:4326', 'time_coverage_start': '1984-01-10T00:00:00', 'time_coverage_end': '2023-11-30T00:00:00', 'local_time_zone': 'TBD', 'date_created': 'TBD', 'date_modified': 'TBD', 'publisher_postprocess_logs': "Convert 'nuclide' column values to lowercase, strip spaces, and store in 'NUCLIDE' column., Remap data provider nuclide names to standardized MARIS nuclide names., Standardize time format across all dataframes., Encode time as seconds since epoch., Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements., Sanitize measurement values by removing blanks and standardizing to use the `VALUE` column., Convert from relative error to standard uncertainty., Set the `unit` id column in the DataFrames based on a lookup table., Remap value type to MARIS format., Remap values from 'rubin' to 'SPECIES' for groups: BIOTA., Remap values from 'tissue' to 'BODY_PART' for groups: BIOTA., Remap values from 'SPECIES' to 'BIO_GROUP' for groups: BIOTA., Lookup sediment id using lookup table., Lookup filt value in dataframe using the lookup table., Generate a SMP_ID from the KEY values in the HELCOM dataset., Ensure depth values are floats and add 'SMP_DEPTH' and 'TOT_DEPTH' columns., Remap Sediment slice top and bottom to MARIS format., Lookup dry-wet ratio and format for MARIS., Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero., Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator., Add station to all DataFrames."}</code></pre>
</div>
</div>
<p>Review the publisher_postprocess_logs.</p>
<div id="81834ece" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents.global_attrs[<span class="st">'publisher_postprocess_logs'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Convert 'nuclide' column values to lowercase, strip spaces, and store in 'NUCLIDE' column., Remap data provider nuclide names to standardized MARIS nuclide names., Standardize time format across all dataframes., Encode time as seconds since epoch., Separate sediment entries into distinct rows for Bq/kg and Bq/m² measurements., Sanitize measurement values by removing blanks and standardizing to use the `VALUE` column., Convert from relative error to standard uncertainty., Set the `unit` id column in the DataFrames based on a lookup table., Remap value type to MARIS format., Remap values from 'rubin' to 'SPECIES' for groups: BIOTA., Remap values from 'tissue' to 'BODY_PART' for groups: BIOTA., Remap values from 'SPECIES' to 'BIO_GROUP' for groups: BIOTA., Lookup sediment id using lookup table., Lookup filt value in dataframe using the lookup table., Generate a SMP_ID from the KEY values in the HELCOM dataset., Ensure depth values are floats and add 'SMP_DEPTH' and 'TOT_DEPTH' columns., Remap Sediment slice top and bottom to MARIS format., Lookup dry-wet ratio and format for MARIS., Get geographical coordinates from columns expressed in degrees decimal format or from columns in degrees/minutes decimal format where degrees decimal format is missing or zero., Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator., Add station to all DataFrames.</code></pre>
</div>
</div>
<p>Now lets review the enums of the groups in the NetCDF file:</p>
<div id="fcb5de49" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Example of enum_dicts:'</span>)</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents.enum_dicts[<span class="st">'BIOTA'</span>][<span class="st">'bio_group'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Example of enum_dicts:
{'Not applicable': '-1', 'Not available': '0', 'Birds': '1', 'Crustaceans': '2', 'Echinoderms': '3', 'Fish': '4', 'Mammals': '5', 'Molluscs': '6', 'Others': '7', 'Plankton': '8', 'Polychaete worms': '9', 'Reptile': '10', 'Seaweeds and plants': '11', 'Cephalopods': '12', 'Gastropods': '13', 'Bivalves': '14'}</code></pre>
</div>
</div>
<p>Lets return the data contained in the NetCDF file:</p>
<div id="df252c33" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> contents.dfs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lets review the biota data:</p>
<div id="29a8f17c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>nc_dfs_biota<span class="op">=</span>dfs[<span class="st">'BIOTA'</span>]</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    display(nc_dfs_biota)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">TIME</th>
<th data-quarto-table-cell-role="th">STATION</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">NUCLIDE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">DL</th>
<th data-quarto-table-cell-role="th">BIO_GROUP</th>
<th data-quarto-table-cell-role="th">SPECIES</th>
<th data-quarto-table-cell-role="th">BODY_PART</th>
<th data-quarto-table-cell-role="th">DRYWT</th>
<th data-quarto-table-cell-role="th">WETWT</th>
<th data-quarto-table-cell-role="th">PERCENTWT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>BVTIG2012041</td>
<td>12.316667</td>
<td>54.283333</td>
<td>NaN</td>
<td>1348358400</td>
<td>SD24</td>
<td>1</td>
<td>31</td>
<td>0.010140</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>4</td>
<td>99</td>
<td>52</td>
<td>174.934433</td>
<td>948.0</td>
<td>0.18453</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>BVTIG2012041</td>
<td>12.316667</td>
<td>54.283333</td>
<td>NaN</td>
<td>1348358400</td>
<td>SD24</td>
<td>2</td>
<td>4</td>
<td>135.300003</td>
<td>5</td>
<td>4.830210</td>
<td>1</td>
<td>4</td>
<td>99</td>
<td>52</td>
<td>174.934433</td>
<td>948.0</td>
<td>0.18453</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>BVTIG2012041</td>
<td>12.316667</td>
<td>54.283333</td>
<td>NaN</td>
<td>1348358400</td>
<td>SD24</td>
<td>3</td>
<td>9</td>
<td>0.013980</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>4</td>
<td>99</td>
<td>52</td>
<td>174.934433</td>
<td>948.0</td>
<td>0.18453</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>BVTIG2012041</td>
<td>12.316667</td>
<td>54.283333</td>
<td>NaN</td>
<td>1348358400</td>
<td>SD24</td>
<td>4</td>
<td>33</td>
<td>4.338000</td>
<td>5</td>
<td>0.150962</td>
<td>1</td>
<td>4</td>
<td>99</td>
<td>52</td>
<td>174.934433</td>
<td>948.0</td>
<td>0.18453</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>BVTIG2012040</td>
<td>12.316667</td>
<td>54.283333</td>
<td>NaN</td>
<td>1348358400</td>
<td>SD24</td>
<td>5</td>
<td>31</td>
<td>0.009614</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>4</td>
<td>99</td>
<td>52</td>
<td>177.935120</td>
<td>964.0</td>
<td>0.18458</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16089</th>
<td>BSTUK2022010</td>
<td>21.395000</td>
<td>61.241501</td>
<td>2.0</td>
<td>1652140800</td>
<td>OLKB</td>
<td>16090</td>
<td>33</td>
<td>13.700000</td>
<td>4</td>
<td>0.520600</td>
<td>1</td>
<td>11</td>
<td>96</td>
<td>55</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16090</th>
<td>BSTUK2022010</td>
<td>21.395000</td>
<td>61.241501</td>
<td>2.0</td>
<td>1652140800</td>
<td>OLKB</td>
<td>16091</td>
<td>9</td>
<td>0.500000</td>
<td>4</td>
<td>0.045500</td>
<td>1</td>
<td>11</td>
<td>96</td>
<td>55</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16091</th>
<td>BSTUK2022011</td>
<td>21.385000</td>
<td>61.343334</td>
<td>NaN</td>
<td>1663200000</td>
<td>OLKC</td>
<td>16092</td>
<td>4</td>
<td>50.700001</td>
<td>4</td>
<td>4.106700</td>
<td>1</td>
<td>14</td>
<td>129</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16092</th>
<td>BSTUK2022011</td>
<td>21.385000</td>
<td>61.343334</td>
<td>NaN</td>
<td>1663200000</td>
<td>OLKC</td>
<td>16093</td>
<td>33</td>
<td>0.880000</td>
<td>4</td>
<td>0.140800</td>
<td>1</td>
<td>14</td>
<td>129</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16093</th>
<td>BSTUK2022011</td>
<td>21.385000</td>
<td>61.343334</td>
<td>NaN</td>
<td>1663200000</td>
<td>OLKC</td>
<td>16094</td>
<td>12</td>
<td>6.600000</td>
<td>4</td>
<td>0.349800</td>
<td>1</td>
<td>14</td>
<td>129</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>16094 rows × 18 columns</p>
</div>
</div>
</div>
<p>Lets review the sediment data:</p>
<div id="1e068f27" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>nc_dfs_sediment <span class="op">=</span> dfs[<span class="st">'SEDIMENT'</span>]</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    display(nc_dfs_sediment)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">TOT_DEPTH</th>
<th data-quarto-table-cell-role="th">TIME</th>
<th data-quarto-table-cell-role="th">STATION</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">NUCLIDE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">DL</th>
<th data-quarto-table-cell-role="th">SED_TYPE</th>
<th data-quarto-table-cell-role="th">TOP</th>
<th data-quarto-table-cell-role="th">BOTTOM</th>
<th data-quarto-table-cell-role="th">PERCENTWT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>SKRIL2012116</td>
<td>27.799999</td>
<td>60.466667</td>
<td>25.0</td>
<td>1337904000</td>
<td>RU99</td>
<td>1</td>
<td>33</td>
<td>1200.000000</td>
<td>3</td>
<td>240.000000</td>
<td>1</td>
<td>0</td>
<td>15.0</td>
<td>20.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>SKRIL2012117</td>
<td>27.799999</td>
<td>60.466667</td>
<td>25.0</td>
<td>1337904000</td>
<td>RU99</td>
<td>2</td>
<td>33</td>
<td>250.000000</td>
<td>3</td>
<td>50.000000</td>
<td>1</td>
<td>0</td>
<td>20.0</td>
<td>25.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>SKRIL2012118</td>
<td>27.799999</td>
<td>60.466667</td>
<td>25.0</td>
<td>1337904000</td>
<td>RU99</td>
<td>3</td>
<td>33</td>
<td>140.000000</td>
<td>3</td>
<td>29.400000</td>
<td>1</td>
<td>0</td>
<td>25.0</td>
<td>30.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>SKRIL2012119</td>
<td>27.799999</td>
<td>60.466667</td>
<td>25.0</td>
<td>1337904000</td>
<td>RU99</td>
<td>4</td>
<td>33</td>
<td>79.000000</td>
<td>3</td>
<td>15.800000</td>
<td>1</td>
<td>0</td>
<td>30.0</td>
<td>35.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>SKRIL2012120</td>
<td>27.799999</td>
<td>60.466667</td>
<td>25.0</td>
<td>1337904000</td>
<td>RU99</td>
<td>5</td>
<td>33</td>
<td>29.000000</td>
<td>3</td>
<td>6.960000</td>
<td>1</td>
<td>0</td>
<td>35.0</td>
<td>40.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">70444</th>
<td>SCLOR2022071</td>
<td>15.537800</td>
<td>54.617832</td>
<td>62.0</td>
<td>1654646400</td>
<td>P39Z</td>
<td>70445</td>
<td>67</td>
<td>0.044000</td>
<td>2</td>
<td>0.015312</td>
<td>1</td>
<td>10</td>
<td>15.0</td>
<td>17.0</td>
<td>0.257642</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">70445</th>
<td>SCLOR2022071</td>
<td>15.537800</td>
<td>54.617832</td>
<td>62.0</td>
<td>1654646400</td>
<td>P39Z</td>
<td>70446</td>
<td>77</td>
<td>2.500000</td>
<td>2</td>
<td>0.185000</td>
<td>1</td>
<td>10</td>
<td>15.0</td>
<td>17.0</td>
<td>0.257642</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">70446</th>
<td>SCLOR2022072</td>
<td>15.537800</td>
<td>54.617832</td>
<td>62.0</td>
<td>1654646400</td>
<td>P39Z</td>
<td>70447</td>
<td>4</td>
<td>5873.000000</td>
<td>2</td>
<td>164.444000</td>
<td>1</td>
<td>10</td>
<td>17.0</td>
<td>19.0</td>
<td>0.263965</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">70447</th>
<td>SCLOR2022072</td>
<td>15.537800</td>
<td>54.617832</td>
<td>62.0</td>
<td>1654646400</td>
<td>P39Z</td>
<td>70448</td>
<td>33</td>
<td>21.200001</td>
<td>2</td>
<td>2.162400</td>
<td>1</td>
<td>10</td>
<td>17.0</td>
<td>19.0</td>
<td>0.263965</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">70448</th>
<td>SCLOR2022072</td>
<td>15.537800</td>
<td>54.617832</td>
<td>62.0</td>
<td>1654646400</td>
<td>P39Z</td>
<td>70449</td>
<td>77</td>
<td>0.370000</td>
<td>2</td>
<td>0.048100</td>
<td>1</td>
<td>10</td>
<td>17.0</td>
<td>19.0</td>
<td>0.263965</td>
</tr>
</tbody>
</table>

<p>70449 rows × 16 columns</p>
</div>
</div>
</div>
<p>Lets review the seawater data:</p>
<div id="5298fb89" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>nc_dfs_seawater <span class="op">=</span> dfs[<span class="st">'SEAWATER'</span>]</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>    display(nc_dfs_seawater)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">TOT_DEPTH</th>
<th data-quarto-table-cell-role="th">TIME</th>
<th data-quarto-table-cell-role="th">STATION</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">NUCLIDE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">DL</th>
<th data-quarto-table-cell-role="th">FILT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WKRIL2012003</td>
<td>29.333300</td>
<td>60.083302</td>
<td>0.0</td>
<td>NaN</td>
<td>1337731200</td>
<td>RU10</td>
<td>1</td>
<td>33</td>
<td>5.300000</td>
<td>1</td>
<td>1.696000</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WKRIL2012004</td>
<td>29.333300</td>
<td>60.083302</td>
<td>29.0</td>
<td>NaN</td>
<td>1337731200</td>
<td>RU10</td>
<td>2</td>
<td>33</td>
<td>19.900000</td>
<td>1</td>
<td>3.980000</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>WKRIL2012005</td>
<td>23.150000</td>
<td>59.433300</td>
<td>0.0</td>
<td>NaN</td>
<td>1339891200</td>
<td>RU11</td>
<td>3</td>
<td>33</td>
<td>25.500000</td>
<td>1</td>
<td>5.100000</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>WKRIL2012006</td>
<td>27.983299</td>
<td>60.250000</td>
<td>0.0</td>
<td>NaN</td>
<td>1337817600</td>
<td>RU19</td>
<td>4</td>
<td>33</td>
<td>17.000000</td>
<td>1</td>
<td>4.930000</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>WKRIL2012007</td>
<td>27.983299</td>
<td>60.250000</td>
<td>39.0</td>
<td>NaN</td>
<td>1337817600</td>
<td>RU19</td>
<td>5</td>
<td>33</td>
<td>22.200001</td>
<td>1</td>
<td>3.996000</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21468</th>
<td>WDHIG2023112</td>
<td>13.499833</td>
<td>54.600334</td>
<td>0.0</td>
<td>47.0</td>
<td>1686441600</td>
<td>WITTOW</td>
<td>21469</td>
<td>1</td>
<td>702.838074</td>
<td>1</td>
<td>51.276207</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21469</th>
<td>WDHIG2023113</td>
<td>13.499833</td>
<td>54.600334</td>
<td>45.0</td>
<td>47.0</td>
<td>1686441600</td>
<td>WITTOW</td>
<td>21470</td>
<td>1</td>
<td>725.855713</td>
<td>1</td>
<td>52.686260</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21470</th>
<td>WDHIG2023143</td>
<td>14.200833</td>
<td>54.600334</td>
<td>0.0</td>
<td>11.0</td>
<td>1686614400</td>
<td>ODER</td>
<td>21471</td>
<td>1</td>
<td>648.992920</td>
<td>1</td>
<td>48.154419</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21471</th>
<td>WDHIG2023145</td>
<td>14.665500</td>
<td>54.600334</td>
<td>0.0</td>
<td>20.0</td>
<td>1686614400</td>
<td>OBANK</td>
<td>21472</td>
<td>1</td>
<td>627.178406</td>
<td>1</td>
<td>46.245316</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">21472</th>
<td>WDHIG2023147</td>
<td>14.330000</td>
<td>54.600334</td>
<td>0.0</td>
<td>17.0</td>
<td>1686614400</td>
<td>ADLERG</td>
<td>21473</td>
<td>1</td>
<td>605.715088</td>
<td>1</td>
<td>45.691143</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>21473 rows × 14 columns</p>
</div>
</div>
</div>
</section>
<section id="data-format-conversion" class="level2">
<h2 class="anchored" data-anchor-id="data-format-conversion">Data Format Conversion</h2>
<p>The MARIS data processing workflow involves two key steps:</p>
<ol type="1">
<li><strong>NetCDF to Standardized CSV Compatible with OpenRefine Pipeline</strong>
<ul>
<li>Convert standardized NetCDF files to CSV formats compatible with OpenRefine using the <a href="https://franckalbinet.github.io/marisco/api/decoders.html#netcdfdecoder"><code>NetCDFDecoder</code></a>.</li>
<li>Preserve data integrity and variable relationships.</li>
<li>Maintain standardized nomenclature and units.</li>
</ul></li>
<li><strong>Database Integration</strong>
<ul>
<li>Process the converted CSV files using OpenRefine.</li>
<li>Apply data cleaning and standardization rules.</li>
<li>Export validated data to the MARIS master database.</li>
</ul></li>
</ol>
<p>This section focuses on the first step: converting NetCDF files to a format suitable for OpenRefine processing using the <a href="https://franckalbinet.github.io/marisco/api/decoders.html#netcdfdecoder"><code>NetCDFDecoder</code></a> class.</p>
<div id="11e5903c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>decode(fname_in<span class="op">=</span>fname_out, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved BIOTA to ../../_data/output/100-HELCOM-MORS-2024_BIOTA.csv
Saved SEAWATER to ../../_data/output/100-HELCOM-MORS-2024_SEAWATER.csv
Saved SEDIMENT to ../../_data/output/100-HELCOM-MORS-2024_SEDIMENT.csv</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/franckalbinet\.github\.io\/marisco");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/franckalbinet/marisco/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>
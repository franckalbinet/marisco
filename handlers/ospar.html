<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>OSPAR – marisco</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-cd333c7267348b54b15a9ec2a617d176.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="OSPAR – marisco">
<meta property="og:description" content="MARIS companion package and tutorials">
<meta property="og:site_name" content="marisco">
<meta name="twitter:title" content="OSPAR – marisco">
<meta name="twitter:description" content="MARIS companion package and tutorials">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">marisco</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/franckalbinet/marisco"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../handlers/helcom.html">Handlers</a></li><li class="breadcrumb-item"><a href="../handlers/ospar.html">OSPAR</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MARISCO</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Handlers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/helcom.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">HELCOM</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/ospar.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">OSPAR</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/geotraces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geotraces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/maris_legacy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MARIS Legacy</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../handlers/tepco.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TEPCO</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">API</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/configs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Configs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/metadata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metadata</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/encoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Encoders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/decoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Decoders</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../api/netcdf2csv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NetCDF2CSV</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Metadata</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../metadata/data-curation-rules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data curation rules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../metadata/field-definition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Field definitions</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#configuration-and-file-paths" id="toc-configuration-and-file-paths" class="nav-link active" data-scroll-target="#configuration-and-file-paths">Configuration and File Paths</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a>
  <ul>
  <li><a href="#read_csv" id="toc-read_csv" class="nav-link" data-scroll-target="#read_csv">read_csv</a></li>
  <li><a href="#load_data" id="toc-load_data" class="nav-link" data-scroll-target="#load_data">load_data</a></li>
  </ul></li>
  <li><a href="#remove-missing-values" id="toc-remove-missing-values" class="nav-link" data-scroll-target="#remove-missing-values">Remove Missing Values</a></li>
  <li><a href="#nuclide-name-normalization" id="toc-nuclide-name-normalization" class="nav-link" data-scroll-target="#nuclide-name-normalization">Nuclide Name Normalization</a>
  <ul>
  <li><a href="#lower-strip-nuclide-names" id="toc-lower-strip-nuclide-names" class="nav-link" data-scroll-target="#lower-strip-nuclide-names">Lower &amp; strip nuclide names</a></li>
  <li><a href="#remap-nuclide-names-to-maris-data-formats" id="toc-remap-nuclide-names-to-maris-data-formats" class="nav-link" data-scroll-target="#remap-nuclide-names-to-maris-data-formats">Remap nuclide names to MARIS data formats</a></li>
  <li><a href="#remapnuclidenamecb" id="toc-remapnuclidenamecb" class="nav-link" data-scroll-target="#remapnuclidenamecb">RemapNuclideNameCB</a></li>
  </ul></li>
  <li><a href="#standardize-time" id="toc-standardize-time" class="nav-link" data-scroll-target="#standardize-time">Standardize Time</a>
  <ul>
  <li><a href="#parsetimecb" id="toc-parsetimecb" class="nav-link" data-scroll-target="#parsetimecb">ParseTimeCB</a></li>
  </ul></li>
  <li><a href="#sanitize-value" id="toc-sanitize-value" class="nav-link" data-scroll-target="#sanitize-value">Sanitize value</a>
  <ul>
  <li><a href="#sanitizevaluecb" id="toc-sanitizevaluecb" class="nav-link" data-scroll-target="#sanitizevaluecb">SanitizeValueCB</a></li>
  </ul></li>
  <li><a href="#normalize-uncertainty" id="toc-normalize-uncertainty" class="nav-link" data-scroll-target="#normalize-uncertainty">Normalize uncertainty</a>
  <ul>
  <li><a href="#normalizeunccb" id="toc-normalizeunccb" class="nav-link" data-scroll-target="#normalizeunccb">NormalizeUncCB</a></li>
  </ul></li>
  <li><a href="#remap-units" id="toc-remap-units" class="nav-link" data-scroll-target="#remap-units">Remap units</a>
  <ul>
  <li><a href="#remapunitcb" id="toc-remapunitcb" class="nav-link" data-scroll-target="#remapunitcb">RemapUnitCB</a></li>
  </ul></li>
  <li><a href="#remap-detection-limit" id="toc-remap-detection-limit" class="nav-link" data-scroll-target="#remap-detection-limit">Remap detection limit</a>
  <ul>
  <li><a href="#remapdetectionlimitcb" id="toc-remapdetectionlimitcb" class="nav-link" data-scroll-target="#remapdetectionlimitcb">RemapDetectionLimitCB</a></li>
  </ul></li>
  <li><a href="#remap-biota-species" id="toc-remap-biota-species" class="nav-link" data-scroll-target="#remap-biota-species">Remap Biota species</a></li>
  <li><a href="#enhance-species-data-using-biological-group." id="toc-enhance-species-data-using-biological-group." class="nav-link" data-scroll-target="#enhance-species-data-using-biological-group.">Enhance Species Data Using Biological group.</a>
  <ul>
  <li><a href="#enhancespeciescb" id="toc-enhancespeciescb" class="nav-link" data-scroll-target="#enhancespeciescb">EnhanceSpeciesCB</a></li>
  </ul></li>
  <li><a href="#remap-biota-tissues" id="toc-remap-biota-tissues" class="nav-link" data-scroll-target="#remap-biota-tissues">Remap Biota tissues</a>
  <ul>
  <li><a href="#addbodyparttempcb" id="toc-addbodyparttempcb" class="nav-link" data-scroll-target="#addbodyparttempcb">AddBodypartTempCB</a></li>
  </ul></li>
  <li><a href="#remap-biogroup" id="toc-remap-biogroup" class="nav-link" data-scroll-target="#remap-biogroup">Remap biogroup</a></li>
  <li><a href="#add-sample-id" id="toc-add-sample-id" class="nav-link" data-scroll-target="#add-sample-id">Add Sample ID</a>
  <ul>
  <li><a href="#addsampleidcb" id="toc-addsampleidcb" class="nav-link" data-scroll-target="#addsampleidcb">AddSampleIdCB</a></li>
  </ul></li>
  <li><a href="#add-depth" id="toc-add-depth" class="nav-link" data-scroll-target="#add-depth">Add depth</a>
  <ul>
  <li><a href="#adddepthcb" id="toc-adddepthcb" class="nav-link" data-scroll-target="#adddepthcb">AddDepthCB</a></li>
  </ul></li>
  <li><a href="#standardize-coordinates" id="toc-standardize-coordinates" class="nav-link" data-scroll-target="#standardize-coordinates">Standardize Coordinates</a>
  <ul>
  <li><a href="#convertlonlatcb" id="toc-convertlonlatcb" class="nav-link" data-scroll-target="#convertlonlatcb">ConvertLonLatCB</a></li>
  </ul></li>
  <li><a href="#add-station" id="toc-add-station" class="nav-link" data-scroll-target="#add-station">Add Station</a>
  <ul>
  <li><a href="#addstationcb" id="toc-addstationcb" class="nav-link" data-scroll-target="#addstationcb">AddStationCB</a></li>
  </ul></li>
  <li><a href="#review-all-callbacks" id="toc-review-all-callbacks" class="nav-link" data-scroll-target="#review-all-callbacks">Review all callbacks</a>
  <ul>
  <li><a href="#example-change-logs" id="toc-example-change-logs" class="nav-link" data-scroll-target="#example-change-logs">Example change logs</a></li>
  </ul></li>
  <li><a href="#feed-global-attributes" id="toc-feed-global-attributes" class="nav-link" data-scroll-target="#feed-global-attributes">Feed global attributes</a>
  <ul>
  <li><a href="#get_attrs" id="toc-get_attrs" class="nav-link" data-scroll-target="#get_attrs">get_attrs</a></li>
  </ul></li>
  <li><a href="#encoding-netcdf" id="toc-encoding-netcdf" class="nav-link" data-scroll-target="#encoding-netcdf">Encoding NETCDF</a>
  <ul>
  <li><a href="#encode" id="toc-encode" class="nav-link" data-scroll-target="#encode">encode</a></li>
  </ul></li>
  <li><a href="#netcdf-review" id="toc-netcdf-review" class="nav-link" data-scroll-target="#netcdf-review">NetCDF Review</a></li>
  <li><a href="#data-format-conversion" id="toc-data-format-conversion" class="nav-link" data-scroll-target="#data-format-conversion">Data Format Conversion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/franckalbinet/marisco/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../handlers/helcom.html">Handlers</a></li><li class="breadcrumb-item"><a href="../handlers/ospar.html">OSPAR</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">OSPAR</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<blockquote class="blockquote">
<p>This data pipeline, known as a “handler” in Marisco terminology, is designed to clean, standardize, and encode <a href="https://odims.ospar.org/en/">OSPAR data</a> into <code>NetCDF</code> format. The handler processes raw OSPAR data, applying various transformations and lookups to align it with <code>MARIS</code> data standards.</p>
</blockquote>
<p>Key functions of this handler:</p>
<ul>
<li><strong>Cleans</strong> and <strong>normalizes</strong> raw OSPAR data</li>
<li><strong>Applies standardized nomenclature</strong> and units</li>
<li><strong>Encodes the processed data</strong> into <code>NetCDF</code> format compatible with MARIS requirements</li>
</ul>
<p>This handler is a crucial component in the Marisco data processing workflow, ensuring OSPAR data is properly integrated into the MARIS database.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Getting Started
</div>
</div>
<div class="callout-body-container callout-body">
<p>For new MARIS users, please refer to <a href="https://github.com/franckalbinet/marisco/tree/main/install_configure_guide">Understanding MARIS Data Formats (NetCDF and Open Refine)</a> for detailed information.</p>
</div>
</div>
<p>The present notebook pretends to be an instance of <a href="https://www.wikiwand.com/en/articles/Literate_programming">Literate Programming</a> in the sense that it is a narrative that includes code snippets that are interspersed with explanations. When a function or a class needs to be exported in a dedicated python module (in our case <code>marisco/handlers/ospar.py</code>) the code snippet is added to the module using <code>#| export</code> as provided by the wonderful <a href="https://nbdev.fast.ai/getting_started.html">nbdev</a> library.</p>
<section id="configuration-and-file-paths" class="level2">
<h2 class="anchored" data-anchor-id="configuration-and-file-paths">Configuration and File Paths</h2>
<p>The handler requires several configuration parameters:</p>
<ol type="1">
<li><strong>src_dir</strong>: path to the maris-crawlers folder containing the OSPAR data in CSV format</li>
<li><strong>fname_out</strong>: Output path and filename for <code>NetCDF</code> file (relative paths supported)</li>
<li><strong>zotero_key</strong>: Key for retrieving dataset attributes from <a href="https://www.zotero.org/">Zotero</a></li>
</ol>
<div id="715e849d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>src_dir <span class="op">=</span> <span class="st">'https://raw.githubusercontent.com/franckalbinet/maris-crawlers/refs/heads/main/data/processed/OSPAR'</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>fname_out <span class="op">=</span> <span class="st">'../../_data/output/191-OSPAR-2024.nc'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>zotero_key <span class="op">=</span><span class="st">'LQRA4MMK'</span> <span class="co"># OSPAR MORS zotero key</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<p><a href="https://odims.ospar.org/en/submissions/">OSPAR data</a> is provided as a zipped Microsoft Access database. To facilitate easier access and integration, we process this dataset and convert it into <code>.csv</code> files. These processed files are then made available in the <a href="https://github.com/franckalbinet/maris-crawlers/tree/main/data/processed/OSPAR">maris-crawlers repository</a> on GitHub. Once converted, the dataset is in a format that is readily compatible with the <a href="https://github.com/franckalbinet/marisco">marisco</a> data pipeline, ensuring seamless data handling and analysis.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L82" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="read_csv" class="level3">
<h3 class="anchored" data-anchor-id="read_csv">read_csv</h3>
<blockquote class="blockquote">
<pre><code> read_csv (file_name,
           dir='https://raw.githubusercontent.com/franckalbinet/maris-
           crawlers/refs/heads/main/data/processed/OSPAR')</code></pre>
</blockquote>
<div id="1c47af7c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>default_smp_types <span class="op">=</span> {  </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Biota'</span>: <span class="st">'BIOTA'</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Seawater'</span>: <span class="st">'SEAWATER'</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="ee9fb2ee" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_csv(file_name, <span class="bu">dir</span><span class="op">=</span>src_dir):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    file_path <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">dir</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.read_csv(file_path)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L87" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="load_data" class="level3">
<h3 class="anchored" data-anchor-id="load_data">load_data</h3>
<blockquote class="blockquote">
<pre><code> load_data (src_url:str, smp_types:dict={'Biota': 'BIOTA', 'Seawater':
            'SEAWATER'}, use_cache:bool=False, save_to_cache:bool=False,
            verbose:bool=False)</code></pre>
</blockquote>
<p><em>Load OSPAR data and return the data in a dictionary of dataframes with the dictionary key as the sample type.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>src_url</td>
<td>str</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>smp_types</td>
<td>dict</td>
<td>{‘Biota’: ‘BIOTA’, ‘Seawater’: ‘SEAWATER’}</td>
<td>Sample types to load</td>
</tr>
<tr class="odd">
<td>use_cache</td>
<td>bool</td>
<td>False</td>
<td>Use cache</td>
</tr>
<tr class="even">
<td>save_to_cache</td>
<td>bool</td>
<td>False</td>
<td>Save to cache</td>
</tr>
<tr class="odd">
<td>verbose</td>
<td>bool</td>
<td>False</td>
<td>Verbose</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>Dict</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div id="a2bf13a1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_data(src_url: <span class="bu">str</span>, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>              smp_types: <span class="bu">dict</span> <span class="op">=</span> default_smp_types, <span class="co"># Sample types to load</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>              use_cache: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>, <span class="co"># Use cache</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>              save_to_cache: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>, <span class="co"># Save to cache</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>              verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span> <span class="co"># Verbose</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>              ) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, pd.DataFrame]:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Load OSPAR data and return the data in a dictionary of dataframes with the dictionary key as the sample type."</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_file_path(url: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">"Safely encode spaces in a URL."</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> url.replace(<span class="st">" "</span>, <span class="st">"%20"</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_file_path(dir_path: <span class="bu">str</span>, file_prefix: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Construct the full file path based on directory and file prefix."""</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        file_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>dir_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss"> data.csv"</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> safe_file_path(file_path) <span class="cf">if</span> <span class="kw">not</span> use_cache <span class="cf">else</span> file_path</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load_and_process_csv(file_path: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load a CSV file and process it."""</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> use_cache <span class="kw">and</span> <span class="kw">not</span> Path(file_path).exists():</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose:</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss"> not found in cache."</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            start_time <span class="op">=</span> time.time()</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_csv(file_path)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            df.columns <span class="op">=</span> df.columns.<span class="bu">str</span>.lower()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Data loaded from </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start_time<span class="sc">:.2f}</span><span class="ss"> seconds."</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> df</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> verbose:</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Failed to load </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save_to_cache_dir(df: pd.DataFrame, file_prefix: <span class="bu">str</span>):</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Save the DataFrame to the cache directory."""</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        cache_dir <span class="op">=</span> cache_path()</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        cache_file_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>cache_dir<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>file_prefix<span class="sc">}</span><span class="ss"> data.csv"</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        df.to_csv(cache_file_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> verbose:</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Data saved to cache at </span><span class="sc">{</span>cache_file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {}</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_prefix, smp_type <span class="kw">in</span> smp_types.items():</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        dir_path <span class="op">=</span> cache_path() <span class="cf">if</span> use_cache <span class="cf">else</span> src_url</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        file_path <span class="op">=</span> get_file_path(dir_path, file_prefix)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> load_and_process_csv(file_path)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> save_to_cache <span class="kw">and</span> <span class="kw">not</span> df.empty:</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            save_to_cache_dir(df, file_prefix)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        data[smp_type] <span class="op">=</span> df</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="e564b0ab" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, save_to_cache<span class="op">=</span><span class="va">True</span>, verbose<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9a235bb3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEAWATER'</span>].columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Index(['id', 'contracting party', 'rsc sub-division', 'station id',
       'sample id', 'latd', 'latm', 'lats', 'latdir', 'longd', 'longm',
       'longs', 'longdir', 'sample type', 'sampling depth', 'sampling date',
       'nuclide', 'value type', 'activity or mda', 'uncertainty', 'unit',
       'data provider', 'measurement comment', 'sample comment',
       'reference comment'],
      dtype='object')</code></pre>
</div>
</div>
</section>
</section>
<section id="remove-missing-values" class="level2">
<h2 class="anchored" data-anchor-id="remove-missing-values">Remove Missing Values</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>We consider records are incomplete if either the <code>activity or mda</code> field or the <code>sampling date</code> field is empty. These are the two key criteria we use to identify missing data.</p>
<p>As shown below: 10 rows are missing the <code>sampling date</code> and 10 rows are missing the <code>activity or mda</code> field.</p>
</div>
</div>
<div id="56d05cea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Missing sampling date: </span><span class="sc">{</span>dfs[<span class="st">"SEAWATER"</span>][<span class="st">"sampling date"</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Missing activity or mda: </span><span class="sc">{</span>dfs[<span class="st">"SEAWATER"</span>][<span class="st">"activity or mda"</span>]<span class="sc">.</span>isnull()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'SEAWATER'</span>][dfs[<span class="st">'SEAWATER'</span>][<span class="st">'sampling date'</span>].isnull()].sample(<span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Missing sampling date: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Missing activity or mda: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">rsc sub-division</th>
<th data-quarto-table-cell-role="th">station id</th>
<th data-quarto-table-cell-role="th">sample id</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">sampling date</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">value type</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">data provider</th>
<th data-quarto-table-cell-role="th">measurement comment</th>
<th data-quarto-table-cell-role="th">sample comment</th>
<th data-quarto-table-cell-role="th">reference comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">19191</th>
<td>120367</td>
<td>Ireland</td>
<td>4.0</td>
<td>N9</td>
<td>NaN</td>
<td>53</td>
<td>53.0</td>
<td>0.0</td>
<td>N</td>
<td>5</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2021 data</td>
<td>The Irish Navy attempted a few times to collec...</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16161</th>
<td>120369</td>
<td>Ireland</td>
<td>1.0</td>
<td>Salthill</td>
<td>NaN</td>
<td>53</td>
<td>15.0</td>
<td>40.0</td>
<td>N</td>
<td>9</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2021 data</td>
<td>Woodstown (County Waterford) and Salthill (Cou...</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>2 rows × 25 columns</p>
</div>
</div>
</div>
<p>To quickly remove all missing values, we can use the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#removeallnavaluescb"><code>RemoveAllNAValuesCB</code></a> callback.</p>
<div id="9da8fdb8" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>nan_cols_to_check <span class="op">=</span> [<span class="st">'sampling date'</span>, <span class="st">'activity or mda'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="fdf5133d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs <span class="op">=</span> [</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check)])</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>dfs_out <span class="op">=</span> tfm()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we can see that the <code>sampling date</code> and <code>activity or mda</code> columns have no missing values.</p>
<div id="202ed763" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(dfs_out[<span class="st">'SEAWATER'</span>][dfs[<span class="st">'SEAWATER'</span>][<span class="st">'sampling date'</span>].isnull()])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0</code></pre>
</div>
</div>
</section>
<section id="nuclide-name-normalization" class="level2">
<h2 class="anchored" data-anchor-id="nuclide-name-normalization">Nuclide Name Normalization</h2>
<p>We must standardize the nuclide names in the <code>OSPAR</code> dataset to align with the standardized names provided in the <code>MARISCO</code> lookup table. The lookup process utilizes three key columns: - <code>nuclide_id</code>: This serves as a unique identifier for each nuclide - <code>nuclide</code>: Represents the standardized name of the nuclide as per our conventions - <code>nc_name</code>: Denotes the corresponding name used in <code>NetCDF</code> files</p>
<p>Below, we will examine the structure and contents of the lookup table:</p>
<div id="fa95e33f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nuc_lut_df <span class="op">=</span> pd.read_excel(nuc_lut_path())</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>nuc_lut_df.sample(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">nuclide_id</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">atomicnb</th>
<th data-quarto-table-cell-role="th">massnb</th>
<th data-quarto-table-cell-role="th">nusymbol</th>
<th data-quarto-table-cell-role="th">half_life</th>
<th data-quarto-table-cell-role="th">hl_unit</th>
<th data-quarto-table-cell-role="th">nc_name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">119</th>
<td>128</td>
<td>YTRIUM</td>
<td>39.0</td>
<td>88.0</td>
<td>88Y</td>
<td>0.00</td>
<td>-</td>
<td>y88</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">40</th>
<td>42</td>
<td>LEAD</td>
<td>82.0</td>
<td>212.0</td>
<td>212Pb</td>
<td>10.64</td>
<td>H</td>
<td>pb212</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">34</th>
<td>36</td>
<td>CERIUM</td>
<td>58.0</td>
<td>141.0</td>
<td>141Ce</td>
<td>32.55</td>
<td>D</td>
<td>ce141</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">77</th>
<td>80</td>
<td>CURIUM COMB</td>
<td>96.0</td>
<td>243.0</td>
<td>243,244Cm</td>
<td>0.00</td>
<td>-</td>
<td>cm243_244_tot</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">50</th>
<td>52</td>
<td>RADIUM</td>
<td>88.0</td>
<td>225.0</td>
<td>225Ra</td>
<td>14.80</td>
<td>D</td>
<td>ra225</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>In <code>OSPAR</code> dataset, the <code>nuclide</code> column has inconsistent naming:</p>
<ul>
<li><code>Cs-137</code>, <code>137Cs</code> or <code>CS-137</code></li>
<li><code>239, 240 pu</code> or <code>239,240 pu</code></li>
<li><code>ra-226</code> and <code>226ra</code></li>
<li>duplicates due to the presence of trailing spaces</li>
</ul>
<p>See below:</p>
</div>
</div>
<div id="b7638981" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(get_unique_across_dfs(dfs, <span class="st">'nuclide'</span>, as_df<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #008000; text-decoration-color: #008000">'Cs-137'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'210Pb'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'137Cs  '</span>,
    <span style="color: #008000; text-decoration-color: #008000">'238Pu'</span>,
    nan,
    <span style="color: #008000; text-decoration-color: #008000">'226Ra'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'99Tc  '</span>,
    <span style="color: #008000; text-decoration-color: #008000">'CS-137'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'239,240Pu'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'239, 240 Pu'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'241Am'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'210Po'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'210Po  '</span>,
    <span style="color: #008000; text-decoration-color: #008000">'228Ra'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'99Tc'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'99Tc   '</span>,
    <span style="color: #008000; text-decoration-color: #008000">'137Cs'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'3H'</span>
<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<p>Regardless of these inconsistencies, <code>OSPAR</code>’s <code>nuclide</code> column needs to be standardized accorsing to MARIS nomenclature.</p>
<section id="lower-strip-nuclide-names" class="level3">
<h3 class="anchored" data-anchor-id="lower-strip-nuclide-names">Lower &amp; strip nuclide names</h3>
<p>To streamline the process of standardizing nuclide data, we employ the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#lowerstripnamecb"><code>LowerStripNameCB</code></a> callback. This function is applied to each DataFrame within our dictionary of DataFrames. Specifically, <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#lowerstripnamecb"><code>LowerStripNameCB</code></a> simplifies the nuclide names by converting them to lowercase and removing any leading or trailing whitespace.</p>
<div id="efa61ba1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'nuclide'</span>)])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>dfs_output<span class="op">=</span>tfm()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, df <span class="kw">in</span> dfs_output.items(): <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> nuclides: </span><span class="sc">{</span>df[<span class="st">"nuclide"</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BIOTA nuclides: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'137cs'</span> <span style="color: #008000; text-decoration-color: #008000">'226ra'</span> <span style="color: #008000; text-decoration-color: #008000">'228ra'</span> <span style="color: #008000; text-decoration-color: #008000">'239,240pu'</span> <span style="color: #008000; text-decoration-color: #008000">'99tc'</span> <span style="color: #008000; text-decoration-color: #008000">'210po'</span> <span style="color: #008000; text-decoration-color: #008000">'210pb'</span> <span style="color: #008000; text-decoration-color: #008000">'3h'</span> <span style="color: #008000; text-decoration-color: #008000">'cs-137'</span>
 <span style="color: #008000; text-decoration-color: #008000">'238pu'</span> <span style="color: #008000; text-decoration-color: #008000">'239, 240 pu'</span> <span style="color: #008000; text-decoration-color: #008000">'241am'</span><span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER nuclides: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'137cs'</span> <span style="color: #008000; text-decoration-color: #008000">'239,240pu'</span> <span style="color: #008000; text-decoration-color: #008000">'226ra'</span> <span style="color: #008000; text-decoration-color: #008000">'228ra'</span> <span style="color: #008000; text-decoration-color: #008000">'99tc'</span> <span style="color: #008000; text-decoration-color: #008000">'3h'</span> <span style="color: #008000; text-decoration-color: #008000">'210po'</span> <span style="color: #008000; text-decoration-color: #008000">'210pb'</span> nan<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
</section>
<section id="remap-nuclide-names-to-maris-data-formats" class="level3">
<h3 class="anchored" data-anchor-id="remap-nuclide-names-to-maris-data-formats">Remap nuclide names to MARIS data formats</h3>
<p>Next, we map nuclide names used by <code>OSPAR</code> to the <code>MARIS</code> standard nuclide names.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>The “IMFA” MARISCO PATTERN
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remapping data provider nomenclatures to <code>MARIS</code> standards is a recurrent operation and is done in a semi-automated manner according to the following pattern:</p>
<ol type="1">
<li><strong>Inspect</strong> data provider nomenclature</li>
<li><strong>Match</strong> automatically against <code>MARIS</code> nomenclature (using a fuzzy matching algorithm)</li>
<li><strong>Fix</strong> potential mismatches</li>
<li><strong>Apply</strong> the lookup table to the <code>DataFrame</code></li>
</ol>
<p>We will refer to this process as <strong>IMFA</strong> (<strong>I</strong>nspect, <strong>M</strong>atch, <strong>F</strong>ix, <strong>A</strong>pply).</p>
</div>
</div>
<p>Let’s now create an instance of a <a href="https://www.wikiwand.com/en/articles/Approximate_string_matching">fuzzy matching algorithm</a> <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>. This instance will align the nuclide names from the OSPAR dataset with the MARIS standard nuclide names, as defined in the lookup table located at <a href="https://franckalbinet.github.io/marisco/api/configs.html#nuc_lut_path"><code>nuc_lut_path</code></a> and previously shown as <code>nuc_lut_df</code>.</p>
<div id="582e03a6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs_output, col_name<span class="op">=</span><span class="st">'nuclide'</span>, as_df<span class="op">=</span><span class="va">True</span>), </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    maris_lut_fn<span class="op">=</span>nuc_lut_path,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    maris_col_id<span class="op">=</span><span class="st">'nuclide_id'</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    maris_col_name<span class="op">=</span><span class="st">'nc_name'</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    fname_cache<span class="op">=</span><span class="st">'nuclides_ospar.pkl'</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s clarify the meaning of the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> parameters:</p>
<ul>
<li><code>provider_lut_df</code>: It is the nomenclature/lookup table used by the data provider for a certain attribute/variable. When the data provider does not provide such nomenclature, <a href="https://franckalbinet.github.io/marisco/api/utils.html#get_unique_across_dfs"><code>get_unique_across_dfs</code></a> is used to extract the unique values from data provider data.</li>
<li><code>maris_lut_fn</code>: The path to the lookup table containing the <code>MARIS</code> standard nuclide names</li>
<li><code>maris_col_id</code>: The column name in the lookup table containing the <code>MARIS</code> standard nuclide names</li>
<li><code>maris_col_name</code>: The column name in the lookup table containing the <code>MARIS</code> standard nuclide names</li>
<li><code>provider_col_to_match</code>: The column name in the <code>OSPAR</code> dataset containing the nuclide names used for the remapping</li>
<li><code>provider_col_key</code>: The column name in the <code>OSPAR</code> dataset containing the nuclide names to remap from</li>
<li><code>fname_cache</code>: The filename for the cache file</li>
</ul>
<p>Both <code>provider_col_to_match</code> and <code>provider_col_key</code> are the same column name in the <code>OSPAR</code> dataset. In other cases, data providers provide an associated nomenclature such as below for instance (see HELCOM handler for instance).</p>
<p><code>data-provider-nuclide-lut</code> DataFrame:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>nuclide_id</th>
<th>nuclide</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Cs-137</td>
</tr>
<tr class="even">
<td>1</td>
<td>Cs-134</td>
</tr>
<tr class="odd">
<td>2</td>
<td>I-131</td>
</tr>
</tbody>
</table>
<p>and uses the <code>nuclide_id</code> value in the data themselves. In such a case: - <code>provider_lut_df</code>: <code>data-provider-nuclide-lut</code> - <code>provider_col_to_match</code> would be <code>nuclide</code> - <code>provider_col_key</code> would be <code>nuclide_id</code></p>
<p>Now, we can automatically match the OSPAR nuclide names to the MARIS standard. The match_score column helps us evaluate the results.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Pay Attention
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that data provider’s name to macth is always transformed to lowercase and stripped of any leading or trailing whitespace to streamline the matching process as mentionned above.</p>
</div>
</div>
<div id="34f3a398" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">0</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/13 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 13/13 [00:00&lt;00:00, 57.47it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>0 entries matched the criteria, while 13 entries had a match score of 0 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">239, 240 pu</th>
<td>pu240</td>
<td>239, 240 pu</td>
<td>8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">239,240pu</th>
<td>pu240</td>
<td>239,240pu</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">137cs</th>
<td>i133</td>
<td>137cs</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">241am</th>
<td>pu241</td>
<td>241am</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">210po</th>
<td>ru106</td>
<td>210po</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">226ra</th>
<td>u234</td>
<td>226ra</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">210pb</th>
<td>ru106</td>
<td>210pb</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">228ra</th>
<td>u235</td>
<td>228ra</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">99tc</th>
<td>tu</td>
<td>99tc</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">238pu</th>
<td>u238</td>
<td>238pu</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3h</th>
<td>tu</td>
<td>3h</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">cs-137</th>
<td>cs137</td>
<td>cs-137</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">NaN</th>
<td>Unknown</td>
<td>NaN</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Fuzzy Matching
</div>
</div>
<div class="callout-body-container callout-body">
<p>To try matching/reconciling two nomenclatures, we compute the <a href="https://www.wikiwand.com/en/Levenshtein_distance">Levenshtein distance</a> between the <code>OSPAR</code> nuclide names and the <code>MARIS</code> standard nuclide names as indicated in the <code>match_score</code> column. A score of 0 indicates a perfect match.</p>
</div>
</div>
<p>We now manually review the unmatched nuclide names and construct a dictionary to map them to the <code>MARIS</code> standard.</p>
<div id="35dbbfa1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fixes_nuclide_names <span class="op">=</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'99tc'</span>: <span class="st">'tc99'</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'238pu'</span>: <span class="st">'pu238'</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'226ra'</span>: <span class="st">'ra226'</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ra-226'</span>: <span class="st">'ra226'</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ra-228'</span>: <span class="st">'ra228'</span>,    </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'210pb'</span>: <span class="st">'pb210'</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'241am'</span>: <span class="st">'am241'</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'228ra'</span>: <span class="st">'ra228'</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'137cs'</span>: <span class="st">'cs137'</span>,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'210po'</span>: <span class="st">'po210'</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'239,240pu'</span>: <span class="st">'pu239_240_tot'</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'239, 240 pu'</span>: <span class="st">'pu239_240_tot'</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'3h'</span>: <span class="st">'h3'</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The dictionary <code>fixes_nuclide_names</code> applies manual corrections to the nuclide names before the remapping process begins. Note that we did not remap <code>cs-137</code> to <code>cs137</code> as the fuzzy matching algorithm already matched <code>cs-137</code> to <code>cs137</code> (though the match score was 1).</p>
<p>The <code>generate_lookup_table</code> function constructs a lookup table for this purpose and includes an <code>overwrite</code> parameter, set to <code>True</code> by default. When activated, this parameter enables the function to update the existing cache with a new pickle file containing the updated lookup table. We are now prepared to test the remapping process.</p>
<div id="cd8dd48f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>, fixes<span class="op">=</span>fixes_nuclide_names)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/13 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 13/13 [00:00&lt;00:00, 52.43it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">cs-137</th>
<td>cs137</td>
<td>cs-137</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">137cs</th>
<td>cs137</td>
<td>137cs</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">241am</th>
<td>am241</td>
<td>241am</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">210po</th>
<td>po210</td>
<td>210po</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">226ra</th>
<td>ra226</td>
<td>226ra</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">99tc</th>
<td>tc99</td>
<td>99tc</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">239,240pu</th>
<td>pu239_240_tot</td>
<td>239,240pu</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">238pu</th>
<td>pu238</td>
<td>238pu</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3h</th>
<td>h3</td>
<td>3h</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">239, 240 pu</th>
<td>pu239_240_tot</td>
<td>239, 240 pu</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">210pb</th>
<td>pb210</td>
<td>210pb</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">228ra</th>
<td>ra228</td>
<td>228ra</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">NaN</th>
<td>Unknown</td>
<td>NaN</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>To view all remapped nuclides as a lookup table that will be later passed to our <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapnuclidenamecb"><code>RemapNuclideNameCB</code></a> callback:</p>
<div id="c67735f1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">False</span>, fixes<span class="op">=</span>fixes_nuclide_names, overwrite<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/13 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 13/13 [00:00&lt;00:00, 56.68it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'137cs': Match(matched_id=np.int64(33), matched_maris_name='cs137', source_name='137cs', match_score=np.int64(0)),
 '241am': Match(matched_id=np.int64(72), matched_maris_name='am241', source_name='241am', match_score=np.int64(0)),
 '210po': Match(matched_id=np.int64(47), matched_maris_name='po210', source_name='210po', match_score=np.int64(0)),
 '226ra': Match(matched_id=np.int64(53), matched_maris_name='ra226', source_name='226ra', match_score=np.int64(0)),
 '99tc': Match(matched_id=np.int64(15), matched_maris_name='tc99', source_name='99tc', match_score=np.int64(0)),
 '239,240pu': Match(matched_id=np.int64(77), matched_maris_name='pu239_240_tot', source_name='239,240pu', match_score=np.int64(0)),
 '238pu': Match(matched_id=np.int64(67), matched_maris_name='pu238', source_name='238pu', match_score=np.int64(0)),
 '3h': Match(matched_id=np.int64(1), matched_maris_name='h3', source_name='3h', match_score=np.int64(0)),
 'cs-137': Match(matched_id=np.int64(33), matched_maris_name='cs137', source_name='cs-137', match_score=np.int64(1)),
 '239, 240 pu': Match(matched_id=np.int64(77), matched_maris_name='pu239_240_tot', source_name='239, 240 pu', match_score=np.int64(0)),
 '210pb': Match(matched_id=np.int64(41), matched_maris_name='pb210', source_name='210pb', match_score=np.int64(0)),
 '228ra': Match(matched_id=np.int64(54), matched_maris_name='ra228', source_name='228ra', match_score=np.int64(0)),
 nan: Match(matched_id=-1, matched_maris_name='Unknown', source_name=nan, match_score=0)}</code></pre>
</div>
</div>
<p>The nuclide names have been successfully remapped. We now create a callback named <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapnuclidenamecb"><code>RemapNuclideNameCB</code></a> to translate the OSPAR dataset’s nuclide names into the standard <code>nuclide_id</code>s used by MARIS. This callback employs the <code>lut_nuclides</code> lambda function, which provides the required lookup table. Note that the <code>overwrite=False</code> parameter is specified in the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> constructor of the <code>lut_nuclides</code> lambda function to utilize the cached version.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L164" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="remapnuclidenamecb" class="level3">
<h3 class="anchored" data-anchor-id="remapnuclidenamecb">RemapNuclideNameCB</h3>
<blockquote class="blockquote">
<pre><code> RemapNuclideNameCB (fn_lut:Callable, col_name:str)</code></pre>
</blockquote>
<p><em>Remap data provider nuclide names to standardized MARIS nuclide names.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fn_lut</td>
<td>Callable</td>
<td>Function that returns the lookup table dictionary</td>
</tr>
<tr class="even">
<td>col_name</td>
<td>str</td>
<td>Column name to remap</td>
</tr>
</tbody>
</table>
<div id="600bce0c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lookup table for nuclide names</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>lut_nuclides <span class="op">=</span> <span class="kw">lambda</span> df: Remapper(provider_lut_df<span class="op">=</span>df,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                                   maris_lut_fn<span class="op">=</span>nuc_lut_path,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                                   maris_col_id<span class="op">=</span><span class="st">'nuclide_id'</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                                   maris_col_name<span class="op">=</span><span class="st">'nc_name'</span>,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>                                   provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                                   provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                                   fname_cache<span class="op">=</span><span class="st">'nuclides_ospar.pkl'</span>).generate_lookup_table(fixes<span class="op">=</span>fixes_nuclide_names, </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                                                                                            as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="66944861" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapNuclideNameCB(Callback):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Remap data provider nuclide names to standardized MARIS nuclide names."</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                 fn_lut: Callable, <span class="co"># Function that returns the lookup table dictionary</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                 col_name: <span class="bu">str</span> <span class="co"># Column name to remap</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                ):</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        df_uniques <span class="op">=</span> get_unique_across_dfs(tfm.dfs, col_name<span class="op">=</span><span class="va">self</span>.col_name, as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        lut <span class="op">=</span> {k: v.matched_id <span class="cf">for</span> k, v <span class="kw">in</span> <span class="va">self</span>.fn_lut(df_uniques).items()}    </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> tfm.dfs.keys():</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>            tfm.dfs[k][<span class="st">'NUCLIDE'</span>] <span class="op">=</span> tfm.dfs[k][<span class="va">self</span>.col_name].replace(lut)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Let’s see it in action, along with the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#lowerstripnamecb"><code>LowerStripNameCB</code></a> callback:</p>
<div id="ace3e8b7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'nuclide'</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>dfs_out <span class="op">=</span> tfm()</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For instance</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key <span class="kw">in</span> dfs_out.keys():</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Unique nuclide_ids for </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> NUCLIDE column: '</span>, dfs_out[key][<span class="st">'NUCLIDE'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 12/12 [00:00&lt;00:00, 46.32it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Unique nuclide_ids for BIOTA NUCLIDE column:  <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">53</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">77</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">41</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">67</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">72</span><span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Unique nuclide_ids for SEAWATER NUCLIDE column:  <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">77</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">53</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">41</span><span style="font-weight: bold">]</span>
</pre>
</div>
</div>
</section>
</section>
<section id="standardize-time" class="level2">
<h2 class="anchored" data-anchor-id="standardize-time">Standardize Time</h2>
<p>We create a callback that remaps the date time format in the dictionary of DataFrames (i.e.&nbsp;<code>%m/%d/%y %H:%M:%S</code>) to a data time object and in the process handle missing date and times.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L246" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="parsetimecb" class="level3">
<h3 class="anchored" data-anchor-id="parsetimecb">ParseTimeCB</h3>
<blockquote class="blockquote">
<pre><code> ParseTimeCB (col_src:dict={'BIOTA': 'sampling date', 'SEAWATER':
              'sampling date'}, col_dst:str='TIME', format:str='%m/%d/%y
              %H:%M:%S')</code></pre>
</blockquote>
<p><em>Parse the time format in the dataframe and check for inconsistencies.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>col_src</td>
<td>dict</td>
<td>{‘BIOTA’: ‘sampling date’, ‘SEAWATER’: ‘sampling date’}</td>
<td>Column name to remap</td>
</tr>
<tr class="even">
<td>col_dst</td>
<td>str</td>
<td>TIME</td>
<td>Column name to remap</td>
</tr>
<tr class="odd">
<td>format</td>
<td>str</td>
<td>%m/%d/%y %H:%M:%S</td>
<td>Time format</td>
</tr>
</tbody>
</table>
<div id="4d5ed206" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>time_cols <span class="op">=</span> {<span class="st">'BIOTA'</span>: <span class="st">'sampling date'</span>, <span class="st">'SEAWATER'</span>: <span class="st">'sampling date'</span>}</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>time_format <span class="op">=</span> <span class="st">'%m/</span><span class="sc">%d</span><span class="st">/%y %H:%M:%S'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bcd2893e" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParseTimeCB(Callback):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Parse the time format in the dataframe and check for inconsistencies."</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                 col_src: <span class="bu">dict</span><span class="op">=</span>time_cols, <span class="co"># Column name to remap</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                 col_dst: <span class="bu">str</span><span class="op">=</span><span class="st">'TIME'</span>, <span class="co"># Column name to remap</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>                 <span class="bu">format</span>: <span class="bu">str</span><span class="op">=</span>time_format <span class="co"># Time format</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>            src_col <span class="op">=</span> <span class="va">self</span>.col_src.get(grp)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>            df[<span class="va">self</span>.col_dst] <span class="op">=</span> pd.to_datetime(df[src_col], <span class="bu">format</span><span class="op">=</span><span class="va">self</span>.<span class="bu">format</span>, errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tfm</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Apply the transformer for callback <a href="https://franckalbinet.github.io/marisco/handlers/geotraces.html#parsetimecb"><code>ParseTimeCB</code></a>.</p>
<div id="bc05ba8e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    ParseTimeCB(),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    CompareDfsAndTfmCB(dfs)])</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Row Count Comparison Before and After Transformation:&lt;/b&gt;"</span>))</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame.from_dict(tfm.compare_stats))</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Example of parsed time column:&lt;/b&gt;"</span>))</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEAWATER'</span>][<span class="st">'TIME'</span>].head(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Row Count Comparison Before and After Transformation:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">BIOTA</th>
<th data-quarto-table-cell-role="th">SEAWATER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Original row count (dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Transformed row count (tfm.dfs)</th>
<td>15951</td>
<td>19183</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rows removed from original (tfm.dfs_removed)</th>
<td>0</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rows created in transformed (tfm.dfs_created)</th>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of parsed time column:</b></p>
</div>
<div class="cell-output cell-output-display">
<pre><code>0   2010-01-27
1   2010-01-27
Name: TIME, dtype: datetime64[ns]</code></pre>
</div>
</div>
<p>The NetCDF time format requires the time to be encoded as number of milliseconds since a time of origin. In our case the time of origin is <code>1970-01-01</code> as indicated in <code>configs.ipynb</code> <code>CONFIFS['units']['time']</code> dictionary.</p>
<p><a href="https://franckalbinet.github.io/marisco/api/callbacks.html#encodetimecb"><code>EncodeTimeCB</code></a> transforms the datetime object from <a href="https://franckalbinet.github.io/marisco/handlers/geotraces.html#parsetimecb"><code>ParseTimeCB</code></a> into the MARIS NetCDF time format.</p>
<div id="c30bd204" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    ParseTimeCB(),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    EncodeTimeCB(),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    CompareDfsAndTfmCB(dfs)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Row Count Comparison Before and After Transformation:&lt;/b&gt;"</span>))</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame.from_dict(tfm.compare_stats))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Row Count Comparison Before and After Transformation:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">BIOTA</th>
<th data-quarto-table-cell-role="th">SEAWATER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Original row count (dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Transformed row count (tfm.dfs)</th>
<td>15951</td>
<td>19183</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rows removed from original (tfm.dfs_removed)</th>
<td>0</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rows created in transformed (tfm.dfs_created)</th>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="sanitize-value" class="level2">
<h2 class="anchored" data-anchor-id="sanitize-value">Sanitize value</h2>
<p>We create a callback, <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#sanitizevaluecb"><code>SanitizeValueCB</code></a>, to consolidate measurement values into a single column named <code>VALUE</code> and remove any NaN entries.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L274" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="sanitizevaluecb" class="level3">
<h3 class="anchored" data-anchor-id="sanitizevaluecb">SanitizeValueCB</h3>
<blockquote class="blockquote">
<pre><code> SanitizeValueCB (value_col:dict={'BIOTA': 'activity or mda', 'SEAWATER':
                  'activity or mda'})</code></pre>
</blockquote>
<p><em>Sanitize value by removing blank entries and populating <code>value</code> column.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>value_col</td>
<td>dict</td>
<td>{‘BIOTA’: ‘activity or mda’, ‘SEAWATER’: ‘activity or mda’}</td>
<td>Column name to sanitize</td>
</tr>
</tbody>
</table>
<div id="84fece8a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>value_cols <span class="op">=</span> {<span class="st">'BIOTA'</span>: <span class="st">'activity or mda'</span>, <span class="st">'SEAWATER'</span>: <span class="st">'activity or mda'</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="38538f9f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SanitizeValueCB(Callback):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Sanitize value by removing blank entries and populating `value` column."</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                 value_col: <span class="bu">dict</span> <span class="op">=</span> value_cols <span class="co"># Column name to sanitize</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drop rows where parsing failed (NaT values in TIME column)</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            invalid_rows <span class="op">=</span> df[df[<span class="va">self</span>.value_col.get(grp)].isna()]</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> invalid_rows.empty:     </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(invalid_rows)<span class="sc">}</span><span class="ss"> invalid rows found in group '</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">' during sanitize value callback."</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                df.dropna(subset<span class="op">=</span>[<span class="va">self</span>.value_col.get(grp)], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'VALUE'</span>] <span class="op">=</span> df[<span class="va">self</span>.value_col.get(grp)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="a68ecd5b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    SanitizeValueCB(),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    CompareDfsAndTfmCB(dfs)])</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Example of VALUE column:&lt;/b&gt;"</span>))</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'VALUE'</span>]].head())</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Row Count Comparison Before and After Transformation:&lt;/b&gt;"</span>))</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame.from_dict(tfm.compare_stats))</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Example of removed data:&lt;/b&gt;"</span>))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs_removed[<span class="st">'SEAWATER'</span>].head(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of VALUE column:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">VALUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0.20</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0.27</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>0.26</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>0.25</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>0.20</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Row Count Comparison Before and After Transformation:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">BIOTA</th>
<th data-quarto-table-cell-role="th">SEAWATER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Original row count (dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Transformed row count (tfm.dfs)</th>
<td>15951</td>
<td>19183</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rows removed from original (tfm.dfs_removed)</th>
<td>0</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rows created in transformed (tfm.dfs_created)</th>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of removed data:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">rsc sub-division</th>
<th data-quarto-table-cell-role="th">station id</th>
<th data-quarto-table-cell-role="th">sample id</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">longm</th>
<th data-quarto-table-cell-role="th">longs</th>
<th data-quarto-table-cell-role="th">longdir</th>
<th data-quarto-table-cell-role="th">sample type</th>
<th data-quarto-table-cell-role="th">sampling depth</th>
<th data-quarto-table-cell-role="th">sampling date</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">value type</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">data provider</th>
<th data-quarto-table-cell-role="th">measurement comment</th>
<th data-quarto-table-cell-role="th">sample comment</th>
<th data-quarto-table-cell-role="th">reference comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">14776</th>
<td>97948</td>
<td>Sweden</td>
<td>11.0</td>
<td>SW7</td>
<td>1</td>
<td>58</td>
<td>36.0</td>
<td>12.0</td>
<td>N</td>
<td>11</td>
<td>14.0</td>
<td>42.0</td>
<td>E</td>
<td>WATER</td>
<td>1.0</td>
<td>NaN</td>
<td>3H</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Bq/l</td>
<td>Swedish Radiation Safety Authority</td>
<td>no 3H this year due to broken LSC</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">14780</th>
<td>97952</td>
<td>Sweden</td>
<td>12.0</td>
<td>Ringhals (R35)</td>
<td>7</td>
<td>57</td>
<td>14.0</td>
<td>5.0</td>
<td>N</td>
<td>11</td>
<td>56.0</td>
<td>8.0</td>
<td>E</td>
<td>WATER</td>
<td>1.0</td>
<td>NaN</td>
<td>3H</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Bq/l</td>
<td>Swedish Radiation Safety Authority</td>
<td>no 3H this year due to broken LSC</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="normalize-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="normalize-uncertainty">Normalize uncertainty</h2>
<p>We create a callback, <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#normalizeunccb"><code>NormalizeUncCB</code></a>, to standardize the uncertainty value to the MARIS format. For each sample type in the OSPAR dataset, the reported uncertainty is given as an expanded uncertainty with a coverage factor <code>𝑘=2</code>. For further details, refer to the <a href="https://mcc.jrc.ec.europa.eu/documents/OSPAR/Guidelines_forestimationof_a_%20measurefor_uncertainty_in_OSPARmonitoring.pdf">OSPAR reporting guidelines</a>. In MARIS the uncertainty values are reported as standard uncertainty with a coverage factor <code>𝑘=1</code>.</p>
<p><a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#normalizeunccb"><code>NormalizeUncCB</code></a> callback normalizes the uncertainty using the following <code>lambda</code> function:</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L322" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="normalizeunccb" class="level3">
<h3 class="anchored" data-anchor-id="normalizeunccb">NormalizeUncCB</h3>
<blockquote class="blockquote">
<pre><code> NormalizeUncCB (col_unc:dict={'BIOTA': 'uncertainty', 'SEAWATER':
                 'uncertainty'}, fn_convert_unc:Callable=&lt;function
                 &lt;lambda&gt;&gt;)</code></pre>
</blockquote>
<p><em>Normalize uncertainty values in DataFrames.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>col_unc</td>
<td>dict</td>
<td>{‘BIOTA’: ‘uncertainty’, ‘SEAWATER’: ‘uncertainty’}</td>
<td>Column name to normalize</td>
</tr>
<tr class="even">
<td>fn_convert_unc</td>
<td>Callable</td>
<td><lambda></lambda></td>
<td>Function correcting coverage factor</td>
</tr>
</tbody>
</table>
<div id="d6c84351" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>unc_exp2stan <span class="op">=</span> <span class="kw">lambda</span> df, unc_col: df[unc_col] <span class="op">/</span> <span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bcfc8fc1" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>unc_cols <span class="op">=</span> {<span class="st">'BIOTA'</span>: <span class="st">'uncertainty'</span>, <span class="st">'SEAWATER'</span>: <span class="st">'uncertainty'</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="ecb2866d" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NormalizeUncCB(Callback):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Normalize uncertainty values in DataFrames."""</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>                 col_unc: <span class="bu">dict</span> <span class="op">=</span> unc_cols, <span class="co"># Column name to normalize</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                 fn_convert_unc: Callable<span class="op">=</span>unc_exp2stan, <span class="co"># Function correcting coverage factor</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                 ): </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._convert_commas_to_periods(df, <span class="va">self</span>.col_unc.get(grp)   )</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._convert_to_float(df, <span class="va">self</span>.col_unc.get(grp))</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._apply_conversion_function(df, <span class="va">self</span>.col_unc.get(grp))</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _convert_commas_to_periods(<span class="va">self</span>, df, col_unc    ):</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Convert commas to periods in the uncertainty column."""</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        df[col_unc] <span class="op">=</span> df[col_unc].astype(<span class="bu">str</span>).<span class="bu">str</span>.replace(<span class="st">','</span>, <span class="st">'.'</span>)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _convert_to_float(<span class="va">self</span>, df, col_unc):</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Convert uncertainty column to float, handling errors by setting them to NaN."""</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        df[col_unc] <span class="op">=</span> pd.to_numeric(df[col_unc], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _apply_conversion_function(<span class="va">self</span>, df, col_unc):</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Apply the conversion function to normalize the uncertainty values."""</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'UNC'</span>] <span class="op">=</span> <span class="va">self</span>.fn_convert_unc(df, col_unc)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="76a18010" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    SanitizeValueCB(),               </span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    NormalizeUncCB()</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Example of VALUE and UNC columns:&lt;/b&gt;"</span>))  </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'SEAWATER'</span>, <span class="st">'BIOTA'</span>]:</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="ch">\n</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tfm.dfs[grp][[<span class="st">'VALUE'</span>, <span class="st">'UNC'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of VALUE and UNC columns:</b></p>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER:
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">          VALUE           UNC
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.200000</span>           NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.270000</span>           NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.260000</span>           NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.250000</span>           NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.200000</span>           NaN
<span style="color: #808000; text-decoration-color: #808000">...</span>         <span style="color: #808000; text-decoration-color: #808000">...</span>           <span style="color: #808000; text-decoration-color: #808000">...</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19183</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000005</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.600000e-07</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19184</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.152000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.076000e-01</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19185</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.005390</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.078000e-03</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19186</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.001420</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.840000e-04</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19187</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.078000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.039000e-01</span>

<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19183</span> rows x <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> columns<span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BIOTA:
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">          VALUE       UNC
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.326416</span>       NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.442704</span>       NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.412989</span>       NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.202768</span>       NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.652833</span>       NaN
<span style="color: #808000; text-decoration-color: #808000">...</span>         <span style="color: #808000; text-decoration-color: #808000">...</span>       <span style="color: #808000; text-decoration-color: #808000">...</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15946</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.384000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.012096</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15947</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.456000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.012084</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15948</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.122000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.031000</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15949</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.310000</span>       NaN
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15950</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.306000</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.007191</span>

<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15951</span> rows x <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> columns<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>SEAWATER</code> dataset includes instances where the uncertainty values significantly exceed the corresponding measurement values. While such occurrences are not inherently erroneous, they merit attention and may warrant further verification.</p>
</div>
</div>
<p>To demonstrate instances where the uncertainty significantly surpasses the measurement values, we will initially compute the ‘relative uncertainty’ as a percentage for the seawater dataset.</p>
<div id="84000c3b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'SEAWATER'</span>, <span class="st">'BIOTA'</span>]:</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    tfm.dfs[grp][<span class="st">'relative_uncertainty'</span>] <span class="op">=</span> (</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Divide 'uncertainty' by 'value'</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    (tfm.dfs[grp][<span class="st">'uncertainty'</span>] <span class="op">/</span> tfm.dfs[grp][<span class="st">'activity or mda'</span>])</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Multiply by 100 to convert to percentage</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> <span class="dv">100</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we will retrieve all rows where the relative uncertainty exceeds 100% for the seawater dataset.</p>
<div id="5f5144aa" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>grp <span class="op">=</span> <span class="st">'SEAWATER'</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>cols_to_show <span class="op">=</span> [<span class="st">'id'</span>, <span class="st">'contracting party'</span>, <span class="st">'nuclide'</span>, <span class="st">'value type'</span>, <span class="st">'activity or mda'</span>, <span class="st">'uncertainty'</span>, <span class="st">'unit'</span>, <span class="st">'relative_uncertainty'</span>]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> tfm.dfs[grp][cols_to_show][tfm.dfs[grp][<span class="st">'relative_uncertainty'</span>] <span class="op">&gt;</span> threshold]</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of rows where relative uncertainty is greater than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">%: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="ss">f"&lt;b&gt; Example of data with relative uncertainty greater than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">%:&lt;/b&gt;"</span>))</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    display(df.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of rows where relative uncertainty is greater than <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>%: 
 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">95</span> 

</pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of data with relative uncertainty greater than 100%:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">value type</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">relative_uncertainty</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">969</th>
<td>11075</td>
<td>United Kingdom</td>
<td>137Cs</td>
<td>=</td>
<td>0.0028</td>
<td>0.3276</td>
<td>Bq/l</td>
<td>11700.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">971</th>
<td>11077</td>
<td>United Kingdom</td>
<td>137Cs</td>
<td>=</td>
<td>0.0029</td>
<td>0.3364</td>
<td>Bq/l</td>
<td>11600.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">973</th>
<td>11079</td>
<td>United Kingdom</td>
<td>137Cs</td>
<td>=</td>
<td>0.0025</td>
<td>0.3325</td>
<td>Bq/l</td>
<td>13300.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">975</th>
<td>11081</td>
<td>United Kingdom</td>
<td>137Cs</td>
<td>=</td>
<td>0.0025</td>
<td>0.3450</td>
<td>Bq/l</td>
<td>13800.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">977</th>
<td>11083</td>
<td>United Kingdom</td>
<td>137Cs</td>
<td>=</td>
<td>0.0038</td>
<td>0.3344</td>
<td>Bq/l</td>
<td>8800.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>BIOTA</code> dataset includes instances where the uncertainty values significantly exceed the corresponding measurement values. While such occurrences are not inherently erroneous, they merit attention and may warrant further verification.</p>
</div>
</div>
<p>Now we will retrieve all rows where the relative uncertainty exceeds 100% for the biota dataset.</p>
<div id="5d211075" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>grp <span class="op">=</span> <span class="st">'BIOTA'</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>cols_to_show<span class="op">=</span>[<span class="st">'id'</span>, <span class="st">'contracting party'</span>, <span class="st">'nuclide'</span>, <span class="st">'value type'</span>, <span class="st">'activity or mda'</span>, <span class="st">'uncertainty'</span>, <span class="st">'unit'</span>, <span class="st">'relative_uncertainty'</span>]</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>df<span class="op">=</span>tfm.dfs[grp][cols_to_show][tfm.dfs[grp][<span class="st">'relative_uncertainty'</span>] <span class="op">&gt;</span> threshold]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Number of rows where relative uncertainty is greater than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">%: </span><span class="ch">\n</span><span class="ss"> </span><span class="sc">{</span>df<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> </span><span class="ch">\n</span><span class="ss">'</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="ss">f"&lt;b&gt; Example of data with relative uncertainty greater than </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">%:&lt;/b&gt;"</span>))</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    display(df.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of rows where relative uncertainty is greater than <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>%: 
 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span> 

</pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Example of data with relative uncertainty greater than 100%:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">nuclide</th>
<th data-quarto-table-cell-role="th">value type</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">relative_uncertainty</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">249</th>
<td>3101</td>
<td>Norway</td>
<td>137Cs</td>
<td>=</td>
<td>0.0500</td>
<td>0.1000</td>
<td>Bq/kg f.w.</td>
<td>200.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">306</th>
<td>3158</td>
<td>Norway</td>
<td>137Cs</td>
<td>=</td>
<td>0.1500</td>
<td>0.1600</td>
<td>Bq/kg f.w.</td>
<td>106.666667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">775</th>
<td>8152</td>
<td>Norway</td>
<td>137Cs</td>
<td>=</td>
<td>0.0340</td>
<td>0.0500</td>
<td>Bq/kg f.w.</td>
<td>147.058824</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">788</th>
<td>8165</td>
<td>Norway</td>
<td>137Cs</td>
<td>=</td>
<td>0.0300</td>
<td>0.0500</td>
<td>Bq/kg f.w.</td>
<td>166.666667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1839</th>
<td>19571</td>
<td>Belgium</td>
<td>239,240Pu</td>
<td>=</td>
<td>0.0074</td>
<td>0.0093</td>
<td>Bq/kg f.w.</td>
<td>125.675676</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="remap-units" class="level2">
<h2 class="anchored" data-anchor-id="remap-units">Remap units</h2>
<p>Let’s inspect the unique units used by OSPAR:</p>
<div id="d436ba0a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'unit'</span>, as_df<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>BQ/L</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>Bq/L</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>Bq/l</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>Bq/kg f.w.</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>4</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>Standardizing the units would simplify data processing, as the units are not consistent across the dataset. For example, <code>BQ/L</code>, <code>Bq/l</code>, and <code>Bq/L</code> are used interchangeably.</p>
</div>
</div>
<p>We will establish unit renaming rules for the OSPAR dataset:</p>
<div id="8dc50af9" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define unit names renaming rules</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>renaming_unit_rules <span class="op">=</span> {<span class="st">'Bq/l'</span>: <span class="dv">1</span>, <span class="co">#'Bq/m3'</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'Bq/L'</span>: <span class="dv">1</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'BQ/L'</span>: <span class="dv">1</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'Bq/kg f.w.'</span>: <span class="dv">5</span>, <span class="co"># Bq/kgw</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>                       }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we will create a callback, <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapunitcb"><code>RemapUnitCB</code></a>, to remap the units in the dataframes. For the <code>SEAWATER</code> dataset, we will set a default unit of <code>Bq/l</code>.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L348" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapunitcb" class="level3">
<h3 class="anchored" data-anchor-id="remapunitcb">RemapUnitCB</h3>
<blockquote class="blockquote">
<pre><code> RemapUnitCB (lut:Dict[str,str], default_units:Dict[str,str]={'SEAWATER':
              'Bq/l', 'BIOTA': 'Bq/kg f.w.'}, verbose:bool=False)</code></pre>
</blockquote>
<p><em>Callback to update DataFrame ‘UNIT’ columns based on a lookup table.</em></p>
<div id="ae09bb59" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>default_units <span class="op">=</span> {<span class="st">'SEAWATER'</span>: <span class="st">'Bq/l'</span>,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'BIOTA'</span>: <span class="st">'Bq/kg f.w.'</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="a4e4e652" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapUnitCB(Callback):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Callback to update DataFrame 'UNIT' columns based on a lookup table."""</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                 lut: Dict[<span class="bu">str</span>, <span class="bu">str</span>],</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>                 default_units: Dict[<span class="bu">str</span>, <span class="bu">str</span>] <span class="op">=</span> default_units,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                 verbose: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>                 ):</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()  <span class="co"># Store the lookup table as an attribute</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: <span class="st">'Transformer'</span>):</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Apply default units to SEAWATER dataset</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'SEAWATER'</span>:</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._apply_default_units(df, unit<span class="op">=</span><span class="va">self</span>.default_units.get(grp))</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self._print_na_units(df)</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._update_units(df)</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _apply_default_units(<span class="va">self</span>, df: pd.DataFrame , unit <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>        df.loc[df[<span class="st">'unit'</span>].isnull(), <span class="st">'unit'</span>] <span class="op">=</span> unit</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># def _print_na_units(self, df: pd.DataFrame):</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     na_count = df['unit'].isnull().sum()</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     if na_count &gt; 0 and self.verbose:</span></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         print(f"Number of rows with NaN in 'unit' column: {na_count}")</span></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _update_units(<span class="va">self</span>, df: pd.DataFrame):</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'UNIT'</span>] <span class="op">=</span> df[<span class="st">'unit'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="va">self</span>.lut.get(x, <span class="st">'Unknown'</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="8d80886f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    SanitizeValueCB(), <span class="co"># Remove blank value entries (also removes NaN values in Unit column) </span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    RemapUnitCB(renaming_unit_rules, verbose<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    CompareDfsAndTfmCB(dfs)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Row Count Comparison Before and After Transformation:&lt;/b&gt;"</span>))</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame.from_dict(tfm.compare_stats))</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Unique Unit values:'</span>)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'BIOTA'</span>, <span class="st">'SEAWATER'</span>]:</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[grp][<span class="st">'UNIT'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Row Count Comparison Before and After Transformation:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">BIOTA</th>
<th data-quarto-table-cell-role="th">SEAWATER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Original row count (dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Transformed row count (tfm.dfs)</th>
<td>15951</td>
<td>19183</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rows removed from original (tfm.dfs_removed)</th>
<td>0</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rows created in transformed (tfm.dfs_created)</th>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Unique Unit values:
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BIOTA: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span><span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">]</span>
</pre>
</div>
</div>
</section>
</section>
<section id="remap-detection-limit" class="level2">
<h2 class="anchored" data-anchor-id="remap-detection-limit">Remap detection limit</h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>FEEDBACK TO DATA PROVIDER
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>Value type</code> column contains numerous <code>nan</code> entries.</p>
</div>
</div>
<div id="1be2cb84" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of NaN entries in the 'value type' column for 'SEAWATER'</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>na_count_seawater <span class="op">=</span> dfs[<span class="st">'SEAWATER'</span>][<span class="st">'value type'</span>].isnull().<span class="bu">sum</span>()</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of NaN 'Value type' entries in 'SEAWATER': </span><span class="sc">{</span>na_count_seawater<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of NaN entries in the 'value type' column for 'BIOTA'</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>na_count_biota <span class="op">=</span> dfs[<span class="st">'BIOTA'</span>][<span class="st">'value type'</span>].isnull().<span class="bu">sum</span>()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of NaN 'Value type' entries in 'BIOTA': </span><span class="sc">{</span>na_count_biota<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of NaN <span style="color: #008000; text-decoration-color: #008000">'Value type'</span> entries in <span style="color: #008000; text-decoration-color: #008000">'SEAWATER'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">64</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of NaN <span style="color: #008000; text-decoration-color: #008000">'Value type'</span> entries in <span style="color: #008000; text-decoration-color: #008000">'BIOTA'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>
</pre>
</div>
</div>
<p>In the <code>OSPAR</code> dataset, the detection limit is denoted by <code>&lt;</code> in the <code>Value type</code> column. When the <code>Value type</code> is <code>&lt;</code>, the <code>Activity or MDA</code>column specifies the detection limit. Conversely, when the <code>Value type</code> is <code>=</code>, it indicates an actual measurement in the<code>Activity or MDA</code> column. Let’s review the entries in the <code>Value type</code> column for the OSPAR dataset:</p>
<div id="bd15b4fe" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> dfs.keys():</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(tfm.dfs[grp][<span class="st">'value type'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BIOTA:
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'&lt;'</span> <span style="color: #008000; text-decoration-color: #008000">'='</span> nan<span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER:
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'&lt;'</span> <span style="color: #008000; text-decoration-color: #008000">'='</span> nan<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<p>In <code>MARIS</code> the Detection limits are encoded as follows:</p>
<div id="b0b1ce6f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>pd.read_excel(detection_limit_lut_path())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">name_sanitized</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-1</td>
<td>Not applicable</td>
<td>Not applicable</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>Not Available</td>
<td>Not available</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>1</td>
<td>=</td>
<td>Detected value</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2</td>
<td>&lt;</td>
<td>Detection limit</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>3</td>
<td>ND</td>
<td>Not detected</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>4</td>
<td>DE</td>
<td>Derived</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can create a lambda function to retrieve the MARIS lookup table.</p>
<div id="b099b147" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>lut_dl <span class="op">=</span> <span class="kw">lambda</span>: pd.read_excel(detection_limit_lut_path(), usecols<span class="op">=</span>[<span class="st">'name'</span>,<span class="st">'id'</span>]).set_index(<span class="st">'name'</span>).to_dict()[<span class="st">'id'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We can define the columns of interest in both the <code>SEAWATER</code> and <code>BIOTA</code> DataFrames for the detection limit column.</p>
<div id="e448bf2b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>coi_dl <span class="op">=</span> {<span class="st">'SEAWATER'</span> : {<span class="st">'DL'</span> : <span class="st">'value type'</span>},</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">'BIOTA'</span>:  {<span class="st">'DL'</span> : <span class="st">'value type'</span>}</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>          }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We now create a callback <a href="https://franckalbinet.github.io/marisco/handlers/helcom.html#remapdetectionlimitcb"><code>RemapDetectionLimitCB</code></a> to remap OSPAR detection limit values to MARIS formatted values using the lookup table. Since the dataset contains ‘nan’ entries for the detection limit column, we will create a condition to set the detection limit to ‘=’ when the value and uncertainty columns are present and the current detection limit value is not in the lookup keys.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L370" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="remapdetectionlimitcb" class="level3">
<h3 class="anchored" data-anchor-id="remapdetectionlimitcb">RemapDetectionLimitCB</h3>
<blockquote class="blockquote">
<pre><code> RemapDetectionLimitCB (coi:dict, fn_lut:Callable)</code></pre>
</blockquote>
<p><em>Remap detection limit values to MARIS format using a lookup table.</em></p>
<div id="80d93d13" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemapDetectionLimitCB(Callback):</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Remap detection limit values to MARIS format using a lookup table."""</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, coi: <span class="bu">dict</span>, fn_lut: Callable):</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize with column configuration and a function to get the lookup table."""</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()        </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Apply the remapping of detection limits across all dataframes"""</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>        lut <span class="op">=</span> <span class="va">self</span>.fn_lut()  <span class="co"># Retrieve the lookup table</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'DL'</span>] <span class="op">=</span> df[<span class="va">self</span>.coi[grp][<span class="st">'DL'</span>]]</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._set_detection_limits(df, lut)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _set_detection_limits(<span class="va">self</span>, df: pd.DataFrame, lut: <span class="bu">dict</span>):</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Set detection limits based on value and uncertainty columns using specified conditions."""</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Condition to set '=' when value and uncertainty are present and the current detection limit is not in the lookup keys</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>        condition_eq <span class="op">=</span> (df[<span class="st">'VALUE'</span>].notna() <span class="op">&amp;</span> df[<span class="st">'UNC'</span>].notna() <span class="op">&amp;</span> <span class="op">~</span>df[<span class="st">'DL'</span>].isin(lut.keys()))</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>        df.loc[condition_eq, <span class="st">'DL'</span>] <span class="op">=</span> <span class="st">'='</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set 'Not Available' for unmatched detection limits</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>        df.loc[<span class="op">~</span>df[<span class="st">'DL'</span>].isin(lut.keys()), <span class="st">'DL'</span>] <span class="op">=</span> <span class="st">'Not Available'</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map existing detection limits using the lookup table</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'DL'</span>] <span class="op">=</span> df[<span class="st">'DL'</span>].<span class="bu">map</span>(lut)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="e957e15a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    SanitizeValueCB(),</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    NormalizeUncCB(),                  </span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    RemapUnitCB(renaming_unit_rules, verbose<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    RemapDetectionLimitCB(coi_dl, lut_dl)])</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> [<span class="st">'BIOTA'</span>, <span class="st">'SEAWATER'</span>]:</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tfm<span class="sc">.</span>dfs[grp][<span class="st">'DL'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BIOTA: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">]</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER: <span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">]</span>
</pre>
</div>
</div>
</section>
</section>
<section id="remap-biota-species" class="level2">
<h2 class="anchored" data-anchor-id="remap-biota-species">Remap Biota species</h2>
<p>The <code>OSPAR</code> dataset contains biota species information in the <code>Species</code> column of the biota DataFrame. To ensure consistency with MARIS standards, it is necessary to remap these species names. We will employ a similar approach to that used for standardizing nuclide names, <strong>IMFA</strong> (<strong>I</strong>nspect, <strong>M</strong>atch, <strong>F</strong>ix, <strong>A</strong>pply).</p>
<p>We first <strong>inspect</strong> the unique <code>Species</code> values of the OSPAR Biota dataset:</p>
<div id="e9dcc466" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    display(get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'species'</span>, as_df<span class="op">=</span><span class="va">True</span>).T)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
<th data-quarto-table-cell-role="th">12</th>
<th data-quarto-table-cell-role="th">13</th>
<th data-quarto-table-cell-role="th">14</th>
<th data-quarto-table-cell-role="th">15</th>
<th data-quarto-table-cell-role="th">16</th>
<th data-quarto-table-cell-role="th">17</th>
<th data-quarto-table-cell-role="th">18</th>
<th data-quarto-table-cell-role="th">19</th>
<th data-quarto-table-cell-role="th">20</th>
<th data-quarto-table-cell-role="th">21</th>
<th data-quarto-table-cell-role="th">22</th>
<th data-quarto-table-cell-role="th">23</th>
<th data-quarto-table-cell-role="th">24</th>
<th data-quarto-table-cell-role="th">25</th>
<th data-quarto-table-cell-role="th">26</th>
<th data-quarto-table-cell-role="th">27</th>
<th data-quarto-table-cell-role="th">28</th>
<th data-quarto-table-cell-role="th">29</th>
<th data-quarto-table-cell-role="th">30</th>
<th data-quarto-table-cell-role="th">31</th>
<th data-quarto-table-cell-role="th">32</th>
<th data-quarto-table-cell-role="th">33</th>
<th data-quarto-table-cell-role="th">34</th>
<th data-quarto-table-cell-role="th">35</th>
<th data-quarto-table-cell-role="th">36</th>
<th data-quarto-table-cell-role="th">37</th>
<th data-quarto-table-cell-role="th">38</th>
<th data-quarto-table-cell-role="th">39</th>
<th data-quarto-table-cell-role="th">40</th>
<th data-quarto-table-cell-role="th">41</th>
<th data-quarto-table-cell-role="th">42</th>
<th data-quarto-table-cell-role="th">43</th>
<th data-quarto-table-cell-role="th">44</th>
<th data-quarto-table-cell-role="th">45</th>
<th data-quarto-table-cell-role="th">46</th>
<th data-quarto-table-cell-role="th">47</th>
<th data-quarto-table-cell-role="th">48</th>
<th data-quarto-table-cell-role="th">49</th>
<th data-quarto-table-cell-role="th">50</th>
<th data-quarto-table-cell-role="th">51</th>
<th data-quarto-table-cell-role="th">52</th>
<th data-quarto-table-cell-role="th">53</th>
<th data-quarto-table-cell-role="th">54</th>
<th data-quarto-table-cell-role="th">55</th>
<th data-quarto-table-cell-role="th">56</th>
<th data-quarto-table-cell-role="th">57</th>
<th data-quarto-table-cell-role="th">58</th>
<th data-quarto-table-cell-role="th">59</th>
<th data-quarto-table-cell-role="th">60</th>
<th data-quarto-table-cell-role="th">61</th>
<th data-quarto-table-cell-role="th">62</th>
<th data-quarto-table-cell-role="th">63</th>
<th data-quarto-table-cell-role="th">64</th>
<th data-quarto-table-cell-role="th">65</th>
<th data-quarto-table-cell-role="th">66</th>
<th data-quarto-table-cell-role="th">67</th>
<th data-quarto-table-cell-role="th">68</th>
<th data-quarto-table-cell-role="th">69</th>
<th data-quarto-table-cell-role="th">70</th>
<th data-quarto-table-cell-role="th">71</th>
<th data-quarto-table-cell-role="th">72</th>
<th data-quarto-table-cell-role="th">73</th>
<th data-quarto-table-cell-role="th">74</th>
<th data-quarto-table-cell-role="th">75</th>
<th data-quarto-table-cell-role="th">76</th>
<th data-quarto-table-cell-role="th">77</th>
<th data-quarto-table-cell-role="th">78</th>
<th data-quarto-table-cell-role="th">79</th>
<th data-quarto-table-cell-role="th">80</th>
<th data-quarto-table-cell-role="th">81</th>
<th data-quarto-table-cell-role="th">82</th>
<th data-quarto-table-cell-role="th">83</th>
<th data-quarto-table-cell-role="th">84</th>
<th data-quarto-table-cell-role="th">85</th>
<th data-quarto-table-cell-role="th">86</th>
<th data-quarto-table-cell-role="th">87</th>
<th data-quarto-table-cell-role="th">88</th>
<th data-quarto-table-cell-role="th">89</th>
<th data-quarto-table-cell-role="th">90</th>
<th data-quarto-table-cell-role="th">91</th>
<th data-quarto-table-cell-role="th">92</th>
<th data-quarto-table-cell-role="th">93</th>
<th data-quarto-table-cell-role="th">94</th>
<th data-quarto-table-cell-role="th">95</th>
<th data-quarto-table-cell-role="th">96</th>
<th data-quarto-table-cell-role="th">97</th>
<th data-quarto-table-cell-role="th">98</th>
<th data-quarto-table-cell-role="th">99</th>
<th data-quarto-table-cell-role="th">100</th>
<th data-quarto-table-cell-role="th">101</th>
<th data-quarto-table-cell-role="th">102</th>
<th data-quarto-table-cell-role="th">103</th>
<th data-quarto-table-cell-role="th">104</th>
<th data-quarto-table-cell-role="th">105</th>
<th data-quarto-table-cell-role="th">106</th>
<th data-quarto-table-cell-role="th">107</th>
<th data-quarto-table-cell-role="th">108</th>
<th data-quarto-table-cell-role="th">109</th>
<th data-quarto-table-cell-role="th">110</th>
<th data-quarto-table-cell-role="th">111</th>
<th data-quarto-table-cell-role="th">112</th>
<th data-quarto-table-cell-role="th">113</th>
<th data-quarto-table-cell-role="th">114</th>
<th data-quarto-table-cell-role="th">115</th>
<th data-quarto-table-cell-role="th">116</th>
<th data-quarto-table-cell-role="th">117</th>
<th data-quarto-table-cell-role="th">118</th>
<th data-quarto-table-cell-role="th">119</th>
<th data-quarto-table-cell-role="th">120</th>
<th data-quarto-table-cell-role="th">121</th>
<th data-quarto-table-cell-role="th">122</th>
<th data-quarto-table-cell-role="th">123</th>
<th data-quarto-table-cell-role="th">124</th>
<th data-quarto-table-cell-role="th">125</th>
<th data-quarto-table-cell-role="th">126</th>
<th data-quarto-table-cell-role="th">127</th>
<th data-quarto-table-cell-role="th">128</th>
<th data-quarto-table-cell-role="th">129</th>
<th data-quarto-table-cell-role="th">130</th>
<th data-quarto-table-cell-role="th">131</th>
<th data-quarto-table-cell-role="th">132</th>
<th data-quarto-table-cell-role="th">133</th>
<th data-quarto-table-cell-role="th">134</th>
<th data-quarto-table-cell-role="th">135</th>
<th data-quarto-table-cell-role="th">136</th>
<th data-quarto-table-cell-role="th">137</th>
<th data-quarto-table-cell-role="th">138</th>
<th data-quarto-table-cell-role="th">139</th>
<th data-quarto-table-cell-role="th">140</th>
<th data-quarto-table-cell-role="th">141</th>
<th data-quarto-table-cell-role="th">142</th>
<th data-quarto-table-cell-role="th">143</th>
<th data-quarto-table-cell-role="th">144</th>
<th data-quarto-table-cell-role="th">145</th>
<th data-quarto-table-cell-role="th">146</th>
<th data-quarto-table-cell-role="th">147</th>
<th data-quarto-table-cell-role="th">148</th>
<th data-quarto-table-cell-role="th">149</th>
<th data-quarto-table-cell-role="th">150</th>
<th data-quarto-table-cell-role="th">151</th>
<th data-quarto-table-cell-role="th">152</th>
<th data-quarto-table-cell-role="th">153</th>
<th data-quarto-table-cell-role="th">154</th>
<th data-quarto-table-cell-role="th">155</th>
<th data-quarto-table-cell-role="th">156</th>
<th data-quarto-table-cell-role="th">157</th>
<th data-quarto-table-cell-role="th">158</th>
<th data-quarto-table-cell-role="th">159</th>
<th data-quarto-table-cell-role="th">160</th>
<th data-quarto-table-cell-role="th">161</th>
<th data-quarto-table-cell-role="th">162</th>
<th data-quarto-table-cell-role="th">163</th>
<th data-quarto-table-cell-role="th">164</th>
<th data-quarto-table-cell-role="th">165</th>
<th data-quarto-table-cell-role="th">166</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">index</th>
<td>0</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
<td>11</td>
<td>12</td>
<td>13</td>
<td>14</td>
<td>15</td>
<td>16</td>
<td>17</td>
<td>18</td>
<td>19</td>
<td>20</td>
<td>21</td>
<td>22</td>
<td>23</td>
<td>24</td>
<td>25</td>
<td>26</td>
<td>27</td>
<td>28</td>
<td>29</td>
<td>30</td>
<td>31</td>
<td>32</td>
<td>33</td>
<td>34</td>
<td>35</td>
<td>36</td>
<td>37</td>
<td>38</td>
<td>39</td>
<td>40</td>
<td>41</td>
<td>42</td>
<td>43</td>
<td>44</td>
<td>45</td>
<td>46</td>
<td>47</td>
<td>48</td>
<td>49</td>
<td>50</td>
<td>51</td>
<td>52</td>
<td>53</td>
<td>54</td>
<td>55</td>
<td>56</td>
<td>57</td>
<td>58</td>
<td>59</td>
<td>60</td>
<td>61</td>
<td>62</td>
<td>63</td>
<td>64</td>
<td>65</td>
<td>66</td>
<td>67</td>
<td>68</td>
<td>69</td>
<td>70</td>
<td>71</td>
<td>72</td>
<td>73</td>
<td>74</td>
<td>75</td>
<td>76</td>
<td>77</td>
<td>78</td>
<td>79</td>
<td>80</td>
<td>81</td>
<td>82</td>
<td>83</td>
<td>84</td>
<td>85</td>
<td>86</td>
<td>87</td>
<td>88</td>
<td>89</td>
<td>90</td>
<td>91</td>
<td>92</td>
<td>93</td>
<td>94</td>
<td>95</td>
<td>96</td>
<td>97</td>
<td>98</td>
<td>99</td>
<td>100</td>
<td>101</td>
<td>102</td>
<td>103</td>
<td>104</td>
<td>105</td>
<td>106</td>
<td>107</td>
<td>108</td>
<td>109</td>
<td>110</td>
<td>111</td>
<td>112</td>
<td>113</td>
<td>114</td>
<td>115</td>
<td>116</td>
<td>117</td>
<td>118</td>
<td>119</td>
<td>120</td>
<td>121</td>
<td>122</td>
<td>123</td>
<td>124</td>
<td>125</td>
<td>126</td>
<td>127</td>
<td>128</td>
<td>129</td>
<td>130</td>
<td>131</td>
<td>132</td>
<td>133</td>
<td>134</td>
<td>135</td>
<td>136</td>
<td>137</td>
<td>138</td>
<td>139</td>
<td>140</td>
<td>141</td>
<td>142</td>
<td>143</td>
<td>144</td>
<td>145</td>
<td>146</td>
<td>147</td>
<td>148</td>
<td>149</td>
<td>150</td>
<td>151</td>
<td>152</td>
<td>153</td>
<td>154</td>
<td>155</td>
<td>156</td>
<td>157</td>
<td>158</td>
<td>159</td>
<td>160</td>
<td>161</td>
<td>162</td>
<td>163</td>
<td>164</td>
<td>165</td>
<td>166</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">value</th>
<td>FUCUS SPP.</td>
<td>BUCCINUM UNDATUM</td>
<td>Brosme brosme</td>
<td>Thunnus sp.</td>
<td>Mixture of green, red and brown algae</td>
<td>SALMO SALAR</td>
<td>Gadiculus argenteus thori</td>
<td>Sardina pilchardus</td>
<td>Nephrops norvegicus</td>
<td>Fucus distichus</td>
<td>Anarhichas minor</td>
<td>Molva molva</td>
<td>GALEUS MELASTOMUS</td>
<td>ANARHICHAS LUPUS</td>
<td>Buccinum undatum</td>
<td>Phoca vitulina</td>
<td>Gadus morhua</td>
<td>unknown</td>
<td>Dasyatis pastinaca</td>
<td>MOLVA DYPTERYGIA</td>
<td>PLATICHTHYS FLESUS</td>
<td>SOLEA SOLEA (S.VULGARIS)</td>
<td>LAMINARIA DIGITATA</td>
<td>Galeus melastomus</td>
<td>Fucus serratus</td>
<td>Anarhichas denticulatus</td>
<td>Hippoglossus hippoglossus</td>
<td>Penaeus vannamei</td>
<td>Anguilla anguilla</td>
<td>FUCUS spp</td>
<td>HIPPOGLOSSUS HIPPOGLOSSUS</td>
<td>Gadus morhua</td>
<td>Sebastes marinus</td>
<td>Scomber scombrus</td>
<td>Merluccius merluccius</td>
<td>Mallotus villosus</td>
<td>Capros aper</td>
<td>Homarus gammarus</td>
<td>SCOMBER SCOMBRUS</td>
<td>DIPTURUS BATIS</td>
<td>SEBASTES MENTELLA</td>
<td>Clupea harengus</td>
<td>Limanda Limanda</td>
<td>Sepia spp.</td>
<td>Cerastoderma edule</td>
<td>CHIMAERA MONSTROSA</td>
<td>MONODONTA LINEATA</td>
<td>Dicentrarchus labrax</td>
<td>LIMANDA LIMANDA</td>
<td>PLEURONECTES PLATESSA</td>
<td>Unknown</td>
<td>PORPHYRA UMBILICALIS</td>
<td>PATELLA</td>
<td>RHODYMENIA spp</td>
<td>Glyptocephalus cynoglossus</td>
<td>MOLVA MOLVA</td>
<td>Boreogadus saida</td>
<td>Trisopterus esmarki</td>
<td>Reinhardtius hippoglossoides</td>
<td>Boreogadus Saida</td>
<td>Ostrea edulis</td>
<td>Flatfish</td>
<td>Pelvetia canaliculata</td>
<td>BOREOGADUS SAIDA</td>
<td>Patella sp.</td>
<td>Ascophyllum nodosum</td>
<td>SCOPHTHALMUS RHOMBUS</td>
<td>MERLUCCIUS MERLUCCIUS</td>
<td>Mytilus Edulis</td>
<td>Gaidropsarus argenteus</td>
<td>RHODYMENIA PSEUDOPALAMATA &amp; PALMARIA PALMATA</td>
<td>Cyclopterus lumpus</td>
<td>MICROMESISTIUS POUTASSOU</td>
<td>Fucus Vesiculosus</td>
<td>PECTEN MAXIMUS</td>
<td>REINHARDTIUS HIPPOGLOSSOIDES</td>
<td>Squalus acanthias</td>
<td>TRACHURUS TRACHURUS</td>
<td>SPRATTUS SPRATTUS</td>
<td>Mytilus edulis</td>
<td>PELVETIA CANALICULATA</td>
<td>CRASSOSTREA GIGAS</td>
<td>Trisopterus minutus</td>
<td>Melanogrammus aeglefinus</td>
<td>PLUERONECTES PLATESSA</td>
<td>MERLANGIUS MERLANGUS</td>
<td>PATELLA VULGATA</td>
<td>Salmo salar</td>
<td>Cerastoderma (Cardium) Edule</td>
<td>Limanda limanda</td>
<td>MYTILUS EDULIS</td>
<td>Clupea Harengus</td>
<td>Pollachius virens</td>
<td>Trisopterus esmarkii</td>
<td>ASCOPHYLLUN NODOSUM</td>
<td>Fucus sp.</td>
<td>Merlangius merlangus</td>
<td>Melanogrammus aeglefinus</td>
<td>Tapes sp.</td>
<td>Fucus vesiculosus</td>
<td>Coryphaenoides rupestris</td>
<td>Rhodymenia spp.</td>
<td>Argentina silus</td>
<td>PALMARIA PALMATA</td>
<td>DICENTRARCHUS (MORONE) LABRAX</td>
<td>Gadus Morhua</td>
<td>OSTREA EDULIS</td>
<td>Lumpenus lampretaeformis</td>
<td>MELANOGRAMMUS AEGLEFINUS</td>
<td>Pollachius pollachius</td>
<td>Sebastes mentella</td>
<td>Pleuronectiformes [order]</td>
<td>FUCUS SPIRALIS</td>
<td>NUCELLA LAPILLUS</td>
<td>CERASTODERMA (CARDIUM) EDULE</td>
<td>Anarhichas lupus</td>
<td>Gadiculus argenteus</td>
<td>Clupea harengus</td>
<td>BROSME BROSME</td>
<td>Trachurus trachurus</td>
<td>Lycodes vahlii</td>
<td>Platichthys flesus</td>
<td>LITTORINA LITTOREA</td>
<td>OSILINUS LINEATUS</td>
<td>FUCUS VESICULOSUS</td>
<td>Argentina sphyraena</td>
<td>CLUPEA HARENGUS</td>
<td>PECTINIDAE</td>
<td>Eutrigla gurnardus</td>
<td>Lophius piscatorius</td>
<td>GLYPTOCEPHALUS CYNOGLOSSUS</td>
<td>EUTRIGLA GURNARDUS</td>
<td>Sprattus sprattus</td>
<td>Pleuronectes platessa</td>
<td>Sebastes viviparus</td>
<td>MERLUCCIUS MERLUCCIUS</td>
<td>POLLACHIUS VIRENS</td>
<td>RAJIDAE/BATOIDEA</td>
<td>Ostrea Edulis</td>
<td>Sebastes Mentella</td>
<td>Crassostrea gigas</td>
<td>GADUS MORHUA</td>
<td>Littorina littorea</td>
<td>Phycis blennoides</td>
<td>Merlangius Merlangus</td>
<td>Raja montagui</td>
<td>Micromesistius poutassou</td>
<td>ASCOPHYLLUM NODOSUM</td>
<td>HIPPOGLOSSOIDES PLATESSOIDES</td>
<td>NaN</td>
<td>CYCLOPTERUS LUMPUS</td>
<td>Hippoglossoides platessoides</td>
<td>Modiolus modiolus</td>
<td>Gadus sp.</td>
<td>ETMOPTERUS SPINAX</td>
<td>RAJA DIPTURUS BATIS</td>
<td>Hyperoplus lanceolatus</td>
<td>Sebastes norvegicus</td>
<td>Pleuronectes platessa</td>
<td>SEBASTES MARINUS</td>
<td>Solea solea (S.vulgaris)</td>
<td>Sebastes vivipares</td>
<td>Pecten maximus</td>
<td>Thunnus thynnus</td>
<td>MERLANGUIS MERLANGUIS</td>
<td>Microstomus kitt</td>
<td>FUCUS SERRATUS</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We attempt to <strong>match</strong> the OSPAR <code>species</code> column to the <code>species</code> column of the MARIS nomenclature using the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> . First, we initialize the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>:</p>
<div id="4f6e4a3d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'species'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'species_ospar.pkl'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next, we perform the matching and generate a lookup table that includes the match score, which quantifies the degree of match accuracy:</p>
<div id="1cb98f5b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/167 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 167/167 [00:23&lt;00:00,  7.21it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>129 entries matched the criteria, while 38 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">RHODYMENIA PSEUDOPALAMATA &amp; PALMARIA PALMATA</th>
<td>Lomentaria catenata</td>
<td>RHODYMENIA PSEUDOPALAMATA &amp; PALMARIA PALMATA</td>
<td>31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Mixture of green, red and brown algae</th>
<td>Mercenaria mercenaria</td>
<td>Mixture of green, red and brown algae</td>
<td>26</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Solea solea (S.vulgaris)</th>
<td>Loligo vulgaris</td>
<td>Solea solea (S.vulgaris)</td>
<td>12</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">SOLEA SOLEA (S.VULGARIS)</th>
<td>Loligo vulgaris</td>
<td>SOLEA SOLEA (S.VULGARIS)</td>
<td>12</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Cerastoderma (Cardium) Edule</th>
<td>Cerastoderma edule</td>
<td>Cerastoderma (Cardium) Edule</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">CERASTODERMA (CARDIUM) EDULE</th>
<td>Cerastoderma edule</td>
<td>CERASTODERMA (CARDIUM) EDULE</td>
<td>10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">DICENTRARCHUS (MORONE) LABRAX</th>
<td>Dicentrarchus labrax</td>
<td>DICENTRARCHUS (MORONE) LABRAX</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">RAJIDAE/BATOIDEA</th>
<td>Batoidea</td>
<td>RAJIDAE/BATOIDEA</td>
<td>8</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Pleuronectiformes [order]</th>
<td>Pleuronectiformes</td>
<td>Pleuronectiformes [order]</td>
<td>8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">PALMARIA PALMATA</th>
<td>Alaria marginata</td>
<td>PALMARIA PALMATA</td>
<td>7</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gadiculus argenteus</th>
<td>Pampus argenteus</td>
<td>Gadiculus argenteus</td>
<td>6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MONODONTA LINEATA</th>
<td>Monodonta labio</td>
<td>MONODONTA LINEATA</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">RAJA DIPTURUS BATIS</th>
<td>Dipturus batis</td>
<td>RAJA DIPTURUS BATIS</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rhodymenia spp.</th>
<td>Rhodymenia</td>
<td>Rhodymenia spp.</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">FUCUS SPP.</th>
<td>Fucus</td>
<td>FUCUS SPP.</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Unknown</th>
<td>Undaria</td>
<td>Unknown</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">unknown</th>
<td>Undaria</td>
<td>unknown</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Flatfish</th>
<td>Lambia</td>
<td>Flatfish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Sepia spp.</th>
<td>Sepia</td>
<td>Sepia spp.</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Patella sp.</th>
<td>Patella</td>
<td>Patella sp.</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gadus sp.</th>
<td>Penaeus sp.</td>
<td>Gadus sp.</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Thunnus sp.</th>
<td>Thunnus</td>
<td>Thunnus sp.</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">FUCUS spp</th>
<td>Fucus</td>
<td>FUCUS spp</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Fucus sp.</th>
<td>Fucus</td>
<td>Fucus sp.</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Tapes sp.</th>
<td>Tapes</td>
<td>Tapes sp.</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">RHODYMENIA spp</th>
<td>Rhodymenia</td>
<td>RHODYMENIA spp</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MERLANGUIS MERLANGUIS</th>
<td>Merlangius merlangus</td>
<td>MERLANGUIS MERLANGUIS</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">PLUERONECTES PLATESSA</th>
<td>Pleuronectes platessa</td>
<td>PLUERONECTES PLATESSA</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gaidropsarus argenteus</th>
<td>Gaidropsarus argentatus</td>
<td>Gaidropsarus argenteus</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Trisopterus esmarki</th>
<td>Trisopterus esmarkii</td>
<td>Trisopterus esmarki</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ASCOPHYLLUN NODOSUM</th>
<td>Ascophyllum nodosum</td>
<td>ASCOPHYLLUN NODOSUM</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Clupea harengus</th>
<td>Clupea harengus</td>
<td>Clupea harengus</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MERLUCCIUS MERLUCCIUS</th>
<td>Merluccius merluccius</td>
<td>MERLUCCIUS MERLUCCIUS</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Hippoglossus hippoglossus</th>
<td>Hippoglossus hippoglossus</td>
<td>Hippoglossus hippoglossus</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Melanogrammus aeglefinus</th>
<td>Melanogrammus aeglefinus</td>
<td>Melanogrammus aeglefinus</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Pleuronectes platessa</th>
<td>Pleuronectes platessa</td>
<td>Pleuronectes platessa</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gadus morhua</th>
<td>Gadus morhua</td>
<td>Gadus morhua</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Sebastes vivipares</th>
<td>Sebastes viviparus</td>
<td>Sebastes vivipares</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Below, we <strong>fix</strong> the entries that are not properly matched by the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>:</p>
<div id="f073cc1b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>fixes_biota_species <span class="op">=</span> {</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RHODYMENIA PSEUDOPALAMATA &amp; PALMARIA PALMATA'</span>: NA,  <span class="co"># Mix of species, no direct mapping</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mixture of green, red and brown algae'</span>: NA,  <span class="co"># Mix of species, no direct mapping</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Solea solea (S.vulgaris)'</span>: <span class="st">'Solea solea'</span>,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SOLEA SOLEA (S.VULGARIS)'</span>: <span class="st">'Solea solea'</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RAJIDAE/BATOIDEA'</span>: NA, <span class="co">#Mix of species, no direct mapping</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PALMARIA PALMATA'</span>: NA,  <span class="co"># Not defined</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Unknown'</span>: NA,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'unknown'</span>: NA,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Flatfish'</span>: NA,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gadus sp.'</span>: NA,  <span class="co"># Not defined</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>We can now review the remapping results, incorporating the adjustments from the <code>fixes_biota_species</code> dictionary:</p>
<div id="fdc3e95a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(fixes<span class="op">=</span>fixes_biota_species)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/167 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 167/167 [00:24&lt;00:00,  6.88it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>139 entries matched the criteria, while 28 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">CERASTODERMA (CARDIUM) EDULE</th>
<td>Cerastoderma edule</td>
<td>CERASTODERMA (CARDIUM) EDULE</td>
<td>10</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Cerastoderma (Cardium) Edule</th>
<td>Cerastoderma edule</td>
<td>Cerastoderma (Cardium) Edule</td>
<td>10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">DICENTRARCHUS (MORONE) LABRAX</th>
<td>Dicentrarchus labrax</td>
<td>DICENTRARCHUS (MORONE) LABRAX</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Pleuronectiformes [order]</th>
<td>Pleuronectiformes</td>
<td>Pleuronectiformes [order]</td>
<td>8</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gadiculus argenteus</th>
<td>Pampus argenteus</td>
<td>Gadiculus argenteus</td>
<td>6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MONODONTA LINEATA</th>
<td>Monodonta labio</td>
<td>MONODONTA LINEATA</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">FUCUS SPP.</th>
<td>Fucus</td>
<td>FUCUS SPP.</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">RAJA DIPTURUS BATIS</th>
<td>Dipturus batis</td>
<td>RAJA DIPTURUS BATIS</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Sepia spp.</th>
<td>Sepia</td>
<td>Sepia spp.</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rhodymenia spp.</th>
<td>Rhodymenia</td>
<td>Rhodymenia spp.</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Tapes sp.</th>
<td>Tapes</td>
<td>Tapes sp.</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">FUCUS spp</th>
<td>Fucus</td>
<td>FUCUS spp</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">RHODYMENIA spp</th>
<td>Rhodymenia</td>
<td>RHODYMENIA spp</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Patella sp.</th>
<td>Patella</td>
<td>Patella sp.</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Thunnus sp.</th>
<td>Thunnus</td>
<td>Thunnus sp.</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Fucus sp.</th>
<td>Fucus</td>
<td>Fucus sp.</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MERLANGUIS MERLANGUIS</th>
<td>Merlangius merlangus</td>
<td>MERLANGUIS MERLANGUIS</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">PLUERONECTES PLATESSA</th>
<td>Pleuronectes platessa</td>
<td>PLUERONECTES PLATESSA</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gaidropsarus argenteus</th>
<td>Gaidropsarus argentatus</td>
<td>Gaidropsarus argenteus</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Melanogrammus aeglefinus</th>
<td>Melanogrammus aeglefinus</td>
<td>Melanogrammus aeglefinus</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Trisopterus esmarki</th>
<td>Trisopterus esmarkii</td>
<td>Trisopterus esmarki</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Hippoglossus hippoglossus</th>
<td>Hippoglossus hippoglossus</td>
<td>Hippoglossus hippoglossus</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Clupea harengus</th>
<td>Clupea harengus</td>
<td>Clupea harengus</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MERLUCCIUS MERLUCCIUS</th>
<td>Merluccius merluccius</td>
<td>MERLUCCIUS MERLUCCIUS</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Gadus morhua</th>
<td>Gadus morhua</td>
<td>Gadus morhua</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Pleuronectes platessa</th>
<td>Pleuronectes platessa</td>
<td>Pleuronectes platessa</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Sebastes vivipares</th>
<td>Sebastes viviparus</td>
<td>Sebastes vivipares</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ASCOPHYLLUN NODOSUM</th>
<td>Ascophyllum nodosum</td>
<td>ASCOPHYLLUN NODOSUM</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Visual inspection of the remaining imperfectly matched entries appears acceptable. We can now define a Remapper Lambda Function that instantiates the Remapper and returns the corrected lookup table.</p>
<div id="3764bf4c" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>lut_biota <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'species'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>                             maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>                             maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>                             maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                             provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                             provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>                             fname_cache<span class="op">=</span><span class="st">'species_ospar.pkl'</span>).generate_lookup_table(fixes<span class="op">=</span>fixes_biota_species, </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                                                                                    as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Putting it all together, we now apply the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> callback to our data. This process adds a <code>SPECIES</code> column to our <code>BIOTA</code> dataframe, which contains the standardized species IDs.</p>
<div id="f88311de" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)    </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>tfm()[<span class="st">'BIOTA'</span>][<span class="st">'SPECIES'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 377,  129,   96,    0,  192,   99,   50,  378,  270,  379,  380,
        381,  382,  383,  384,  385,  244,  386,  387,  388,  389,  390,
        391,  392,  393,  394,  395,  396,  274,  397,  398,  243,  399,
        400,  401,  402,  403,  404,  405,  406,  407,  191,  139,  408,
        410,  412,  413,  272,  414,  415,  416,  417,  418,  419,  420,
        421,  422,  423,  424,  425,  426,  427,  428,  411,  429,  430,
        431,  432,  433,  434,  435,  436,  437,  438,  439,  440,  441,
        442,  443,  444,  294, 1684, 1610, 1609, 1605, 1608,   23, 1606,
        234,  556, 1701, 1752,  158,  223])</code></pre>
</div>
</div>
</section>
<section id="enhance-species-data-using-biological-group." class="level2">
<h2 class="anchored" data-anchor-id="enhance-species-data-using-biological-group.">Enhance Species Data Using Biological group.</h2>
<p>The <code>Biological group</code> column in the <code>OSPAR</code> dataset provides valuable insights related to species. We will leverage this information to enrich the <code>SPECIES</code> column. To achieve this, we will employ the generic <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> callback to create an <code>enhanced_species</code> column. Subsequently, this <code>enhanced_species</code> column will be used to further enrich the <code>SPECIES</code> column.</p>
<p>First we inspect the unique values in the <code>biological group</code> column.</p>
<div id="af6d12c8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'biological group'</span>, as_df<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>Seaweed</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>FISH</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>Molluscs</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>MOLLUSCS</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>4</td>
<td>seaweed</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>5</td>
<td>SEAWEED</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>6</td>
<td>Seaweeds</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>7</td>
<td>Fish</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>8</td>
<td>fish</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>9</td>
<td>molluscs</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We will remap the <code>biological group</code> columns data to the <code>species</code> column of the MARIS nomenclature, again using a <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> object:</p>
<div id="b4f0d0b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'biological group'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'enhance_species_ospar.pkl'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Like before we will <strong>inspect</strong> the data.</p>
<div id="5b3ffe41" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 10/10 [00:02&lt;00:00,  4.80it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">FISH</th>
<td>Fucus</td>
<td>FISH</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Fish</th>
<td>Fucus</td>
<td>Fish</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">fish</th>
<td>Fucus</td>
<td>fish</td>
<td>4</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Molluscs</th>
<td>Mollusca</td>
<td>Molluscs</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">MOLLUSCS</th>
<td>Mollusca</td>
<td>MOLLUSCS</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Seaweeds</th>
<td>Seaweed</td>
<td>Seaweeds</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">molluscs</th>
<td>Mollusca</td>
<td>molluscs</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see that some entries require manual <strong>fixes</strong>.</p>
<div id="4a721e88" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>fixes_enhanced_biota_species <span class="op">=</span> {</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fish'</span>: <span class="st">'Pisces'</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FISH'</span>: <span class="st">'Pisces'</span>,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fish'</span>: <span class="st">'Pisces'</span>    </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we will apply the manual <strong>fixes</strong> to the lookup table and review.</p>
<div id="ef98d33b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(fixes<span class="op">=</span>fixes_enhanced_biota_species)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/10 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 10/10 [00:01&lt;00:00,  7.11it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Molluscs</th>
<td>Mollusca</td>
<td>Molluscs</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MOLLUSCS</th>
<td>Mollusca</td>
<td>MOLLUSCS</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Seaweeds</th>
<td>Seaweed</td>
<td>Seaweeds</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">molluscs</th>
<td>Mollusca</td>
<td>molluscs</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Visual inspection of the remaining imperfectly matched entries appears acceptable. We can now define a Remapper Lambda Function that instantiates the Remapper and returns the corrected lookup table.</p>
<div id="d430aca5" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>lut_biota_enhanced <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs, col_name<span class="op">=</span><span class="st">'biological group'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                             maris_lut_fn<span class="op">=</span>species_lut_path,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>                             maris_col_id<span class="op">=</span><span class="st">'species_id'</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>                             maris_col_name<span class="op">=</span><span class="st">'species'</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>                             provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>                             provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>                             fname_cache<span class="op">=</span><span class="st">'enhance_species_ospar.pkl'</span>).generate_lookup_table(</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>                                 fixes<span class="op">=</span>fixes_enhanced_biota_species, </span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>                                 as_df<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>                                 overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we can apply <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> which results in the addition of an <code>enhanced_species</code> column in our <code>BIOTA</code> DataFrame.</p>
<div id="1dd3de4a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)    </span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>tfm()[<span class="st">'BIOTA'</span>][<span class="st">'enhanced_species'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 873, 1059,  712])</code></pre>
</div>
</div>
<p>With the <code>enhanced_species</code> column, we can enrich the <code>SPECIES</code> column. We will use the value in <code>enhanced_species</code> column in the absence of a <code>SPECIES</code> match if the <code>enhanced_species</code> column is valid.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/ospar.py#L378" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="enhancespeciescb" class="level3">
<h3 class="anchored" data-anchor-id="enhancespeciescb">EnhanceSpeciesCB</h3>
<blockquote class="blockquote">
<pre><code> EnhanceSpeciesCB ()</code></pre>
</blockquote>
<p><em>Enhance the ‘SPECIES’ column using the ‘enhanced_species’ column if conditions are met.</em></p>
<div id="358de0aa" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EnhanceSpeciesCB(Callback):</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Enhance the 'SPECIES' column using the 'enhanced_species' column if conditions are met."""</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: <span class="st">'Transformer'</span>):</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._enhance_species(tfm.dfs[<span class="st">'BIOTA'</span>])</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _enhance_species(<span class="va">self</span>, df: pd.DataFrame):</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'SPECIES'</span>] <span class="op">=</span> df.<span class="bu">apply</span>(</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> row: row[<span class="st">'enhanced_species'</span>] <span class="cf">if</span> row[<span class="st">'SPECIES'</span>] <span class="kw">in</span> [<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>] <span class="kw">and</span> pd.notnull(row[<span class="st">'enhanced_species'</span>]) <span class="cf">else</span> row[<span class="st">'SPECIES'</span>],</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="a3ae46a0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    EnhanceSpeciesCB()</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>tfm()[<span class="st">'BIOTA'</span>][<span class="st">'SPECIES'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 377,  129,   96,  712,  192,   99,   50,  378,  270,  379,  380,
        381,  382,  383,  384,  385,  244,  386,  387,  388,  389,  390,
        391,  392,  393,  394,  395,  396,  274,  397,  398,  243,  399,
        400,  401,  402,  403,  404,  405,  406,  407, 1059,  191,  139,
        408,  410,  412,  413,  272,  414,  415,  416,  417,  418,  419,
        420,  421,  422,  423,  424,  425,  426,  427,  428,  411,  429,
        430,  431,  432,  433,  434,  435,  436,  437,  438,  439,  440,
        441,  442,  443,  444,  294, 1684, 1610, 1609, 1605, 1608,   23,
       1606,  234,  556, 1701, 1752,  158,  223])</code></pre>
</div>
</div>
<p>All entries are matched for the <code>SPECIES</code> column.</p>
</section>
</section>
<section id="remap-biota-tissues" class="level2">
<h2 class="anchored" data-anchor-id="remap-biota-tissues">Remap Biota tissues</h2>
<p>The <code>OSPAR</code> dataset includes entries where the <code>Body Part</code> is labeled as <code>whole</code>. However, the <code>MARIS</code> data standard requires a more specific distinction for the <code>body_part</code> field, differentiating between <code>Whole animal</code> and <code>Whole plant</code>. Fortunately, the OSPAR dataset provides a <code>Biological group</code> field that allows us to make this distinction.</p>
<p>To address this discrepancy and ensure compatibility with MARIS standards, we will: 1. Create a temporary column <code>body_part_temp</code> that combines information from both <code>Body Part</code> and <code>Biological group</code>. 2. Use this temporary column to perform the lookup using our <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a> object.</p>
<p>Lets create the temporary column, <code>body_part_temp</code>, that combines <code>Body Part</code> and <code>Biological group</code>.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/ospar.py#L394" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addbodyparttempcb" class="level3">
<h3 class="anchored" data-anchor-id="addbodyparttempcb">AddBodypartTempCB</h3>
<blockquote class="blockquote">
<pre><code> AddBodypartTempCB ()</code></pre>
</blockquote>
<p><em>Add a temporary column with the body part and biological group combined.</em></p>
<div id="268eb1e3" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddBodypartTempCB(Callback):</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Add a temporary column with the body part and biological group combined."</span>    </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>        tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'body_part_temp'</span>] <span class="op">=</span> (</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>            tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'body part'</span>] <span class="op">+</span> <span class="st">' '</span> <span class="op">+</span> </span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>            tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'biological group'</span>]</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>            ).<span class="bu">str</span>.strip().<span class="bu">str</span>.lower()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="220d4ead" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[  </span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                            AddBodypartTempCB(),</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>dfs_test <span class="op">=</span> tfm()</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>dfs_test[<span class="st">'BIOTA'</span>][<span class="st">'body_part_temp'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array(['whole animal molluscs', 'whole plant seaweed', 'whole fish fish',
       'flesh without bones fish', 'whole animal fish', 'muscle fish',
       'head fish', 'soft parts molluscs', 'growing tips seaweed',
       'soft parts fish', 'unknown fish', 'flesh without bone fish',
       'flesh fish', 'flesh with scales fish', 'liver fish',
       'flesh without bones seaweed', 'whole  fish',
       'flesh without bones molluscs', 'whole  seaweed',
       'whole plant seaweeds', 'whole fish', 'whole without head fish',
       'mix of muscle and whole fish without liver fish',
       'whole fisk fish', 'muscle  fish', 'cod medallion fish',
       'tail and claws fish'], dtype=object)</code></pre>
</div>
</div>
<p>To align the <code>body_part_temp</code> column with the <code>bodypar</code> column in the MARIS nomenclature, we will use the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>. However, since the OSPAR dataset lacks a predefined lookup table for the <code>body_part</code> column, we must first create one. This is accomplished by extracting unique values from the <code>body_part_temp</code> column.</p>
<div id="7dd02af8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>get_unique_across_dfs(dfs_test, col_name<span class="op">=</span><span class="st">'body_part_temp'</span>, as_df<span class="op">=</span><span class="va">True</span>).head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">index</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>whole fish</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>whole without head fish</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>flesh with scales fish</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>mix of muscle and whole fish without liver fish</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>4</td>
<td>whole animal fish</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can now remap the <code>body_part_temp</code> column to the <code>bodypar</code> column in the MARIS nomenclature using the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>. Subsequently, we will <strong>inspect</strong> the results:</p>
<div id="6a76c31c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>remapper <span class="op">=</span> Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(dfs_test, col_name<span class="op">=</span><span class="st">'body_part_temp'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>                    maris_lut_fn<span class="op">=</span>bodyparts_lut_path,</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>                    maris_col_id<span class="op">=</span><span class="st">'bodypar_id'</span>,</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>                    maris_col_name<span class="op">=</span><span class="st">'bodypar'</span>,</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>                    provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>                    provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>                    fname_cache<span class="op">=</span><span class="st">'tissues_ospar.pkl'</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(as_df<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">0</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/27 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 27/27 [00:00&lt;00:00, 128.32it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>0 entries matched the criteria, while 27 entries had a match score of 0 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">mix of muscle and whole fish without liver fish</th>
<td>Flesh without bones</td>
<td>mix of muscle and whole fish without liver fish</td>
<td>31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">tail and claws fish</th>
<td>Stomach and intestine</td>
<td>tail and claws fish</td>
<td>13</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cod medallion fish</th>
<td>Old leaf</td>
<td>cod medallion fish</td>
<td>13</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole without head fish</th>
<td>Flesh without bones</td>
<td>whole without head fish</td>
<td>13</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fish fish</th>
<td>Whole animal</td>
<td>whole fish fish</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole fisk fish</th>
<td>Whole animal</td>
<td>whole fisk fish</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole animal molluscs</th>
<td>Whole animal</td>
<td>whole animal molluscs</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bones molluscs</th>
<td>Flesh without bones</td>
<td>flesh without bones molluscs</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole plant seaweeds</th>
<td>Whole plant</td>
<td>whole plant seaweeds</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">soft parts molluscs</th>
<td>Soft parts</td>
<td>soft parts molluscs</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">unknown fish</th>
<td>Growing tips</td>
<td>unknown fish</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bones seaweed</th>
<td>Flesh without bones</td>
<td>flesh without bones seaweed</td>
<td>8</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole plant seaweed</th>
<td>Whole plant</td>
<td>whole plant seaweed</td>
<td>8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">growing tips seaweed</th>
<td>Growing tips</td>
<td>growing tips seaweed</td>
<td>8</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">flesh fish</th>
<td>Shells</td>
<td>flesh fish</td>
<td>7</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole seaweed</th>
<td>Whole plant</td>
<td>whole seaweed</td>
<td>7</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">muscle fish</th>
<td>Muscle</td>
<td>muscle fish</td>
<td>6</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">soft parts fish</th>
<td>Soft parts</td>
<td>soft parts fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fish</th>
<td>Whole animal</td>
<td>whole fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">head fish</th>
<td>Head</td>
<td>head fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">liver fish</th>
<td>Liver</td>
<td>liver fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole fish</th>
<td>Whole animal</td>
<td>whole fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">muscle fish</th>
<td>Muscle</td>
<td>muscle fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole animal fish</th>
<td>Whole animal</td>
<td>whole animal fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">flesh with scales fish</th>
<td>Flesh with scales</td>
<td>flesh with scales fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bones fish</th>
<td>Flesh without bones</td>
<td>flesh without bones fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">flesh without bone fish</th>
<td>Flesh without bones</td>
<td>flesh without bone fish</td>
<td>4</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Many of the lookup entries are sufficient for our needs. However, for values that don’t find a match, we can use the <code>fixes_biota_bodyparts</code> dictionary to apply manual corrections. First we will create the dictionary.</p>
<div id="952b57d7" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>fixes_biota_tissues <span class="op">=</span> {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'whole seaweed'</span> : <span class="st">'Whole plant'</span>,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'flesh fish'</span>: <span class="st">'Flesh with bones'</span>, <span class="co"># We assume it as the category 'Flesh with bones' also exists</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'flesh fish'</span> : <span class="st">'Flesh with bones'</span>,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'unknown fish'</span> : NA,</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'unknown fish'</span> : NA,</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cod medallion fish'</span> : NA, <span class="co"># TO BE DETERMINED</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'mix of muscle and whole fish without liver fish'</span> : NA, <span class="co"># TO BE DETERMINED</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'whole without head fish'</span> : NA, <span class="co"># TO BE DETERMINED</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'flesh without bones seaweed'</span> : NA, <span class="co"># TO BE DETERMINED</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'tail and claws fish'</span> : NA <span class="co"># TO BE DETERMINED</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Now we will generate the lookup table and apply the manual <em>fixes</em> defined in the <code>fixes_biota_bodyparts</code> dictionary.</p>
<div id="82605749" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>remapper.generate_lookup_table(fixes<span class="op">=</span>fixes_biota_tissues)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>remapper.select_match(match_score_threshold<span class="op">=</span><span class="dv">1</span>, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing:   0%|          | 0/27 [00:00&lt;?, ?it/s]Processing: 100%|██████████| 27/27 [00:00&lt;00:00, 143.57it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1 entries matched the criteria, while 26 entries had a match score of 1 or higher.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">matched_maris_name</th>
<th data-quarto-table-cell-role="th">source_name</th>
<th data-quarto-table-cell-role="th">match_score</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">source_key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fisk fish</th>
<td>Whole animal</td>
<td>whole fisk fish</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">soft parts molluscs</th>
<td>Soft parts</td>
<td>soft parts molluscs</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fish fish</th>
<td>Whole animal</td>
<td>whole fish fish</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bones molluscs</th>
<td>Flesh without bones</td>
<td>flesh without bones molluscs</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole animal molluscs</th>
<td>Whole animal</td>
<td>whole animal molluscs</td>
<td>9</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole plant seaweeds</th>
<td>Whole plant</td>
<td>whole plant seaweeds</td>
<td>9</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">growing tips seaweed</th>
<td>Growing tips</td>
<td>growing tips seaweed</td>
<td>8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole plant seaweed</th>
<td>Whole plant</td>
<td>whole plant seaweed</td>
<td>8</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole seaweed</th>
<td>Whole plant</td>
<td>whole seaweed</td>
<td>7</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">muscle fish</th>
<td>Muscle</td>
<td>muscle fish</td>
<td>6</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">muscle fish</th>
<td>Muscle</td>
<td>muscle fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">liver fish</th>
<td>Liver</td>
<td>liver fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">flesh with scales fish</th>
<td>Flesh with scales</td>
<td>flesh with scales fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">soft parts fish</th>
<td>Soft parts</td>
<td>soft parts fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fish</th>
<td>Whole animal</td>
<td>whole fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">head fish</th>
<td>Head</td>
<td>head fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">flesh without bones fish</th>
<td>Flesh without bones</td>
<td>flesh without bones fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole animal fish</th>
<td>Whole animal</td>
<td>whole animal fish</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">whole fish</th>
<td>Whole animal</td>
<td>whole fish</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bone fish</th>
<td>Flesh without bones</td>
<td>flesh without bone fish</td>
<td>4</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">cod medallion fish</th>
<td>(Not available)</td>
<td>cod medallion fish</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">flesh without bones seaweed</th>
<td>(Not available)</td>
<td>flesh without bones seaweed</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">unknown fish</th>
<td>(Not available)</td>
<td>unknown fish</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">whole without head fish</th>
<td>(Not available)</td>
<td>whole without head fish</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mix of muscle and whole fish without liver fish</th>
<td>(Not available)</td>
<td>mix of muscle and whole fish without liver fish</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">tail and claws fish</th>
<td>(Not available)</td>
<td>tail and claws fish</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>At this stage, the majority of entries have been successfully matched to the MARIS nomenclature. Entries that remain unmatched are appropriately marked as ‘not available’. We are now ready to proceed with the final remapping process. We will define a lambda function to instantiate the <a href="https://franckalbinet.github.io/marisco/api/utils.html#remapper"><code>Remapper</code></a>, which will then generate and return the corrected lookup table.</p>
<div id="38e2a17f" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>lut_bodyparts <span class="op">=</span> <span class="kw">lambda</span>: Remapper(provider_lut_df<span class="op">=</span>get_unique_across_dfs(tfm.dfs, col_name<span class="op">=</span><span class="st">'body_part_temp'</span>, as_df<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>                               maris_lut_fn<span class="op">=</span>bodyparts_lut_path,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>                               maris_col_id<span class="op">=</span><span class="st">'bodypar_id'</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>                               maris_col_name<span class="op">=</span><span class="st">'bodypar'</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>                               provider_col_to_match<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>                               provider_col_key<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>                               fname_cache<span class="op">=</span><span class="st">'tissues_ospar.pkl'</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>                               ).generate_lookup_table(fixes<span class="op">=</span>fixes_biota_tissues, as_df<span class="op">=</span><span class="va">False</span>, overwrite<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Putting it all together, we now apply the <a href="https://franckalbinet.github.io/marisco/api/callbacks.html#remapcb"><code>RemapCB</code></a> callback. This process results in the addition of a <code>BODY_PART</code> column to our <code>BIOTA</code> DataFrame.</p>
<div id="ac6ee355" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[  </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>                            RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>                            AddBodypartTempCB(),</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_bodyparts, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'body_part_temp'</span> , dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'BODY_PART'</span>].unique()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array([ 1, 40, 52, 34, 13, 19, 56,  0,  4, 60, 25])</code></pre>
</div>
</div>
</section>
</section>
<section id="remap-biogroup" class="level2">
<h2 class="anchored" data-anchor-id="remap-biogroup">Remap biogroup</h2>
<p>The MARIS species lookup table contains a <code>biogroup_id</code> column that associates each species with its corresponding <code>biogroup</code>. We will leverage this relationship to create a <code>BIO_GROUP</code> column in the <code>BIOTA</code> DataFrame.</p>
<div id="6c2ccab7" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>lut_biogroup_from_biota <span class="op">=</span> <span class="kw">lambda</span>: get_lut(src_dir<span class="op">=</span>species_lut_path().parent, fname<span class="op">=</span>species_lut_path().name, </span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>                               key<span class="op">=</span><span class="st">'species_id'</span>, value<span class="op">=</span><span class="st">'biogroup_id'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="bf25b271" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[ </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),                            </span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    EnhanceSpeciesCB(),</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    RemapCB(fn_lut<span class="op">=</span>lut_biogroup_from_biota, col_remap<span class="op">=</span><span class="st">'BIO_GROUP'</span>, col_src<span class="op">=</span><span class="st">'SPECIES'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>)</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tfm.dfs[<span class="st">'BIOTA'</span>][<span class="st">'BIO_GROUP'</span>].unique())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span> <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span><span style="font-weight: bold">]</span>
</pre>
</div>
</div>
<div id="c2fb283a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">rsc sub-division</th>
<th data-quarto-table-cell-role="th">station id</th>
<th data-quarto-table-cell-role="th">sample id</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">data provider</th>
<th data-quarto-table-cell-role="th">measurement comment</th>
<th data-quarto-table-cell-role="th">sample comment</th>
<th data-quarto-table-cell-role="th">reference comment</th>
<th data-quarto-table-cell-role="th">SPECIES</th>
<th data-quarto-table-cell-role="th">enhanced_species</th>
<th data-quarto-table-cell-role="th">BIO_GROUP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17531</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>0.326416</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>377</td>
<td>873</td>
<td>14</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17534</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>0.442704</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>377</td>
<td>873</td>
<td>14</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17537</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>0.412989</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>377</td>
<td>873</td>
<td>14</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17540</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>0.202768</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>377</td>
<td>873</td>
<td>14</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>5</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17531</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>0.652833</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>377</td>
<td>873</td>
<td>14</td>
</tr>
</tbody>
</table>

<p>5 rows × 30 columns</p>
</div>
</div>
</div>
</section>
<section id="add-sample-id" class="level2">
<h2 class="anchored" data-anchor-id="add-sample-id">Add Sample ID</h2>
<ul>
<li><code>SMP_ID</code> is a internal unique identifier for each sample</li>
<li><code>SMP_ID_PROVIDER</code> is data provided by the data provider.</li>
</ul>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/ospar.py#L431" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addsampleidcb" class="level3">
<h3 class="anchored" data-anchor-id="addsampleidcb">AddSampleIdCB</h3>
<blockquote class="blockquote">
<pre><code> AddSampleIdCB ()</code></pre>
</blockquote>
<p><em>Create incremental SMP_ID and store original sample id in SMP_ID_PROVIDER</em></p>
<div id="a065b30a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddSampleIdCB(Callback):</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create incremental SMP_ID and store original sample id in SMP_ID_PROVIDER"</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm):</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'SMP_ID'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(df) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'SMP_ID_PROVIDER'</span>] <span class="op">=</span> df[<span class="st">'sample id'</span>].astype(<span class="bu">str</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="4ade901d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>                            AddSampleIdCB(),</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'BIOTA'</span>].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">rsc sub-division</th>
<th data-quarto-table-cell-role="th">station id</th>
<th data-quarto-table-cell-role="th">sample id</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">value type</th>
<th data-quarto-table-cell-role="th">activity or mda</th>
<th data-quarto-table-cell-role="th">uncertainty</th>
<th data-quarto-table-cell-role="th">unit</th>
<th data-quarto-table-cell-role="th">data provider</th>
<th data-quarto-table-cell-role="th">measurement comment</th>
<th data-quarto-table-cell-role="th">sample comment</th>
<th data-quarto-table-cell-role="th">reference comment</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17531</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>&lt;</td>
<td>0.326416</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>DA 17531</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17534</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>&lt;</td>
<td>0.442704</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2</td>
<td>DA 17534</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17537</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>&lt;</td>
<td>0.412989</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3</td>
<td>DA 17537</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17540</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>&lt;</td>
<td>0.202768</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>4</td>
<td>DA 17540</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>5</td>
<td>Belgium</td>
<td>8</td>
<td>Kloosterzande-Schelde</td>
<td>DA 17531</td>
<td>51</td>
<td>23.0</td>
<td>36.0</td>
<td>N</td>
<td>4</td>
<td>...</td>
<td>&lt;</td>
<td>0.652833</td>
<td>NaN</td>
<td>Bq/kg f.w.</td>
<td>SCK•CEN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>5</td>
<td>DA 17531</td>
</tr>
</tbody>
</table>

<p>5 rows × 29 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="add-depth" class="level2">
<h2 class="anchored" data-anchor-id="add-depth">Add depth</h2>
<p>The OSPAR dataset features a <code>Sampling depth</code> column specifically for the <code>SEAWATER</code> dataset. In this section, we will develop a callback to integrate the sampling depth, denoted as <code>SMP_DEPTH</code>, into the MARIS dataset.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L505" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="adddepthcb" class="level3">
<h3 class="anchored" data-anchor-id="adddepthcb">AddDepthCB</h3>
<blockquote class="blockquote">
<pre><code> AddDepthCB ()</code></pre>
</blockquote>
<p><em>Ensure depth values are floats and add ‘SMP_DEPTH’ columns.</em></p>
<div id="1c1a7db8" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddDepthCB(Callback):</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Ensure depth values are floats and add 'SMP_DEPTH' columns."</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'SEAWATER'</span>:</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'sampling depth'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>                    df[<span class="st">'SMP_DEPTH'</span>] <span class="op">=</span> df[<span class="st">'sampling depth'</span>].astype(<span class="bu">float</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="af5764c3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    AddDepthCB()</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp <span class="kw">in</span> tfm.dfs.keys():  </span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'SMP_DEPTH'</span> <span class="kw">in</span> tfm.dfs[grp].columns:</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>grp<span class="sc">}</span><span class="ss">:'</span>, tfm.dfs[grp][[<span class="st">'SMP_DEPTH'</span>]].drop_duplicates())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">SEAWATER:        SMP_DEPTH
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">80</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">81</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">85</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">87</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32.0</span>
<span style="color: #808000; text-decoration-color: #808000">...</span>          <span style="color: #808000; text-decoration-color: #808000">...</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16022</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">71.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16023</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">66.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16025</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">81.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16385</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1660.0</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16389</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1500.0</span>

<span style="font-weight: bold">[</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">134</span> rows x <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span> columns<span style="font-weight: bold">]</span>
</pre>
</div>
</div>
</section>
</section>
<section id="standardize-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="standardize-coordinates">Standardize Coordinates</h2>
<p>The OSPAR dataset offers coordinates in degrees, minutes, and seconds (DMS). The following callback is designed to convert DMS to decimal degrees.</p>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/ospar.py#L448" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="convertlonlatcb" class="level3">
<h3 class="anchored" data-anchor-id="convertlonlatcb">ConvertLonLatCB</h3>
<blockquote class="blockquote">
<pre><code> ConvertLonLatCB ()</code></pre>
</blockquote>
<p><em>Convert Coordinates to decimal degrees (DDD.DDDDD°).</em></p>
<div id="94730c0b" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConvertLonLatCB(Callback):</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert Coordinates to decimal degrees (DDD.DDDDD°)."""</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: <span class="st">'Transformer'</span>):</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'LAT'</span>] <span class="op">=</span> <span class="va">self</span>._convert_latitude(df)</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'LON'</span>] <span class="op">=</span> <span class="va">self</span>._convert_longitude(df)</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _convert_latitude(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.where(</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'latdir'</span>].isin([<span class="st">'S'</span>]),</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._dms_to_decimal(df[<span class="st">'latd'</span>], df[<span class="st">'latm'</span>], df[<span class="st">'lats'</span>]) <span class="op">*</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._dms_to_decimal(df[<span class="st">'latd'</span>], df[<span class="st">'latm'</span>], df[<span class="st">'lats'</span>])</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _convert_longitude(<span class="va">self</span>, df: pd.DataFrame) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.where(</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'longdir'</span>].isin([<span class="st">'W'</span>]),</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._dms_to_decimal(df[<span class="st">'longd'</span>], df[<span class="st">'longm'</span>], df[<span class="st">'longs'</span>]) <span class="op">*</span> <span class="op">-</span><span class="dv">1</span>,</span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._dms_to_decimal(df[<span class="st">'longd'</span>], df[<span class="st">'longm'</span>], df[<span class="st">'longs'</span>])</span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _dms_to_decimal(<span class="va">self</span>, degrees: pd.Series, minutes: pd.Series, seconds: pd.Series) <span class="op">-&gt;</span> pd.Series:</span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> degrees <span class="op">+</span> minutes <span class="op">/</span> <span class="dv">60</span> <span class="op">+</span> seconds <span class="op">/</span> <span class="dv">3600</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="fb7900d6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    ConvertLonLatCB()</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'LAT'</span>,<span class="st">'latd'</span>, <span class="st">'latm'</span>, <span class="st">'lats'</span>, <span class="st">'LON'</span>, <span class="st">'latdir'</span>, <span class="st">'longd'</span>, <span class="st">'longm'</span>,<span class="st">'longs'</span>, <span class="st">'longdir'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">longm</th>
<th data-quarto-table-cell-role="th">longs</th>
<th data-quarto-table-cell-role="th">longdir</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>51.375278</td>
<td>51</td>
<td>22.0</td>
<td>31.0</td>
<td>3.188056</td>
<td>N</td>
<td>3</td>
<td>11.0</td>
<td>17.0</td>
<td>E</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.223611</td>
<td>51</td>
<td>13.0</td>
<td>25.0</td>
<td>2.859444</td>
<td>N</td>
<td>2</td>
<td>51.0</td>
<td>34.0</td>
<td>E</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.184444</td>
<td>51</td>
<td>11.0</td>
<td>4.0</td>
<td>2.713611</td>
<td>N</td>
<td>2</td>
<td>42.0</td>
<td>49.0</td>
<td>E</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>51.420278</td>
<td>51</td>
<td>25.0</td>
<td>13.0</td>
<td>3.262222</td>
<td>N</td>
<td>3</td>
<td>15.0</td>
<td>44.0</td>
<td>E</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>51.416111</td>
<td>51</td>
<td>24.0</td>
<td>58.0</td>
<td>2.809722</td>
<td>N</td>
<td>2</td>
<td>48.0</td>
<td>35.0</td>
<td>E</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19183</th>
<td>52.831944</td>
<td>52</td>
<td>49.0</td>
<td>55.0</td>
<td>4.615278</td>
<td>N</td>
<td>4</td>
<td>36.0</td>
<td>55.0</td>
<td>E</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19184</th>
<td>51.411944</td>
<td>51</td>
<td>24.0</td>
<td>43.0</td>
<td>3.565556</td>
<td>N</td>
<td>3</td>
<td>33.0</td>
<td>56.0</td>
<td>E</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19185</th>
<td>51.411944</td>
<td>51</td>
<td>24.0</td>
<td>43.0</td>
<td>3.565556</td>
<td>N</td>
<td>3</td>
<td>33.0</td>
<td>56.0</td>
<td>E</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19186</th>
<td>51.411944</td>
<td>51</td>
<td>24.0</td>
<td>43.0</td>
<td>3.565556</td>
<td>N</td>
<td>3</td>
<td>33.0</td>
<td>56.0</td>
<td>E</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19187</th>
<td>51.719444</td>
<td>51</td>
<td>43.0</td>
<td>10.0</td>
<td>3.493889</td>
<td>N</td>
<td>3</td>
<td>29.0</td>
<td>38.0</td>
<td>E</td>
</tr>
</tbody>
</table>

<p>19183 rows × 10 columns</p>
</div>
</div>
</div>
<p>Sanitize coordinates drops a row when both longitude &amp; latitude equal 0 or data contains unrealistic longitude &amp; latitude values. Converts longitude &amp; latitude <code>,</code> separator to <code>.</code> separator.”</p>
<div id="7b834378" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>                            ConvertLonLatCB(),</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>display(Markdown(<span class="st">"&lt;b&gt; Row Count Comparison Before and After Transformation:&lt;/b&gt;"</span>))</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="va">None</span>):</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>    display(pd.DataFrame.from_dict(tfm.compare_stats))</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_columns'</span>, <span class="va">None</span>):</span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    display(tfm.dfs[<span class="st">'SEAWATER'</span>][[<span class="st">'LAT'</span>,<span class="st">'LON'</span>]])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown">
<p><b> Row Count Comparison Before and After Transformation:</b></p>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">BIOTA</th>
<th data-quarto-table-cell-role="th">SEAWATER</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Original row count (dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Transformed row count (tfm.dfs)</th>
<td>15951</td>
<td>19193</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rows removed from original (tfm.dfs_removed)</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Rows created in transformed (tfm.dfs_created)</th>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">LON</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>51.375278</td>
<td>3.188056</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>51.223611</td>
<td>2.859444</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>51.184444</td>
<td>2.713611</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>51.420278</td>
<td>3.262222</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>51.416111</td>
<td>2.809722</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19188</th>
<td>53.600000</td>
<td>-5.933333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19189</th>
<td>53.733333</td>
<td>-5.416667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19190</th>
<td>53.650000</td>
<td>-5.233333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19191</th>
<td>53.883333</td>
<td>-5.550000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19192</th>
<td>53.866667</td>
<td>-5.883333</td>
</tr>
</tbody>
</table>

<p>19193 rows × 2 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="add-station" class="level2">
<h2 class="anchored" data-anchor-id="add-station">Add Station</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/helcom.py#L525" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="addstationcb" class="level3">
<h3 class="anchored" data-anchor-id="addstationcb">AddStationCB</h3>
<blockquote class="blockquote">
<pre><code> AddStationCB ()</code></pre>
</blockquote>
<p><em>Ensure station values are floats and add ‘STATION’ columns.</em></p>
<div id="67f0cde0" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddStationCB(Callback):</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Ensure station values are floats and add 'STATION' columns."</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, tfm: Transformer):</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> grp, df <span class="kw">in</span> tfm.dfs.items():</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'STATION'</span>] <span class="op">=</span> df[<span class="st">'station id'</span>].astype(<span class="bu">str</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
</section>
<section id="review-all-callbacks" class="level2">
<h2 class="anchored" data-anchor-id="review-all-callbacks">Review all callbacks</h2>
<div id="054b183b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>                            RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(),</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(renaming_unit_rules),</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>                            EnhanceSpeciesCB(),</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>                            AddBodypartTempCB(),</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_bodyparts, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'body_part_temp'</span> , dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>                            AddSampleIdCB(),</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),    </span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>                            ConvertLonLatCB(),</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>                            AddStationCB(),</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>                            CompareDfsAndTfmCB(dfs)</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame.from_dict(tfm.compare_stats) , <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 12/12 [00:00&lt;00:00, 55.39it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">                                               BIOTA  SEAWATER
Original row count <span style="font-weight: bold">(</span>dfs<span style="font-weight: bold">)</span>                       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15951</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19193</span>
Transformed row count <span style="font-weight: bold">(</span>tfm.dfs<span style="font-weight: bold">)</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15951</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19183</span>
Rows removed from original <span style="font-weight: bold">(</span>tfm.dfs_removed<span style="font-weight: bold">)</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>
Rows created in transformed <span style="font-weight: bold">(</span>tfm.dfs_created<span style="font-weight: bold">)</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span> 

</pre>
</div>
</div>
<div id="b3d14af4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tfm.dfs[<span class="st">'SEAWATER'</span>].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">contracting party</th>
<th data-quarto-table-cell-role="th">rsc sub-division</th>
<th data-quarto-table-cell-role="th">station id</th>
<th data-quarto-table-cell-role="th">sample id</th>
<th data-quarto-table-cell-role="th">latd</th>
<th data-quarto-table-cell-role="th">latm</th>
<th data-quarto-table-cell-role="th">lats</th>
<th data-quarto-table-cell-role="th">latdir</th>
<th data-quarto-table-cell-role="th">longd</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">DL</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">STATION</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>Belgium</td>
<td>8.0</td>
<td>Belgica-W01</td>
<td>WNZ 01</td>
<td>51</td>
<td>22.0</td>
<td>31.0</td>
<td>N</td>
<td>3</td>
<td>...</td>
<td>0.20</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>WNZ 01</td>
<td>3.0</td>
<td>51.375278</td>
<td>3.188056</td>
<td>Belgica-W01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>Belgium</td>
<td>8.0</td>
<td>Belgica-W02</td>
<td>WNZ 02</td>
<td>51</td>
<td>13.0</td>
<td>25.0</td>
<td>N</td>
<td>2</td>
<td>...</td>
<td>0.27</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>WNZ 02</td>
<td>3.0</td>
<td>51.223611</td>
<td>2.859444</td>
<td>Belgica-W02</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>Belgium</td>
<td>8.0</td>
<td>Belgica-W03</td>
<td>WNZ 03</td>
<td>51</td>
<td>11.0</td>
<td>4.0</td>
<td>N</td>
<td>2</td>
<td>...</td>
<td>0.26</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>WNZ 03</td>
<td>3.0</td>
<td>51.184444</td>
<td>2.713611</td>
<td>Belgica-W03</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>Belgium</td>
<td>8.0</td>
<td>Belgica-W04</td>
<td>WNZ 04</td>
<td>51</td>
<td>25.0</td>
<td>13.0</td>
<td>N</td>
<td>3</td>
<td>...</td>
<td>0.25</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>4</td>
<td>WNZ 04</td>
<td>3.0</td>
<td>51.420278</td>
<td>3.262222</td>
<td>Belgica-W04</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>5</td>
<td>Belgium</td>
<td>8.0</td>
<td>Belgica-W05</td>
<td>WNZ 05</td>
<td>51</td>
<td>24.0</td>
<td>58.0</td>
<td>N</td>
<td>2</td>
<td>...</td>
<td>0.20</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>5</td>
<td>WNZ 05</td>
<td>3.0</td>
<td>51.416111</td>
<td>2.809722</td>
<td>Belgica-W05</td>
</tr>
</tbody>
</table>

<p>5 rows × 37 columns</p>
</div>
</div>
</div>
<section id="example-change-logs" class="level3">
<h3 class="anchored" data-anchor-id="example-change-logs">Example change logs</h3>
<p>Review the change logs for the netcdf encoding.</p>
<div id="5c5a311c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>                            RemoveAllNAValuesCB(nan_cols_to_check), </span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(),</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(renaming_unit_rules),</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>                            EnhanceSpeciesCB(),</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>                            AddBodypartTempCB(),</span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_bodyparts, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'body_part_temp'</span> , dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>                            AddSampleIdCB(),</span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),    </span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>                            ConvertLonLatCB(),</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>                            AddStationCB(),</span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>                            ])</span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Transform</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>tfm()</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Check transformation logs</span></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>tfm.logs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 12/12 [00:00&lt;00:00, 56.55it/s]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>['Remove rows with all NA values in specified columns.',
 "Convert 'nuclide' column values to lowercase, strip spaces, and store in 'nuclide' column.",
 'Remap data provider nuclide names to standardized MARIS nuclide names.',
 'Parse the time format in the dataframe and check for inconsistencies.',
 'Encode time as seconds since epoch.',
 'Sanitize value by removing blank entries and populating `value` column.',
 'Normalize uncertainty values in DataFrames.',
 "Callback to update DataFrame 'UNIT' columns based on a lookup table.",
 'Remap detection limit values to MARIS format using a lookup table.',
 "Remap values from 'species' to 'SPECIES' for groups: BIOTA.",
 "Remap values from 'biological group' to 'enhanced_species' for groups: BIOTA.",
 "Enhance the 'SPECIES' column using the 'enhanced_species' column if conditions are met.",
 'Add a temporary column with the body part and biological group combined.',
 "Remap values from 'body_part_temp' to 'BODY_PART' for groups: BIOTA.",
 'Create incremental SMP_ID and store original sample id in SMP_ID_PROVIDER',
 "Ensure depth values are floats and add 'SMP_DEPTH' columns.",
 'Convert Coordinates to decimal degrees (DDD.DDDDD°).',
 'Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator.',
 "Ensure station values are floats and add 'STATION' columns."]</code></pre>
</div>
</div>
</section>
</section>
<section id="feed-global-attributes" class="level2">
<h2 class="anchored" data-anchor-id="feed-global-attributes">Feed global attributes</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L269" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="get_attrs" class="level3">
<h3 class="anchored" data-anchor-id="get_attrs">get_attrs</h3>
<blockquote class="blockquote">
<pre><code> get_attrs (tfm:marisco.callbacks.Transformer, zotero_key:str,
            kw:list=['oceanography', 'Earth Science &gt; Oceans &gt; Ocean
            Chemistry&gt; Radionuclides', 'Earth Science &gt; Human Dimensions &gt;
            Environmental Impacts &gt; Nuclear Radiation Exposure', 'Earth
            Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth
            Science &gt; Oceans &gt; Marine Sediments', 'Earth Science &gt; Oceans
            &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt;
            Isotopes', 'Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean
            Contaminants', 'Earth Science &gt; Biological Classification &gt;
            Animals/Vertebrates &gt; Fish', 'Earth Science &gt; Biosphere &gt;
            Ecosystems &gt; Marine Ecosystems', 'Earth Science &gt; Biological
            Classification &gt; Animals/Invertebrates &gt; Mollusks', 'Earth
            Science &gt; Biological Classification &gt; Animals/Invertebrates &gt;
            Arthropods &gt; Crustaceans', 'Earth Science &gt; Biological
            Classification &gt; Plants &gt; Macroalgae (Seaweeds)'])</code></pre>
</blockquote>
<p><em>Retrieve all global attributes.</em></p>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>tfm</td>
<td>Transformer</td>
<td></td>
<td>Transformer object</td>
</tr>
<tr class="even">
<td>zotero_key</td>
<td>str</td>
<td></td>
<td>Zotero dataset record key</td>
</tr>
<tr class="odd">
<td>kw</td>
<td>list</td>
<td>[‘oceanography’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides’, ‘Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments’, ‘Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes’, ‘Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants’, ‘Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish’, ‘Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems’, ‘Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks’, ‘Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans’, ‘Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)’]</td>
<td>List of keywords</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>dict</strong></td>
<td></td>
<td><strong>Global attributes</strong></td>
</tr>
</tbody>
</table>
<div id="c42cfdf0" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>kw <span class="op">=</span> [<span class="st">'oceanography'</span>, <span class="st">'Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides'</span>,</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure'</span>,</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments'</span>,</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes'</span>,</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants'</span>,</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish'</span>,</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems'</span>,</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks'</span>,</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans'</span>,</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">'Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="d7519752" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_attrs(</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>    tfm: Transformer, <span class="co"># Transformer object</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    zotero_key: <span class="bu">str</span>, <span class="co"># Zotero dataset record key</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    kw: <span class="bu">list</span> <span class="op">=</span> kw <span class="co"># List of keywords</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="bu">dict</span>: <span class="co"># Global attributes</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Retrieve all global attributes."</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> GlobAttrsFeeder(tfm.dfs, cbs<span class="op">=</span>[</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>        BboxCB(),</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>        DepthRangeCB(),</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>        TimeRangeCB(),</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>        ZoteroCB(zotero_key, cfg<span class="op">=</span>cfg()),</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>        KeyValuePairCB(<span class="st">'keywords'</span>, <span class="st">', '</span>.join(kw)),</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>        KeyValuePairCB(<span class="st">'publisher_postprocess_logs'</span>, <span class="st">', '</span>.join(tfm.logs))</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>        ])()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="2ed59598" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>get_attrs(tfm, zotero_key<span class="op">=</span>zotero_key, kw<span class="op">=</span>kw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'geospatial_lat_min': '49.43222222222222',
 'geospatial_lat_max': '81.26805555555555',
 'geospatial_lon_min': '-58.23166666666667',
 'geospatial_lon_max': '36.181666666666665',
 'geospatial_bounds': 'POLYGON ((-58.23166666666667 36.181666666666665, 49.43222222222222 36.181666666666665, 49.43222222222222 81.26805555555555, -58.23166666666667 81.26805555555555, -58.23166666666667 36.181666666666665))',
 'geospatial_vertical_max': '1850.0',
 'geospatial_vertical_min': '0.0',
 'time_coverage_start': '1995-01-01T00:00:00',
 'time_coverage_end': '2022-12-31T00:00:00',
 'id': 'LQRA4MMK',
 'title': 'OSPAR Environmental Monitoring of Radioactive Substances',
 'summary': '',
 'creator_name': '[{"creatorType": "author", "firstName": "", "lastName": "OSPAR Comission\'s Radioactive Substances Committee (RSC)"}]',
 'keywords': 'oceanography, Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides, Earth Science &gt; Human Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure, Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean Tracers, Earth Science &gt; Oceans &gt; Marine Sediments, Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; Oceans &gt; Sea Ice &gt; Isotopes, Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants, Earth Science &gt; Biological Classification &gt; Animals/Vertebrates &gt; Fish, Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks, Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans, Earth Science &gt; Biological Classification &gt; Plants &gt; Macroalgae (Seaweeds)',
 'publisher_postprocess_logs': "Remove rows with all NA values in specified columns., Convert 'nuclide' column values to lowercase, strip spaces, and store in 'nuclide' column., Remap data provider nuclide names to standardized MARIS nuclide names., Parse the time format in the dataframe and check for inconsistencies., Encode time as seconds since epoch., Sanitize value by removing blank entries and populating `value` column., Normalize uncertainty values in DataFrames., Callback to update DataFrame 'UNIT' columns based on a lookup table., Remap detection limit values to MARIS format using a lookup table., Remap values from 'species' to 'SPECIES' for groups: BIOTA., Remap values from 'biological group' to 'enhanced_species' for groups: BIOTA., Enhance the 'SPECIES' column using the 'enhanced_species' column if conditions are met., Add a temporary column with the body part and biological group combined., Remap values from 'body_part_temp' to 'BODY_PART' for groups: BIOTA., Create incremental SMP_ID and store original sample id in SMP_ID_PROVIDER, Ensure depth values are floats and add 'SMP_DEPTH' columns., Convert Coordinates to decimal degrees (DDD.DDDDD°)., Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator., Ensure station values are floats and add 'STATION' columns."}</code></pre>
</div>
</div>
</section>
</section>
<section id="encoding-netcdf" class="level2">
<h2 class="anchored" data-anchor-id="encoding-netcdf">Encoding NETCDF</h2>
<hr>
<p><a href="https://github.com/franckalbinet/marisco/blob/main/marisco/handlers/geotraces.py#L281" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="encode" class="level3">
<h3 class="anchored" data-anchor-id="encode">encode</h3>
<blockquote class="blockquote">
<pre><code> encode (fname_out:str, **kwargs)</code></pre>
</blockquote>
<p><em>Encode data to NetCDF.</em></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fname_out</td>
<td>str</td>
<td>Output file name</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td><strong>Additional arguments</strong></td>
</tr>
</tbody>
</table>
<div id="612c763a" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> encode(</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>    fname_out: <span class="bu">str</span>, <span class="co"># Output file name</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>kwargs <span class="co"># Additional arguments</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Encode data to NetCDF."</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    dfs <span class="op">=</span> load_data(src_dir, use_cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    tfm <span class="op">=</span> Transformer(dfs, cbs<span class="op">=</span>[</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>                            RemoveAllNAValuesCB(nan_cols_to_check),</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>                            LowerStripNameCB(col_src<span class="op">=</span><span class="st">'nuclide'</span>, col_dst<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>                            RemapNuclideNameCB(lut_nuclides, col_name<span class="op">=</span><span class="st">'nuclide'</span>),</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>                            ParseTimeCB(),</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>                            EncodeTimeCB(),</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>                            SanitizeValueCB(),</span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>                            NormalizeUncCB(),</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>                            RemapUnitCB(renaming_unit_rules),</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>                            RemapDetectionLimitCB(coi_dl, lut_dl),</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota, col_remap<span class="op">=</span><span class="st">'SPECIES'</span>, col_src<span class="op">=</span><span class="st">'species'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_biota_enhanced, col_remap<span class="op">=</span><span class="st">'enhanced_species'</span>, col_src<span class="op">=</span><span class="st">'biological group'</span>, dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),    </span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>                            EnhanceSpeciesCB(),</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>                            AddBodypartTempCB(),</span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>                            RemapCB(fn_lut<span class="op">=</span>lut_bodyparts, col_remap<span class="op">=</span><span class="st">'BODY_PART'</span>, col_src<span class="op">=</span><span class="st">'body_part_temp'</span> , dest_grps<span class="op">=</span><span class="st">'BIOTA'</span>),</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>                            AddSampleIdCB(),</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>                            AddDepthCB(),    </span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>                            ConvertLonLatCB(),</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>                            SanitizeLonLatCB(),</span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>                            AddStationCB()</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>                                ])</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>    tfm()</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> NetCDFEncoder(tfm.dfs, </span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>                            dest_fname<span class="op">=</span>fname_out, </span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>                            global_attrs<span class="op">=</span>get_attrs(tfm, zotero_key<span class="op">=</span>zotero_key, kw<span class="op">=</span>kw),</span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>                            verbose<span class="op">=</span>kwargs.get(<span class="st">'verbose'</span>, <span class="va">False</span>),</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>                           )</span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>    encoder.encode()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="183e358b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>encode(fname_out, verbose<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processing: 100%|██████████| 12/12 [00:00&lt;00:00, 38.63it/s]</code></pre>
</div>
</div>
</section>
</section>
<section id="netcdf-review" class="level2">
<h2 class="anchored" data-anchor-id="netcdf-review">NetCDF Review</h2>
<p>First lets review the global attributes of the NetCDF file:</p>
<div id="7a93dccd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>contents <span class="op">=</span> ExtractNetcdfContents(fname_out)</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents.global_attrs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'id'</span>: <span style="color: #008000; text-decoration-color: #008000">'LQRA4MMK'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'title'</span>: <span style="color: #008000; text-decoration-color: #008000">'OSPAR Environmental Monitoring of Radioactive Substances'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'summary'</span>: <span style="color: #008000; text-decoration-color: #008000">''</span>,
    <span style="color: #008000; text-decoration-color: #008000">'keywords'</span>: <span style="color: #008000; text-decoration-color: #008000">'oceanography, Earth Science &gt; Oceans &gt; Ocean Chemistry&gt; Radionuclides, Earth Science &gt; Human </span>
<span style="color: #008000; text-decoration-color: #008000">Dimensions &gt; Environmental Impacts &gt; Nuclear Radiation Exposure, Earth Science &gt; Oceans &gt; Ocean Chemistry &gt; Ocean </span>
<span style="color: #008000; text-decoration-color: #008000">Tracers, Earth Science &gt; Oceans &gt; Marine Sediments, Earth Science &gt; Oceans &gt; Ocean Chemistry, Earth Science &gt; </span>
<span style="color: #008000; text-decoration-color: #008000">Oceans &gt; Sea Ice &gt; Isotopes, Earth Science &gt; Oceans &gt; Water Quality &gt; Ocean Contaminants, Earth Science &gt; </span>
<span style="color: #008000; text-decoration-color: #008000">Biological Classification &gt; Animals/Vertebrates &gt; Fish, Earth Science &gt; Biosphere &gt; Ecosystems &gt; Marine Ecosystems,</span>
<span style="color: #008000; text-decoration-color: #008000">Earth Science &gt; Biological Classification &gt; Animals/Invertebrates &gt; Mollusks, Earth Science &gt; Biological </span>
<span style="color: #008000; text-decoration-color: #008000">Classification &gt; Animals/Invertebrates &gt; Arthropods &gt; Crustaceans, Earth Science &gt; Biological Classification &gt; </span>
<span style="color: #008000; text-decoration-color: #008000">Plants &gt; Macroalgae (Seaweeds)'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'history'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'keywords_vocabulary'</span>: <span style="color: #008000; text-decoration-color: #008000">'GCMD Science Keywords'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'keywords_vocabulary_url'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://gcmd.earthdata.nasa.gov/static/kms/'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'record'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'featureType'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'cdm_data_type'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'Conventions'</span>: <span style="color: #008000; text-decoration-color: #008000">'CF-1.10 ACDD-1.3'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher_name'</span>: <span style="color: #008000; text-decoration-color: #008000">'Paul MCGINNITY, Iolanda OSVATH, Florence DESCROIX-COMANDUCCI'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher_email'</span>: <span style="color: #008000; text-decoration-color: #008000">'p.mc-ginnity@iaea.org, i.osvath@iaea.org, F.Descroix-Comanducci@iaea.org'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher_url'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://maris.iaea.org'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher_institution'</span>: <span style="color: #008000; text-decoration-color: #008000">'International Atomic Energy Agency - IAEA'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'creator_name'</span>: <span style="color: #008000; text-decoration-color: #008000">'[{"creatorType": "author", "firstName": "", "lastName": "OSPAR Comission\'s Radioactive </span>
<span style="color: #008000; text-decoration-color: #008000">Substances Committee (RSC)"}]'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'institution'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'metadata_link'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'creator_email'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'creator_url'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'references'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'license'</span>: <span style="color: #008000; text-decoration-color: #008000">'Without prejudice to the applicable Terms and Conditions </span>
<span style="color: #008000; text-decoration-color: #008000">(https://nucleus.iaea.org/Pages/Others/Disclaimer.aspx), I hereby agree that any use of the data will contain </span>
<span style="color: #008000; text-decoration-color: #008000">appropriate acknowledgement of the data source(s) and the IAEA Marine Radioactivity Information System (MARIS).'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'comment'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_lat_min'</span>: <span style="color: #008000; text-decoration-color: #008000">'49.43222222222222'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_lon_min'</span>: <span style="color: #008000; text-decoration-color: #008000">'-58.23166666666667'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_lat_max'</span>: <span style="color: #008000; text-decoration-color: #008000">'81.26805555555555'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_lon_max'</span>: <span style="color: #008000; text-decoration-color: #008000">'36.181666666666665'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_vertical_min'</span>: <span style="color: #008000; text-decoration-color: #008000">'0.0'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_vertical_max'</span>: <span style="color: #008000; text-decoration-color: #008000">'1850.0'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_bounds'</span>: <span style="color: #008000; text-decoration-color: #008000">'POLYGON ((-58.23166666666667 36.181666666666665, 49.43222222222222 36.181666666666665, </span>
<span style="color: #008000; text-decoration-color: #008000">49.43222222222222 81.26805555555555, -58.23166666666667 81.26805555555555, -58.23166666666667 </span>
<span style="color: #008000; text-decoration-color: #008000">36.181666666666665))'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'geospatial_bounds_crs'</span>: <span style="color: #008000; text-decoration-color: #008000">'EPSG:4326'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'time_coverage_start'</span>: <span style="color: #008000; text-decoration-color: #008000">'1995-01-01T00:00:00'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'time_coverage_end'</span>: <span style="color: #008000; text-decoration-color: #008000">'2022-12-31T00:00:00'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'local_time_zone'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'date_created'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'date_modified'</span>: <span style="color: #008000; text-decoration-color: #008000">'TBD'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher_postprocess_logs'</span>: <span style="color: #008000; text-decoration-color: #008000">"Remove rows with all NA values in specified columns., Convert 'nuclide' column </span>
<span style="color: #008000; text-decoration-color: #008000">values to lowercase, strip spaces, and store in 'nuclide' column., Remap data provider nuclide names to </span>
<span style="color: #008000; text-decoration-color: #008000">standardized MARIS nuclide names., Parse the time format in the dataframe and check for inconsistencies., Encode </span>
<span style="color: #008000; text-decoration-color: #008000">time as seconds since epoch., Sanitize value by removing blank entries and populating `value` column., Normalize </span>
<span style="color: #008000; text-decoration-color: #008000">uncertainty values in DataFrames., Callback to update DataFrame 'UNIT' columns based on a lookup table., Remap </span>
<span style="color: #008000; text-decoration-color: #008000">detection limit values to MARIS format using a lookup table., Remap values from 'species' to 'SPECIES' for groups: </span>
<span style="color: #008000; text-decoration-color: #008000">BIOTA., Remap values from 'biological group' to 'enhanced_species' for groups: BIOTA., Enhance the 'SPECIES' column</span>
<span style="color: #008000; text-decoration-color: #008000">using the 'enhanced_species' column if conditions are met., Add a temporary column with the body part and </span>
<span style="color: #008000; text-decoration-color: #008000">biological group combined., Remap values from 'body_part_temp' to 'BODY_PART' for groups: BIOTA., Create </span>
<span style="color: #008000; text-decoration-color: #008000">incremental SMP_ID and store original sample id in SMP_ID_PROVIDER, Ensure depth values are floats and add </span>
<span style="color: #008000; text-decoration-color: #008000">'SMP_DEPTH' columns., Convert Coordinates to decimal degrees (DDD.DDDDD°)., Drop rows with invalid longitude &amp; </span>
<span style="color: #008000; text-decoration-color: #008000">latitude values. Convert `,` separator to `.` separator., Ensure station values are floats and add 'STATION' </span>
<span style="color: #008000; text-decoration-color: #008000">columns."</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>Review the publisher_postprocess_logs.</p>
<div id="64910a7e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents.global_attrs[<span class="st">'publisher_postprocess_logs'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Remove rows with all NA values in specified columns., Convert <span style="color: #008000; text-decoration-color: #008000">'nuclide'</span> column values to lowercase, strip spaces, 
and store in <span style="color: #008000; text-decoration-color: #008000">'nuclide'</span> column., Remap data provider nuclide names to standardized MARIS nuclide names., Parse the 
time format in the dataframe and check for inconsistencies., Encode time as seconds since epoch., Sanitize value by
removing blank entries and populating `value` column., Normalize uncertainty values in DataFrames., Callback to 
update DataFrame <span style="color: #008000; text-decoration-color: #008000">'UNIT'</span> columns based on a lookup table., Remap detection limit values to MARIS format using a 
lookup table., Remap values from <span style="color: #008000; text-decoration-color: #008000">'species'</span> to <span style="color: #008000; text-decoration-color: #008000">'SPECIES'</span> for groups: BIOTA., Remap values from <span style="color: #008000; text-decoration-color: #008000">'biological group'</span> to
<span style="color: #008000; text-decoration-color: #008000">'enhanced_species'</span> for groups: BIOTA., Enhance the <span style="color: #008000; text-decoration-color: #008000">'SPECIES'</span> column using the <span style="color: #008000; text-decoration-color: #008000">'enhanced_species'</span> column if 
conditions are met., Add a temporary column with the body part and biological group combined., Remap values from 
<span style="color: #008000; text-decoration-color: #008000">'body_part_temp'</span> to <span style="color: #008000; text-decoration-color: #008000">'BODY_PART'</span> for groups: BIOTA., Create incremental SMP_ID and store original sample id in 
SMP_ID_PROVIDER, Ensure depth values are floats and add <span style="color: #008000; text-decoration-color: #008000">'SMP_DEPTH'</span> columns., Convert Coordinates to decimal 
degrees <span style="font-weight: bold">(</span>DDD.DDDDD°<span style="font-weight: bold">)</span>., Drop rows with invalid longitude &amp; latitude values. Convert `,` separator to `.` separator.,
Ensure station values are floats and add <span style="color: #008000; text-decoration-color: #008000">'STATION'</span> columns.
</pre>
</div>
</div>
<p>Lets review the data of the NetCDF file:</p>
<div id="d5f8cf21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> contents.dfs</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>dfs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'BIOTA':       SMP_ID_PROVIDER        LON        LAT        TIME  \
 0            DA 17531   4.031111  51.393333  1267574400   
 1            DA 17534   4.031111  51.393333  1276473600   
 2            DA 17537   4.031111  51.393333  1285545600   
 3            DA 17540   4.031111  51.393333  1291766400   
 4            DA 17531   4.031111  51.393333  1267574400   
 ...               ...        ...        ...         ...   
 15946             nan  12.087778  57.252499  1660003200   
 15947             nan  12.107500  57.306389  1663891200   
 15948             nan  11.245000  58.603333  1667779200   
 15949             nan  11.905278  57.302502  1663632000   
 15950             nan  12.076667  57.335278  1662076800   
 
                      STATION  SMP_ID  NUCLIDE     VALUE  UNIT       UNC  DL  \
 0      Kloosterzande-Schelde       1       33  0.326416     5       NaN   2   
 1      Kloosterzande-Schelde       2       33  0.442704     5       NaN   2   
 2      Kloosterzande-Schelde       3       33  0.412989     5       NaN   2   
 3      Kloosterzande-Schelde       4       33  0.202768     5       NaN   2   
 4      Kloosterzande-Schelde       5       53  0.652833     5       NaN   2   
 ...                      ...     ...      ...       ...   ...       ...  ..   
 15946         Ringhals (R22)   15947       33  0.384000     5  0.012096   1   
 15947         Ringhals (R23)   15948       33  0.456000     5  0.012084   1   
 15948                    SW7   15949       33  0.122000     5  0.031000   1   
 15949                   SW6a   15950       33  0.310000     5       NaN   2   
 15950         Ringhals (R25)   15951       33  0.306000     5  0.007191   1   
 
        SPECIES  BODY_PART  
 0          377          1  
 1          377          1  
 2          377          1  
 3          377          1  
 4          377          1  
 ...        ...        ...  
 15946      272         52  
 15947      272         52  
 15948      129         19  
 15949      129         19  
 15950       96         40  
 
 [15951 rows x 13 columns],
 'SEAWATER':       SMP_ID_PROVIDER       LON        LAT  SMP_DEPTH        TIME  \
 0              WNZ 01  3.188056  51.375278        3.0  1264550400   
 1              WNZ 02  2.859444  51.223610        3.0  1264550400   
 2              WNZ 03  2.713611  51.184444        3.0  1264550400   
 3              WNZ 04  3.262222  51.420277        3.0  1264550400   
 4              WNZ 05  2.809722  51.416111        3.0  1264464000   
 ...               ...       ...        ...        ...         ...   
 19178      2019010074  4.615278  52.831944        1.0  1573649640   
 19179      2019010420  3.565556  51.411945        1.0  1575977820   
 19180      2019010420  3.565556  51.411945        1.0  1575977820   
 19181      2019010420  3.565556  51.411945        1.0  1575977820   
 19182      2019010526  3.493889  51.719444        1.0  1576680180   
 
             STATION  SMP_ID  NUCLIDE     VALUE  UNIT           UNC  DL  
 0       Belgica-W01       1       33  0.200000     1           NaN   2  
 1       Belgica-W02       2       33  0.270000     1           NaN   2  
 2       Belgica-W03       3       33  0.260000     1           NaN   2  
 3       Belgica-W04       4       33  0.250000     1           NaN   2  
 4       Belgica-W05       5       33  0.200000     1           NaN   2  
 ...             ...     ...      ...       ...   ...           ...  ..  
 19178         PETT5   19179       77  0.000005     1  2.600000e-07   1  
 19179  VLISSGBISSVH   19180        1  6.152000     1  3.076000e-01   1  
 19180  VLISSGBISSVH   19181       53  0.005390     1  1.078000e-03   1  
 19181  VLISSGBISSVH   19182       54  0.001420     1  2.840000e-04   1  
 19182     SCHOUWN10   19183        1  6.078000     1  3.039000e-01   1  
 
 [19183 rows x 12 columns]}</code></pre>
</div>
</div>
<p>Lets review the biota data:</p>
<div id="fe575f49" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>nc_dfs_biota <span class="op">=</span> dfs[<span class="st">'BIOTA'</span>]</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>nc_dfs_biota</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">TIME</th>
<th data-quarto-table-cell-role="th">STATION</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">NUCLIDE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">DL</th>
<th data-quarto-table-cell-role="th">SPECIES</th>
<th data-quarto-table-cell-role="th">BODY_PART</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>DA 17531</td>
<td>4.031111</td>
<td>51.393333</td>
<td>1267574400</td>
<td>Kloosterzande-Schelde</td>
<td>1</td>
<td>33</td>
<td>0.326416</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>DA 17534</td>
<td>4.031111</td>
<td>51.393333</td>
<td>1276473600</td>
<td>Kloosterzande-Schelde</td>
<td>2</td>
<td>33</td>
<td>0.442704</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>DA 17537</td>
<td>4.031111</td>
<td>51.393333</td>
<td>1285545600</td>
<td>Kloosterzande-Schelde</td>
<td>3</td>
<td>33</td>
<td>0.412989</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>DA 17540</td>
<td>4.031111</td>
<td>51.393333</td>
<td>1291766400</td>
<td>Kloosterzande-Schelde</td>
<td>4</td>
<td>33</td>
<td>0.202768</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>DA 17531</td>
<td>4.031111</td>
<td>51.393333</td>
<td>1267574400</td>
<td>Kloosterzande-Schelde</td>
<td>5</td>
<td>53</td>
<td>0.652833</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15946</th>
<td>nan</td>
<td>12.087778</td>
<td>57.252499</td>
<td>1660003200</td>
<td>Ringhals (R22)</td>
<td>15947</td>
<td>33</td>
<td>0.384000</td>
<td>5</td>
<td>0.012096</td>
<td>1</td>
<td>272</td>
<td>52</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15947</th>
<td>nan</td>
<td>12.107500</td>
<td>57.306389</td>
<td>1663891200</td>
<td>Ringhals (R23)</td>
<td>15948</td>
<td>33</td>
<td>0.456000</td>
<td>5</td>
<td>0.012084</td>
<td>1</td>
<td>272</td>
<td>52</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15948</th>
<td>nan</td>
<td>11.245000</td>
<td>58.603333</td>
<td>1667779200</td>
<td>SW7</td>
<td>15949</td>
<td>33</td>
<td>0.122000</td>
<td>5</td>
<td>0.031000</td>
<td>1</td>
<td>129</td>
<td>19</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15949</th>
<td>nan</td>
<td>11.905278</td>
<td>57.302502</td>
<td>1663632000</td>
<td>SW6a</td>
<td>15950</td>
<td>33</td>
<td>0.310000</td>
<td>5</td>
<td>NaN</td>
<td>2</td>
<td>129</td>
<td>19</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15950</th>
<td>nan</td>
<td>12.076667</td>
<td>57.335278</td>
<td>1662076800</td>
<td>Ringhals (R25)</td>
<td>15951</td>
<td>33</td>
<td>0.306000</td>
<td>5</td>
<td>0.007191</td>
<td>1</td>
<td>96</td>
<td>40</td>
</tr>
</tbody>
</table>

<p>15951 rows × 13 columns</p>
</div>
</div>
</div>
<p>Lets review the seawater data:</p>
<div id="bed211a2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>nc_dfs_seawater <span class="op">=</span> dfs[<span class="st">'SEAWATER'</span>]</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>nc_dfs_seawater</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">SMP_ID_PROVIDER</th>
<th data-quarto-table-cell-role="th">LON</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">SMP_DEPTH</th>
<th data-quarto-table-cell-role="th">TIME</th>
<th data-quarto-table-cell-role="th">STATION</th>
<th data-quarto-table-cell-role="th">SMP_ID</th>
<th data-quarto-table-cell-role="th">NUCLIDE</th>
<th data-quarto-table-cell-role="th">VALUE</th>
<th data-quarto-table-cell-role="th">UNIT</th>
<th data-quarto-table-cell-role="th">UNC</th>
<th data-quarto-table-cell-role="th">DL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>WNZ 01</td>
<td>3.188056</td>
<td>51.375278</td>
<td>3.0</td>
<td>1264550400</td>
<td>Belgica-W01</td>
<td>1</td>
<td>33</td>
<td>0.200000</td>
<td>1</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>WNZ 02</td>
<td>2.859444</td>
<td>51.223610</td>
<td>3.0</td>
<td>1264550400</td>
<td>Belgica-W02</td>
<td>2</td>
<td>33</td>
<td>0.270000</td>
<td>1</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>WNZ 03</td>
<td>2.713611</td>
<td>51.184444</td>
<td>3.0</td>
<td>1264550400</td>
<td>Belgica-W03</td>
<td>3</td>
<td>33</td>
<td>0.260000</td>
<td>1</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>WNZ 04</td>
<td>3.262222</td>
<td>51.420277</td>
<td>3.0</td>
<td>1264550400</td>
<td>Belgica-W04</td>
<td>4</td>
<td>33</td>
<td>0.250000</td>
<td>1</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>WNZ 05</td>
<td>2.809722</td>
<td>51.416111</td>
<td>3.0</td>
<td>1264464000</td>
<td>Belgica-W05</td>
<td>5</td>
<td>33</td>
<td>0.200000</td>
<td>1</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19178</th>
<td>2019010074</td>
<td>4.615278</td>
<td>52.831944</td>
<td>1.0</td>
<td>1573649640</td>
<td>PETT5</td>
<td>19179</td>
<td>77</td>
<td>0.000005</td>
<td>1</td>
<td>2.600000e-07</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19179</th>
<td>2019010420</td>
<td>3.565556</td>
<td>51.411945</td>
<td>1.0</td>
<td>1575977820</td>
<td>VLISSGBISSVH</td>
<td>19180</td>
<td>1</td>
<td>6.152000</td>
<td>1</td>
<td>3.076000e-01</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19180</th>
<td>2019010420</td>
<td>3.565556</td>
<td>51.411945</td>
<td>1.0</td>
<td>1575977820</td>
<td>VLISSGBISSVH</td>
<td>19181</td>
<td>53</td>
<td>0.005390</td>
<td>1</td>
<td>1.078000e-03</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19181</th>
<td>2019010420</td>
<td>3.565556</td>
<td>51.411945</td>
<td>1.0</td>
<td>1575977820</td>
<td>VLISSGBISSVH</td>
<td>19182</td>
<td>54</td>
<td>0.001420</td>
<td>1</td>
<td>2.840000e-04</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19182</th>
<td>2019010526</td>
<td>3.493889</td>
<td>51.719444</td>
<td>1.0</td>
<td>1576680180</td>
<td>SCHOUWN10</td>
<td>19183</td>
<td>1</td>
<td>6.078000</td>
<td>1</td>
<td>3.039000e-01</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>19183 rows × 12 columns</p>
</div>
</div>
</div>
</section>
<section id="data-format-conversion" class="level2">
<h2 class="anchored" data-anchor-id="data-format-conversion">Data Format Conversion</h2>
<p>The MARIS data processing workflow involves two key steps:</p>
<ol type="1">
<li><strong>NetCDF to Standardized CSV Compatible with OpenRefine Pipeline</strong>
<ul>
<li>Convert standardized NetCDF files to CSV formats compatible with OpenRefine using the <a href="https://franckalbinet.github.io/marisco/api/decoders.html#netcdfdecoder"><code>NetCDFDecoder</code></a>.</li>
<li>Preserve data integrity and variable relationships.</li>
<li>Maintain standardized nomenclature and units.</li>
</ul></li>
<li><strong>Database Integration</strong>
<ul>
<li>Process the converted CSV files using OpenRefine.</li>
<li>Apply data cleaning and standardization rules.</li>
<li>Export validated data to the MARIS master database.</li>
</ul></li>
</ol>
<p>This section focuses on the first step: converting NetCDF files to a format suitable for OpenRefine processing using the <a href="https://franckalbinet.github.io/marisco/api/decoders.html#netcdfdecoder"><code>NetCDFDecoder</code></a> class.</p>
<div id="a7360798" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>decode(fname_in<span class="op">=</span>fname_out, verbose<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved BIOTA to ../../_data/output/191-OSPAR-2024_BIOTA.csv
Saved SEAWATER to ../../_data/output/191-OSPAR-2024_SEAWATER.csv</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/franckalbinet\.github\.io\/marisco");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/franckalbinet/marisco/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>